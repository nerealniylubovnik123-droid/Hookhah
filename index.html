<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#020617" />
  <title>Hookah Mixes – Single File (Vanilla JS)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{background:#020617}</style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // РАННИЙ обработчик: дружелюбный экран вместо «чёрного»
    (function(){
      function showFatal(msg){
        var root = document.getElementById('root');
        if (!root) return;
        root.innerHTML = (
          '<div class="min-h-[100svh] flex items-center justify-center p-6">\n' +
          '  <div class="max-w-md w-full rounded-xl border border-rose-800 bg-rose-950 p-4 text-sm">\n' +
          '    <div class="font-bold mb-2 text-rose-200">Произошла ошибка</div>\n' +
          '    <div class="text-rose-100/90 whitespace-pre-wrap break-words">' + String(msg || 'Unknown error') + '</div>\n' +
          '  </div>\n' +
          '</div>'
        );
      }
      window.addEventListener('error', function(e){
        var m = (e && (e.message || (e.error && e.error.message))) || 'Script error';
        showFatal(m);
      });
      window.addEventListener('unhandledrejection', function(e){
        var m = (e && (e.reason && (e.reason.message || e.reason))) || 'Unhandled rejection';
        showFatal(m);
      });
    })();
  </script>
</head>
<body class="text-slate-100">
  <div id="root" class="min-h-[100svh]"></div>

  <script>
  // ========================= ДАННЫЕ ПО УМОЛЧАНИЮ ============================
  const INLINE_FLAVORS = [
    { id: "musthave-ice-lemon", brand: "MustHave", name: "Ice Lemon", tags:["цитрус","лед"], strength10:5 },
    { id: "darkside-supernova", brand: "Darkside", name: "Supernova", tags:["лед","мята"], strength10:5 },
    { id: "black-burn-mango", brand: "Black Burn", name: "Mango", tags:["фрукт","сладкий"], strength10:6 }
  ];

  // ========================= УТИЛИТЫ ========================================
  const safeNum = (v, def = 0) => { const n = Number(v); return Number.isFinite(n) ? n : def; };
  const safePercent = (v) => Math.max(0, Math.min(100, safeNum(v, 0)));
  const percentSum = (parts=[]) => (Array.isArray(parts) ? parts.reduce((a,b)=>a+safePercent(b && b.percent),0) : 0);
  const isMixValid = (parts,title) => (Array.isArray(parts)?(parts.length>0 && percentSum(parts)===100 && String(title||"").trim().length>=3):false);
  const clampPercentForPart=(parts,targetId,newVal)=>{const otherSum=percentSum(parts.filter(x=>x && x.flavorId!==targetId));return Math.max(0,Math.min(safePercent(newVal),100-otherSum));};
  const uuidv4=()=>{let dt=Date.now();if(typeof performance!="undefined"&&typeof performance.now==="function")dt+=performance.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=(dt+Math.random()*16)%16|0;dt=Math.floor(dt/16);const v=c==="x"?r:(r&0x3)|0x8;return v.toString(16);});};
  const normalizeBrand=(b)=>(b||"").trim();
  const BRAND_STRENGTH10_DEFAULTS={Darkside:6,"Black Burn":6,BlackBurn:6,MustHave:5,Overdos:7,Bonch:7,Starline:3};
  const getStrength10=(f)=>{if(!f)return 5;if(typeof f.strength10==='number'&&Number.isFinite(f.strength10))return Math.max(1,Math.min(10,f.strength10));return BRAND_STRENGTH10_DEFAULTS[normalizeBrand(f.brand)]??5;};
  const strengthColor=(v)=>{if(v==null)return{bg:"bg-slate-800",text:"text-slate-200",border:"border-slate-700"};if(v<4)return{bg:"bg-emerald-950",text:"text-emerald-300",border:"border-emerald-800"};if(v<7)return{bg:"bg-amber-950",text:"text-amber-300",border:"border-amber-800"};return{bg:"bg-rose-950",text:"text-rose-300",border:"border-rose-800"};};
  const tasteWordFromTag=(tag)=>{if(tag==null)return null;const t=String(tag).toLowerCase().trim();if(!t)return null;const rules=[[/(кисл|sour|лимон|lime|грейпфрут)/,"кислый"],[/(сладк|sweet|sugar|мед|honey)/,"сладкий"],[/(прян|spice|ginger|имбир)/,"пряный"],[/(лед|ice|cold|frost|мят)/,"ледяной"],[/(фрукт|fruit|яблок|banana|mango|pineapple|grape|orange|pear|melon|berry)/,"фруктовый"],[/(десерт|dessert|cake|pie|cookie|choco|cream|vanilla|waffle)/,"десертный"]];for(const [re,w] of rules){if(re.test(t))return w;}return null;};
  const getMixTasteLabel=(parts,flavors)=>{if(!Array.isArray(parts)||!Array.isArray(flavors)||parts.length===0)return null;const total=percentSum(parts);if(total<=0)return null;const scores=new Map();const add=(raw,w)=>{const word=tasteWordFromTag(raw);if(word)scores.set(word,(scores.get(word)||0)+w);};for(const p of parts){const w=safePercent(p && p.percent);if(w<=0)continue;const fl=flavors.find(f=>f&&f.id===(p && p.flavorId));if(!fl)continue;if(fl.tags)for(const t of fl.tags)add(t,w);if(fl.name)for(const tk of String(fl.name).toLowerCase().split(/[^a-zа-я0-9]+/i))add(tk,Math.max(1,w*0.6));if(fl.description)for(const tk of String(fl.description).toLowerCase().split(/[^a-zа-я0-9]+/i))add(tk,Math.max(1,w*0.3));}if(!scores.size)return null;return Array.from(scores.entries()).sort((a,b)=>b[1]-a[1])[0][0]||null;};
  const normalizeSearch=(s)=>String(s||"").toLowerCase().trim();
  const filterFlavorsByQuery=(flavors,query)=>{const q=normalizeSearch(query);if(!q)return flavors||[];return(flavors||[]).filter(f=>String(f && f.name || "").toLowerCase().includes(q));};
  const escAttr=(s)=>String(s).replace(/"/g,'&quot;');
  const escHTML=(s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // ========================= СОСТОЯНИЕ ======================================
  const state={
    flavors:[],
    activeBrand:"",
    search:"", // строка поиска по вкусам (имя)
    parts:[], // [{flavorId, percent}]
    title:"",
    notes:"",
    guestMixes:[],
    activeTab:"builder", // 'builder' | 'guest'
    user:null // {id, name, username}
  };

  // ========================= ИНИЦИАЛИЗАЦИЯ ===================================
  function initAuth(){
    try{
      var u=window && window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user;
      if(u){
        var name=[u.first_name,u.last_name].filter(Boolean).join(' ')||u.username||('User '+u.id);
        state.user={id:u.id,name:name,username:u.username};
      }
    }catch(_){/* ignore */}
  }

  async function loadFlavors(){
    async function fetchJsonUtf8(url){
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) return null;
      try {
        const buf = await res.arrayBuffer();
        const text = new TextDecoder('utf-8').decode(buf);
        return JSON.parse(text);
      } catch (_) { try { return await res.json(); } catch (_) { return null; } }
    }
    try{
      const arr = await fetchJsonUtf8('./hookah_flavors.json');
      if (Array.isArray(arr) && arr.length){
        const cleaned = arr.map(function(x){return{
          id:String(x.id||((x.brand||'')+'-'+(x.name||''))).trim(),
          brand:String(x.brand||'').trim(),
          name:String(x.name||'').trim(),
          description:x.description!=null?String(x.description):undefined,
          tags:Array.isArray(x.tags)?x.tags:(typeof x.tags==='string'?x.tags.split(/[;,|]/).map(function(s){return s.trim();}).filter(Boolean):undefined),
          strength10:typeof x.strength10==='number'?x.strength10:undefined
        };}).filter(function(x){return x.id && x.brand && x.name;});
        if(cleaned.length){
          state.flavors=cleaned;
          if(!state.activeBrand) state.activeBrand=normalizeBrand(cleaned[0].brand);
          return;
        }
      }
    }catch(_){/* ignore */}
    state.flavors=INLINE_FLAVORS.slice();
    if(!state.activeBrand) state.activeBrand='MustHave';
  }

  async function loadGuestMixes(){
    async function fetchJsonUtf8(url){
      try {
        const res = await fetch(url, { cache:'no-store' });
        if (!res.ok) return null;
        try {
          const buf = await res.arrayBuffer();
          const text = new TextDecoder('utf-8').decode(buf);
          return JSON.parse(text);
        } catch (_) { try { return await res.json(); } catch (_) { return null; } }
      } catch (_) { return null; }
    }
    let data = await fetchJsonUtf8('./guest_mixes.json');
    if (!Array.isArray(data)) data = await fetchJsonUtf8('/guest_mixes.php');
    if (Array.isArray(data)) state.guestMixes = data;
    try{
      const ls=localStorage.getItem('guest_mixes');
      if(ls){ const arr=JSON.parse(ls); if(Array.isArray(arr)) state.guestMixes=arr; }
    }catch(_){/* ignore */}
  }

  // ========================= ВСПОМОГАТЕЛЬНОЕ ================================
  function LogoSVG(cls){
    return (
      '<svg class="'+(cls||'w-8 h-8')+'" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">\n' +
      '  <defs>\n' +
      '    <linearGradient id="g" x1="0" x2="1">\n' +
      '      <stop offset="0" stop-opacity="1" stop-color="#38bdf8"/>\n' +
      '      <stop offset="1" stop-opacity="1" stop-color="#a78bfa"/>\n' +
      '    </linearGradient>\n' +
      '  </defs>\n' +
      '  <circle cx="32" cy="32" r="30" fill="url(#g)" opacity="0.2"/>\n' +
      '  <path d="M32 10c-4 4-4 8 0 12 4 4 4 8 0 12-4 4-4 8 0 12" stroke="#c7d2fe" stroke-width="3" fill="none" stroke-linecap="round"/>\n' +
      '  <circle cx="32" cy="50" r="3" fill="#c7d2fe"/>\n' +
      '</svg>'
    );
  }

  // ========================= РЕНДЕР =========================================
  function render(){
    var root=document.getElementById('root');
    if(!root) return;

    // Экран авторизации (если Telegram WebApp не предоставил user)
    if(!state.user){
      const loginHTML = `
        <div class="min-h-[100svh] bg-slate-950 text-slate-100 flex items-center justify-center p-6">
          <div class="w-full max-w-sm text-center shadow rounded-2xl border border-slate-800 bg-slate-900">
            <div class="px-3 pt-3">
              <div class="flex items-center justify-center mb-2">${LogoSVG('w-16 h-16')}</div>
              <div class="text-lg font-bold">Вход через Telegram</div>
            </div>
            <div class="p-3 space-y-3">
              <div class="text-sm text-slate-300">Чтобы сохранять миксы под вашим именем, откройте приложение внутри Telegram.</div>
              <button id="openTg" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] bg-slate-100 text-slate-900 hover:bg-white">Открыть Telegram</button>
            </div>
          </div>
        </div>`;
      root.innerHTML = loginHTML;
      var openTg=document.getElementById('openTg');
      if(openTg){ openTg.addEventListener('click', function(){ try{ window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openTelegramLink && window.Telegram.WebApp.openTelegramLink('https://t.me'); }catch(_){/* ignore */} }); }
      return;
    }

    var brands = Array.from(new Set((state.flavors||[]).map(function(f){return normalizeBrand(f.brand);}))).filter(Boolean).sort();
    var flavorsOfActive = (state.flavors||[]).filter(function(f){return normalizeBrand(f.brand)===state.activeBrand;});
    var searchedFlavors = filterFlavorsByQuery(state.flavors, state.search);
    var listFlavors = state.search ? searchedFlavors : flavorsOfActive;

    var total = percentSum(state.parts);

    // strength & taste
    var mixStrength10 = (function(parts, flavors){
      if(!Array.isArray(parts)||!Array.isArray(flavors)) return null;
      var t=percentSum(parts); if(!parts.length||t<=0) return null;
      var w=0; for(var i=0;i<parts.length;i++){ var p=parts[i]; var pr=safePercent(p && p.percent); if(pr<=0) continue; var fl=flavors.find(function(x){return x && x.id===(p && p.flavorId);}); if(!fl) continue; w += getStrength10(fl) * (pr/t); }
      return w? Math.round(w*10)/10 : null;
    })(state.parts, state.flavors);
    var mixTaste = getMixTasteLabel(state.parts, state.flavors);

    var strengthBadge='';
    if(typeof mixStrength10==='number'){
      var c=strengthColor(mixStrength10);
      strengthBadge='<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+mixStrength10.toFixed(1)+'</span>';
    }

    // Списки HTML
    var brandsHTML = brands.map(function(b){ return '<button data-brand="'+b+'" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeBrand===b?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">'+b+'</button>'; }).join('');

    var flavorsHTML = listFlavors.map(function(f){
      var inMix = state.parts.some(function(p){return p.flavorId===f.id;});
      var s = getStrength10(f);
      var c = strengthColor(s);
      var desc = f.description ? '<div class="text-[11px] text-slate-400 truncate">'+escHTML(f.description)+'</div>' : '';
      return (
        '<div class="flex items-center justify-between gap-2 text-sm">\n' +
        '  <div class="min-w-0">\n' +
        '    <div class="flex items-center gap-2">\n' +
        '      <div class="font-medium truncate" title="'+escAttr((f.brand||'')+' • '+(f.name||''))+'">'+escHTML(f.name)+' <span class="opacity-60">('+escHTML(f.brand)+')</span></div>\n' +
        '      <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+s.toFixed(1)+'</span>\n' +
        '    </div>\n' +
        '    '+desc+'\n' +
        '  </div>\n' +
        '  <button data-add="'+f.id+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] '+(inMix?'opacity-50 cursor-not-allowed border border-slate-700':'border border-slate-700 hover:bg-slate-800')+'">'+(inMix?'✓':'+')+'</button>\n' +
        '</div>'
      );
    }).join('');

    var partsHTML = state.parts.map(function(p){
      var fl = state.flavors.find(function(x){return x.id===p.flavorId;});
      var name = (fl && fl.name) || p.flavorId;
      return (
        '<div class="flex items-center gap-2 text-sm">\n' +
        '  <span class="truncate w-36" title="'+escAttr(name)+'">'+escHTML(name)+'</span>\n' +
        '  <input type="range" min="0" max="100" step="5" class="w-28" value="'+safePercent(p.percent)+'" data-range="'+p.flavorId+'"/>\n' +
        '  <span class="w-10 text-right">'+safePercent(p.percent)+'%</span>\n' +
        '  <button data-remove="'+p.flavorId+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] hover:bg-slate-800">Удалить</button>\n' +
        '</div>'
      );
    }).join('');

    var guestHTML = state.guestMixes.map(function(m){
      var c = typeof m.strength10==='number' ? strengthColor(m.strength10) : strengthColor(null);
      var sBadge = typeof m.strength10==='number' ? '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+m.strength10.toFixed(1)+'</span>' : '';
      var tBadge = m.taste ? '<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(m.taste)+'</span>' : '';
      var notes = m.notes ? '<div class="text-[12px] opacity-80 mt-1">'+escHTML(m.notes)+'</div>' : '';
      var parts = (m.parts||[]).map(function(pp){ var fl = state.flavors.find(function(x){return x.id===pp.flavorId;}); return '<div class="flex items-center justify-between text-[12px]"><span class="truncate mr-2">'+escHTML(fl?fl.name:pp.flavorId)+'</span><span class="opacity-70">'+safePercent(pp.percent)+'%</span></div>'; }).join('');
      return (
        '<div class="border border-slate-800 rounded-xl p-2 text-sm">\n' +
        '  <div class="flex items-center gap-2">\n' +
        '    <div class="font-semibold truncate">'+escHTML(m.title)+'</div>\n' +
        '    '+sBadge+'\n' +
        '    '+tBadge+'\n' +
        '  </div>\n' +
        '  <div class="text-[11px] text-slate-400">микс от '+escHTML(m.author||'Гость')+'</div>\n' +
        '  '+notes+'\n' +
        '  <div class="mt-1 space-y-0.5">'+parts+'</div>\n' +
        '</div>'
      );
    }).join('');

    const headerHTML = `
      <header class="flex items-center justify-between">
        <div class="flex items-center gap-2 min-w-0">${LogoSVG()}<h1 class="text-lg font-bold truncate">Hookah Mixes</h1></div>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">Здравствуйте, ${escHTML(state.user && state.user.name ? state.user.name : 'Гость')}</span>
          <button data-tab="builder" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] ${state.activeTab==='builder'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800'}">Конструктор</button>
          <button data-tab="guest" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] ${state.activeTab==='guest'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800'}">Миксы гостей</button>
        </div>
      </header>`;

    const brandsBlock = `
      <div class="rounded-2xl border border-slate-800 bg-slate-900">
        <div class="px-3 pt-3"><div class="text-xs font-semibold">Бренды</div></div>
        <div class="p-3 space-y-2">
          <div class="space-y-2">
            <input id="search" placeholder="Поиск вкуса по названию…" value="${escAttr(state.search||'')}" class="h-9 w-full rounded-xl border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 px-3 text-sm outline-none focus:ring-2 focus:ring-slate-600" />
            <div class="grid grid-cols-2 gap-1">${brandsHTML}${brands.length===0?'<div class="text-[12px] text-slate-400">Файл hookah_flavors.json не найден</div>':''}</div>
          </div>
          ${state.search ? `<div class="text-[11px] text-slate-400">Найдено: ${listFlavors.length}</div>` : (state.activeBrand ? `<div class="text-[11px] text-slate-400">Вкусы бренда: ${escHTML(state.activeBrand)}</div>` : '')}
          ${flavorsHTML}
          ${listFlavors.length===0?`<div class="text-[12px] text-slate-400">${state.search?'Ничего не найдено':'Нет вкусов для этого бренда'}</div>`:''}
        </div>
      </div>`;

    const mixBlock = `
      <div class="rounded-2xl border border-slate-800 bg-slate-900">
        <div class="px-3 pt-3"><div class="text-xs font-semibold">Микс</div></div>
        <div class="p-3 space-y-2">
          ${state.parts.length===0?'<div class="text-[12px] text-slate-400">Добавьте вкусы из списка</div>':''}
          ${partsHTML}
          <div class="flex items-center justify-between text-[12px]">
            <span>Итог: ${total}%</span>
            <div class="flex items-center gap-2">${strengthBadge}${mixTaste?('<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(mixTaste)+'</span>'):''}</div>
          </div>
        </div>
      </div>`;

    const titleBlock = `
      <div class="rounded-2xl border border-slate-800 bg-slate-900">
        <div class="px-3 pt-3"><div class="text-xs font-semibold">Название и описание</div></div>
        <div class="p-3 space-y-2">
          <input id="title" placeholder="Название микса" value="${escAttr(state.title||'')}" class="h-9 w-full rounded-xl border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 px-3 text-sm outline-none focus:ring-2 focus:ring-slate-600" />
          <textarea id="notes" placeholder="Описание / заметки…" class="min-h-[72px] w-full rounded-xl border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-600">${escHTML(state.notes||'')}</textarea>
          <div class="flex gap-2">
            <button id="reset" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-slate-700 hover:bg-slate-800">Сброс</button>
            <button id="save" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] ${isMixValid(state.parts,state.title)?'bg-slate-100 text-slate-900':'opacity-50 cursor-not-allowed border border-slate-700'}">Сохранить</button>
          </div>
        </div>
      </div>`;

    const guestBlock = `
      <div class="rounded-2xl border border-slate-800 bg-slate-900">
        <div class="px-3 pt-3"><div class="text-xs font-semibold">Миксы гостей</div></div>
        <div class="p-3 space-y-2">
          ${state.guestMixes.length===0?'<div class="text-[12px] text-slate-400">Пока нет сохранённых миксов</div>':''}
          ${guestHTML}
        </div>
      </div>`;

    const bodyHTML = `
      <div class="min-h-[100svh] bg-slate-950 text-slate-100 p-3">
        <div class="mx-auto w-full max-w-md space-y-3">
          ${headerHTML}
          ${state.activeTab==='builder' ? `${brandsBlock}${mixBlock}${titleBlock}` : ''}
          ${state.activeTab==='guest' ? `${guestBlock}` : ''}
        </div>
      </div>`;

    root.innerHTML = bodyHTML;

    // ===== События =====
    // Переключение табов
    Array.prototype.forEach.call(root.querySelectorAll('[data-tab]'), function(btn){
      btn.addEventListener('click', function(){ state.activeTab = this.getAttribute('data-tab'); render(); });
    });
    // Переключение бренда
    Array.prototype.forEach.call(root.querySelectorAll('[data-brand]'), function(btn){
      btn.addEventListener('click', function(){ state.activeBrand = this.getAttribute('data-brand'); state.search=''; render(); });
    });
    // Поиск
    var search = root.querySelector('#search');
    if(search){ search.addEventListener('input', function(e){ state.search = e.target.value; render(); }); }
    // Добавить вкус
    Array.prototype.forEach.call(root.querySelectorAll('[data-add]'), function(btn){
      btn.addEventListener('click', function(){ var id=this.getAttribute('data-add'); if(!id) return; if(state.parts.some(function(p){return p.flavorId===id;})) return; var def=Math.min(30, Math.max(0, 100 - percentSum(state.parts))); state.parts = state.parts.concat([{ flavorId:id, percent:def }]); render(); });
    });
    // Слайдеры
    Array.prototype.forEach.call(root.querySelectorAll('[data-range]'), function(sl){
      sl.addEventListener('input', function(){ var id=this.getAttribute('data-range'); var val=safePercent(this.value); state.parts = state.parts.map(function(p){ return p.flavorId===id ? { flavorId:p.flavorId, percent: clampPercentForPart(state.parts, id, val) } : p; }); render(); });
    });
    // Удалить
    Array.prototype.forEach.call(root.querySelectorAll('[data-remove]'), function(btn){
      btn.addEventListener('click', function(){ var id=this.getAttribute('data-remove'); state.parts = state.parts.filter(function(p){return p.flavorId!==id;}); render(); });
    });
    // Поля формы
    var titleEl=root.querySelector('#title'); if(titleEl){ titleEl.addEventListener('input', function(e){ state.title = e.target.value; }); }
    var notesEl=root.querySelector('#notes'); if(notesEl){ notesEl.addEventListener('input', function(e){ state.notes = e.target.value; }); }
    var resetEl=root.querySelector('#reset'); if(resetEl){ resetEl.addEventListener('click', function(){ state.title=''; state.notes=''; state.parts=[]; render(); }); }
    var saveEl=root.querySelector('#save'); if(saveEl){ saveEl.addEventListener('click', async function(){
      if(!isMixValid(state.parts, state.title)) return;
      if(!state.user) return; // требуем авторизацию
      var mix={ id:uuidv4(), title:String(state.title).trim(), parts: state.parts.slice(), notes:String(state.notes||'').trim(), author: state.user.name || 'Гость', createdAt: Date.now(), taste: getMixTasteLabel(state.parts, state.flavors) || null, strength10: (function(){ var t=percentSum(state.parts); if(!t) return null; var w=0; for(var i=0;i<state.parts.length;i++){ var p=state.parts[i]; var pr=safePercent(p.percent); if(pr<=0) continue; var fl=state.flavors.find(function(x){return x && x.id===p.flavorId;}); if(!fl) continue; w+=getStrength10(fl)*(pr/t);} return w?Math.round(w*10)/10:null; })() };
      // Node
      try{ var r1=await fetch('/api/mixes',{method:'POST',headers:{'Content-Type':'application/json; charset=UTF-8'},body:JSON.stringify(mix)}); if(r1.ok){ var saved=await r1.json().catch(function(){return null;}); state.guestMixes=[(saved||mix)].concat(state.guestMixes).slice(0,500); state.title=''; state.notes=''; state.parts=[]; state.activeTab='guest'; try{ localStorage.setItem('guest_mixes', JSON.stringify(state.guestMixes)); }catch(_){/* ignore */} render(); return; } }catch(_){/* ignore */}
      // PHP
      try{ var r2=await fetch('/save_mixes.php',{method:'POST',headers:{'Content-Type':'application/json; charset=UTF-8'},body:JSON.stringify(mix)}); if(r2.ok){ state.guestMixes=[mix].concat(state.guestMixes).slice(0,500); state.title=''; state.notes=''; state.parts=[]; state.activeTab='guest'; try{ localStorage.setItem('guest_mixes', JSON.stringify(state.guestMixes)); }catch(_){/* ignore */} render(); return; } }catch(_){/* ignore */}
      // Fallback: локально + скачать
      state.guestMixes=[mix].concat(state.guestMixes).slice(0,500);
      try{ localStorage.setItem('guest_mixes', JSON.stringify(state.guestMixes)); }catch(_){/* ignore */}
      try{ var json='\uFEFF'+JSON.stringify(state.guestMixes,null,2); var blob=new Blob([json],{type:'application/json; charset=UTF-8'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='guest_mixes.json'; document.body.appendChild(a); a.click(); setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100); }catch(_){/* ignore */}
      state.title=''; state.notes=''; state.parts=[]; state.activeTab='guest'; render();
    }); }
  }

  // ========================= СТАРТ ПРИЛОЖЕНИЯ ===============================
  (async function start(){ try{ initAuth(); await loadFlavors(); await loadGuestMixes(); render(); }catch(e){ console.error(e); } })();

  // ========================= SMOKE TESTS ====================================
  ;(function(){ try{
    console.group('HookahMixes – smoke tests');
    {var p1=[{flavorId:'a',percent:60},{flavorId:'b',percent:40}]; console.assert(percentSum(p1)===100,'sum=100');}
    {var p2=[{flavorId:'a',percent:60},{flavorId:'b',percent:30}]; console.assert(percentSum(p2)===90,'sum=90');}
    {var ok=isMixValid([{flavorId:'a',percent:60},{flavorId:'b',percent:40}], 'Mix'); console.assert(ok===true,'valid=100+title');}
    {var cl=clampPercentForPart([{flavorId:'a',percent:90},{flavorId:'b',percent:0}], 'b', 20); console.assert(cl===10,'clamp remaining');}
    {var cl2=clampPercentForPart([{flavorId:'a',percent:50}], 'a', 150); console.assert(cl2===100,'clamp max');}
    {var r=filterFlavorsByQuery([{id:'1',name:'Mango'},{id:'2',name:'Ice'},{id:'3',name:'Ice Mango'}], 'mango'); console.assert(r.length===2,'search across brands');}
    // (39) taste null when empty
    {var t=getMixTasteLabel([],[]); console.assert(t===null,'taste null');}
    // (40) clamp single lower bound
    {var cl3=clampPercentForPart([{flavorId:'a',percent:10}], 'a', -5); console.assert(cl3===0,'clamp to 0');}
    console.groupEnd();
  }catch(e){ console.error('Smoke tests error', e); } })();
  </script>
</body>
</html>
