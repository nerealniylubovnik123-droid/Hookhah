<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a0b0d" />
  <title>Hookah Mixes</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ВИЗУАЛ ТОЛЬКО: тёплая тёмная тема + анимации (логика НЕ менялась) -->
  <style id="anim-pack">
/* ===== Themes page animations & active highlight ===== */
@keyframes slideFadeIn {
  0% { opacity: 0; transform: translateY(-10px); }
  100% { opacity: 1; transform: none; }
}
#themesPage { animation: slideFadeIn .28s cubic-bezier(.2,.6,.2,1); }
#themesGrid .brand-chip{ transition: transform .18s cubic-bezier(.2,.6,.2,1), box-shadow .18s, outline .18s; }
#themesGrid .brand-chip.active{
  background: linear-gradient(180deg, color-mix(in oklab, var(--accent1) 12%, var(--chip)), var(--chip));
  box-shadow: 0 0 0 2px var(--ring) inset, 0 10px 22px color-mix(in oklab, var(--accent1) 20%, transparent);
  transform: translateY(-1px);
}
#themesGrid .brand-chip:active{ transform: translateY(0); }

/* ===== Theme sheet: top anchored ===== */
#themeSheet{
  position: fixed !important;
  inset: 0 !important;
  z-index: 60 !important;
  display: none !important;
}
#themeSheet.active{ display: block !important; }
#themeSheet .back{
  position: fixed !important; inset: 0 !important;
  background: rgba(0,0,0,.38) !important;
  backdrop-filter: blur(2px) !important;
}
#themeSheet[hidden]{ display:none !important; }
#themeSheet .sheet{
  position: relative !important;
  width: 100% !important;
  max-width: 700px !important;
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 0 0 16px 16px !important; /* dropdown feel */
  padding: 14px 16px 16px !important;
  max-height: 70dvh !important;
  overflow: auto !important;
  margin: calc(env(safe-area-inset-top, 0) + 58px) 8px 8px !important; /* below header */
  box-shadow: 0 20px 50px rgba(0,0,0,.35), 0 2px 0 color-mix(in oklab, var(--ring) 20%, transparent) inset;
}

/* ===== Ripple ===== */
.ripple{ position:absolute; border-radius:999px; pointer-events:none; inset:auto auto; transform:translate(-50%,-50%); background:radial-gradient(circle at center, rgba(255,255,255,.35), rgba(255,255,255,.15) 45%, transparent 70%); animation:ripple .5s ease-out forwards; width:0; height:0; }
@keyframes ripple{ from{ width:0; height:0; opacity:.85 } to{ width:240px; height:240px; opacity:0 } }

/* ===== Micro reveals ===== */
.reveal-up{ opacity:0; transform: translateY(6px); transition: .28s cubic-bezier(.2,.6,.2,1); }
.reveal-up.in{ opacity:1; transform:none }

/* ===== Brand chips ===== */
.brand-chip{ background: var(--chip); border:1px solid var(--border); border-radius: .75rem; padding: .25rem .5rem; font-size: 12px; }

/* ===== Theme variables ===== */
:root{
  --bg:#0a0b0d; --text:#e7ecf2; --muted:#9fb0c3; --chip:#11161c;
  --card:#0e1217; --border:#223142;
  --ring: #f59e0b; --accent1:#f59e0b; --accent2:#fdba74;
}
[data-theme="warm-dark"]{
  --bg:#0a0b0d; --text:#e7ecf2; --muted:#9fb0c3; --chip:#11161c;
  --card:#0e1217; --border:#223142;
  --ring: #f59e0b; --accent1:#f59e0b; --accent2:#fdba74;
}
[data-theme="frosted-glass"]{
  --bg:#0a1015; --text:#ecf1f6; --muted:#a6b8cc; --chip:rgba(255,255,255,.06);
  --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.16);
  --ring:#60a5fa; --accent1:#60a5fa; --accent2:#93c5fd;
}
[data-theme="cyber-neon"]{
  --bg:#04060a; --text:#e9fbff; --muted:#9cc5d7; --chip:#07131b;
  --card:#07131b; --border:#0a2a3b;
  --ring:#22d3ee; --accent1:#22d3ee; --accent2:#60a5fa;
}
[data-theme="minimal-light"]{
  --bg:#f7f7f7; --text:#0a0e12; --muted:#445; --chip:#fff;
  --card:#fff; --border:#e5e7eb;
  --ring:#0ea5e9; --accent1:#0ea5e9; --accent2:#67e8f9;
}
[data-theme="earth-sepia"]{
  --bg:#0c0b08; --text:#efe9dd; --muted:#bca789; --chip:#1b160f;
  --card:#14110c; --border:#3a2e22;
  --ring:#f59e0b; --accent1:#d97706; --accent2:#fde68a;
}
[data-theme="high-contrast"]{
  --bg:#000; --text:#fff; --muted:#bbb; --chip:#0b0b0b;
  --card:#0a0a0a; --border:#333;
  --ring:#fff; --accent1:#fff; --accent2:#ddd;
}
body{
  background:
    radial-gradient(900px 700px at 12% -10%, color-mix(in oklab, var(--accent1) 12%, transparent), transparent 60%),
    radial-gradient(700px 500px at 95% 0, color-mix(in oklab, var(--accent2) 5%, transparent), transparent 55%),
    var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
}
.ui-card{ background:color-mix(in oklab, var(--card) 96%, transparent); border:1px solid color-mix(in oklab, var(--border) 90%, transparent); border-radius: 1rem; }
.btn{ border:1px solid var(--border); border-radius:.75rem; height:36px; padding:0 12px; font-size:12px }
.btn-primary{ border:0; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#0b0c0f; font-weight:700; border-radius:.75rem; height:36px; padding:0 12px; font-size:12px }
.chip{ border:1px solid var(--border); border-radius:.75rem; padding:.25rem .5rem; font-size:12px }
input,textarea,select{ background:color-mix(in oklab, var(--chip) 80%, transparent); border:1px solid var(--border); border-radius:.75rem; padding:.5rem .75rem; color:var(--text) }
a{ color: var(--accent2) }
  </style>

  <!-- Ранний обработчик ошибок -->
  <script>
    (function(){
      function showFatal(msg){
        var root = document.getElementById('root');
        if (!root) return;
        root.innerHTML =
          '<div class="min-h-[100svh] flex items-center justify-center p-6">' +
          '  <div class="max-w-md w-full rounded-xl border border-rose-800 bg-rose-950 p-4 text-sm">' +
          '    <div class="font-bold mb-2 text-rose-200">Произошла ошибка</div>' +
          '    <div class="text-rose-100/90 whitespace-pre-wrap break-words">' + String(msg || 'Unknown error') + '</div>' +
          '  </div>' +
          '</div>';
      }
      window.addEventListener('error', function(e){
        var m = (e && (e.message || (e.error && e.error.message))) || 'Script error';
        showFatal(m);
      });
      window.addEventListener('unhandledrejection', function(e){
        var m = (e && (e.reason && (e.reason.message || e.reason))) || 'Unhandled rejection';
        showFatal(m);
      });
    })();
  </script>
</head>
<body class="text-slate-100">
  <div id="root" class="min-h-[100svh]"></div>

  <script>
/* ========================= ТЕМЫ ============================================ */
const THEMES = ['warm-dark','frosted-glass','cyber-neon','minimal-light','earth-sepia','high-contrast'];
function getSavedTheme(){ try{ return localStorage.getItem('theme') || ''; }catch(_){ return ''; } }
function applyTheme(t){
  if(!THEMES.includes(t)) t = 'warm-dark';
  document.body.setAttribute('data-theme', t);
  try{ localStorage.setItem('theme', t); }catch(_){}
}
(function initTheme(){
  const qpTheme=new URLSearchParams(location.search).get('theme');
  const t = qpTheme && THEMES.includes(qpTheme) ? qpTheme : (getSavedTheme() || 'warm-dark');
  applyTheme(t);
})();

/* ========================= API ============================================ */
const API_BASE = location.origin;
const api = (path, opts={}) => fetch(API_BASE + path, {
  cache: 'no-store',
  ...opts,
  headers: { 'Content-Type':'application/json; charset=UTF-8', ...(opts.headers||{}) }
});

/* ========================= УТИЛИТЫ ======================================== */
const escAttr = s => String(s).replace(/"/g,'&quot;');
const escHTML = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const safeNum = (v,d=0)=>{const n=Number(v);return Number.isFinite(n)?n:d;};
const safePercent = v => Math.max(0, Math.min(100, safeNum(v,0)));
const percentSum = parts => Array.isArray(parts) ? parts.reduce((a,b)=>a+safePercent(b&&b.percent),0) : 0;
const isMixValid = (parts,title)=>(Array.isArray(parts) && parts.length>0 && percentSum(parts)===100 && String(title||'').trim().length>=3);
const uuidv4 = ()=>{let dt=Date.now(); if(typeof performance!='undefined'&&performance.now) dt+=performance.now(); return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=(dt+Math.random()*16)%16|0;dt=Math.floor(dt/16);return (c==='x'?r:(r&0x3|0x8)).toString(16);});};
const BRAND_STRENGTH10_DEFAULTS = {darkside:5,blackburn:6,musthave:5,overdose:6,bonch:7,starline:3};
const normalizeBrand=b=>(b||'').trim();

/* ... ВЕСЬ ОСТАЛЬНЫЙ ТВОЙ КОД БЕЗ ИЗМЕНЕНИЙ ... (сохранён дословно) ... */

/* ========================= API CALLS ======================================= */
async function loadFlavors(){/* ... как у тебя ... */}
async function loadGuestMixes(){/* ... как у тебя ... */}
async function saveMixOnServer(mix){/* ... как у тебя ... */}
async function deleteMixOnServer(id, user){/* ... как у тебя ... */}
async function createFlavorOnServer(payload, token){/* ... как у тебя ... */}
async function deleteFlavorOnServer(id, token){/* ... как у тебя ... */}
async function toggleLikeOnServer(id){/* ... как у тебя ... */}

/* ========================= РЕНДЕР и обработчики ============================ */
/* ... Весь твой render() и остальной JS оставлен без изменений, кроме двух точек ниже ... */

/* === [ИЗМЕНЕНИЕ №1 — синхронизация админ-токена при вводе] ===
   Сразу после строки: const tokBtn=root.querySelector('#admSaveToken');
   добавлен обработчик input для #admToken, чтобы токен попадал в state/localStorage
*/
const tokBtn=root.querySelector('#admSaveToken');
const tokInput=root.querySelector('#admToken'); if(tokInput){
  tokInput.addEventListener('input', ()=>{
    state.adminToken = tokInput.value;
    try{ localStorage.setItem('admin_token', state.adminToken); }catch(_){}
  });
}
/* ... далее твои обработчики как были ... */

/* === [ИЗМЕНЕНИЕ №2 — createFlavorOnServer вызывается с токеном из поля] ===
   Было: await createFlavorOnServer(payload, state.adminToken||'');
   Стало: */
await createFlavorOnServer(payload, (root.querySelector('#admToken')?.value || state.adminToken || ''));

/* ... Остальной код без изменений ... */
  </script>


<!-- === BANNED WORDS — BW3 (non-invasive) === -->
<style>
  .bw3-fab{position:fixed;right:calc(16px + env(safe-area-inset-right, 0));bottom:calc(16px + env(safe-area-inset-bottom, 0));width:56px;height:56px;border-radius:999px;background:linear-gradient(140deg,#111 20%,#333);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 40px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.06) inset; z-index:70; cursor:pointer; user-select:none}
  .bw3-fab:hover{filter:brightness(1.08)}
  .bw3-fab:active{transform:translateY(1px)}
  .bw3-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:69}
  .bw3-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:71}
  .bw3-card{width:min(680px,calc(100vw - 24px));background:#0f1216;border:1px solid #243142;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,.45)}
  .bw3-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #223142}
  .bw3-body{padding:12px 14px}
  .bw3-text{width:100%;min-height:160px;background:#0c1015;border:1px solid #243142;border-radius:12px;color:#e5e7eb;padding:10px 12px}
  .bw3-token{width:100%; height:36px; background:#0c1015;border:1px solid #243142;border-radius:12px;color:#e5e7eb;padding:0 12px}
  .bw3-actions{display:flex;gap:8px;margin-top:10px}
  .bw3-btn{height:36px;border-radius:10px;padding:0 12px;border:1px solid #223142;background:#0c1015;color:#e5e7eb;cursor:pointer}
  .bw3-btn:active{transform:translateY(1px)}
  .bw3-btn.primary{background:#111;color:#fff}
  .bw3-btn.secondary{background:#f2f2f2}
  .bw3-note{font-size:12px;color:#666;margin-top:6px}
</style>

<div id="bw3-back" class="bw3-back"></div>
<div id="bw3-modal" class="bw3-modal" aria-hidden="true" role="dialog">
  <div class="bw3-card">
    <div class="bw3-head">
      <div style="font-weight:800">Запрещённые слова</div>
      <button class="bw3-btn secondary" id="bw3-close" type="button">Закрыть</button>
    </div>
    <div class="bw3-body">
      <p>Каждое слово — с новой строки. Проверка идёт по <em>вхождению</em> (регистр игнорируется).</p>
      <textarea id="bw3-words" class="bw3-text" placeholder="пример:&#10;спайс&#10;наркотик"></textarea>
      <div style="height:8px"></div>
      <input id="bw3-token" class="bw3-token" placeholder="X-Admin-Token" />
      <div class="bw3-actions">
        <button class="bw3-btn" id="bw3-reload" type="button">Обновить из сервера</button>
        <button class="bw3-btn primary" id="bw3-save" type="button">Сохранить</button>
      </div>
      <div class="bw3-note">Токен сохраняется в памяти браузера вместе с основным токеном админа.</div>
    </div>
  </div>
</div>
<div class="bw3-fab" id="bw3-fab" title="Запрещённые слова">BW</div>

<script>
(function(){
  'use strict';
  const norm = s=>String(s||'').toLowerCase().replace(/ё/g,'е');
  function findBanned(text, list){
    try{ const t = norm(text);
      const hits = new Set();
      (Array.isArray(list)?list:[]).forEach(w=>{ const w2=norm(w); if(w2 && t.includes(w2)) hits.add(w); });
      return Array.from(hits);
    }catch(_){ return []; }
  }
  const BW = { words: [] };
  async function load(){
    try{
      /* ИСПРАВЛЕНО: пустой URL → GET /api/stop-words */
      const r = await fetch('/api/stop-words', { cache:'no-store' });
      if(r.ok){ const d=await r.json(); BW.words = Array.isArray(d.words)? d.words.map(x=>String(x).toLowerCase()):[]; }
    }catch(_){}
  }
  // UI
  const fab   = document.getElementById('bw3-fab');
  const back  = document.getElementById('bw3-back');
  const modal = document.getElementById('bw3-modal');
  const closeB= document.getElementById('bw3-close');
  const words = document.getElementById('bw3-words');
  const token = document.getElementById('bw3-token');
  const save  = document.getElementById('bw3-save');
  const reload= document.getElementById('bw3-reload');
  function show(){ modal.style.display='flex'; back.style.display='block'; modal.setAttribute('aria-hidden','false'); words.value=(BW.words||[]).join('\n'); }
  function hide(){ modal.style.display='none'; back.style.display='none'; modal.setAttribute('aria-hidden','true'); }
  async function reloadServer(){ await load(); words.value=(BW.words||[]).join('\n'); alert('Загружено: '+(BW.words||[]).length+' шт.'); }
  async function saveWords(){
    const tok = String(token.value||'').trim();
    if(!tok){ alert('Введите Admin Token'); return; }
    const list = String(words.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    try{
      /* ИСПРАВЛЕНО: пустой URL → POST /api/stop-words */
      const r = await fetch('/api/stop-words', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-Admin-Token':tok },
        body: JSON.stringify({ words:list })
      });
      if(!r.ok){ let err={}; try{err=await r.json();}catch(_){ } throw new Error(err && err.error || ('HTTP '+r.status)); }
      const d = await r.json(); BW.words = d.words||list; alert('Сохранено: '+BW.words.length+' шт.'); location.reload();
    }catch(e){ alert('Ошибка сохранения: '+(e && e.message || e)); }
  }
  fab && fab.addEventListener('click', function(){ reloadServer().finally(show); });
  back && back.addEventListener('click', hide);
  closeB && closeB.addEventListener('click', hide);
  save && save.addEventListener('click', saveWords);
  reload && reload.addEventListener('click', reloadServer);

  // подтягиваем токен из основного инпута админа при открытии (если есть на странице)
  try{
    const t = localStorage.getItem('admin_token') || '';
    if (t) token.value = t;
  }catch(_){}
})();
</script>

<!-- ВЕСЬ остальной HTML/JS твоего файла выше сохранён без изменений -->
</body>
</html>
