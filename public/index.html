<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#020617" />
  <title>Hookah Mixes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{background:#020617}</style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Ранний экран ошибок (как у вас) -->
  <script>
    (function(){
      function showFatal(msg){
        var root = document.getElementById('root');
        if (!root) return;
        root.innerHTML =
          '<div class="min-h-[100svh] flex items-center justify-center p-6">' +
          '  <div class="max-w-md w-full rounded-xl border border-rose-800 bg-rose-950 p-4 text-sm">' +
          '    <div class="font-bold mb-2 text-rose-200">Произошла ошибка</div>' +
          '    <div class="text-rose-100/90 whitespace-pre-wrap break-words">' + String(msg || 'Unknown error') + '</div>' +
          '  </div>' +
          '</div>';
      }
      window.addEventListener('error', function(e){
        var m = (e && (e.message || (e.error && e.error.message))) || 'Script error';
        showFatal(m);
      });
      window.addEventListener('unhandledrejection', function(e){
        var m = (e && (e.reason && (e.reason.message || e.reason))) || 'Unhandled rejection';
        showFatal(m);
      });
    })();
  </script>
</head>
<body class="text-slate-100">
  <div id="root" class="min-h-[100svh]"></div>

  <script>
  // ========================= API ============================================
  const API_BASE = "https://hookhah.onrender.com";
  function api(path, opts = {}) {
    // ИСПРАВЛЕНО: точка перед spread ломала скрипт. Должно быть '...(opts.headers||{})'
    const headers = { Accept: "application/json", ...(opts.headers || {}) };
    if (opts.body && !headers["Content-Type"] && !(opts.body instanceof FormData)) {
      headers["Content-Type"] = "application/json; charset=UTF-8";
    }
    return fetch(API_BASE + path, { cache: "no-store", ...opts, headers });
  }

  // ========================= УТИЛИТЫ (как было) =============================
  const safeNum = (v, d=0) => { const n = Number(v); return Number.isFinite(n)?n:d; };
  const safePercent = (v) => Math.max(0, Math.min(100, safeNum(v, 0)));
  const percentSum = (parts=[]) => (Array.isArray(parts)?parts.reduce((a,b)=>a+safePercent(b && b.percent),0):0);
  const isMixValid = (parts,title) => (Array.isArray(parts)?(parts.length>0 && percentSum(parts)===100 && String(title||'').trim().length>=3):false);
  const clampPercentForPart=(parts,targetId,newVal)=>{
    const other=percentSum(parts.filter(x=>x&&x.flavorId!==targetId));
    return Math.max(0,Math.min(safePercent(newVal),100-other));
  };
  const escAttr=(s)=>String(s).replace(/"/g,'&quot;');
  const escHTML=(s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const normalizeBrand = (s)=>String(s||'').toLowerCase().trim();
  const getStrength10=(fl)=>Number.isFinite(fl&&fl.strength10)?Number(fl.strength10)
                         : Number.isFinite(fl&&fl.strength)?Number(fl.strength)
                         : 5;
  const strengthColor=(v)=>{
    if(typeof v!=='number') return { bg:'border-slate-700', text:'text-slate-300', border:'border-slate-700' };
    if(v<=3)  return { bg:'bg-emerald-900/40', text:'text-emerald-200', border:'border-emerald-700' };
    if(v<=7)  return { bg:'bg-slate-900',      text:'text-slate-200',   border:'border-slate-700' };
    return      { bg:'bg-rose-900/40',         text:'text-rose-200',    border:'border-rose-700' };
  };

  const tasteWordFromTag=(t)=>{
    t=String(t||'').toLowerCase().trim();if(!t)return null;
    const rules=[
      [/(кисл|sour|лимон|lime|грейпфрут)/,"кислый"],
      [/(сладк|sweet|sugar|мед|honey)/,"сладкий"],
      [/(прян|spice|ginger|имбир)/,"пряный"],
      [/(лед|ice|cold|frost|мят)/,"ледяной"],
      [/(фрукт|fruit|яблок|banana|mango|pineapple|grape|orange|pear|melon|berry)/,"фруктовый"],
      [/(десерт|dessert|cake|pie|cookie|choco|cream|vanilla|waffle)/,"десертный"]
    ];
    for (const [re,w] of rules){ if(re.test(t)) return w; }
    return null;
  };
  const getMixTasteLabel=(parts,flavors)=>{
    if(!Array.isArray(parts)||!Array.isArray(flavors)||parts.length===0)return null;
    const total=percentSum(parts); if(total<=0)return null;
    const scores=new Map();
    const add=(raw,w)=>{const word=tasteWordFromTag(raw);if(word)scores.set(word,(scores.get(word)||0)+w);};
    for (const p of parts){
      const w=safePercent(p&&p.percent); if(w<=0)continue;
      const fl=flavors.find(f=>f&&f.id===(p&&p.flavorId)); if(!fl)continue;
      if(fl.tags) for(const t of fl.tags) add(t,w);
      if(fl.name) for(const tk of String(fl.name).toLowerCase().split(/[^a-zа-я0-9]+/i)) add(tk,Math.max(1,w*0.6));
      if(fl.description) for(const tk of String(fl.description).toLowerCase().split(/[^a-zа-я0-9]+/i)) add(tk,Math.max(1,w*0.3));
    }
    if(!scores.size)return null;
    return Array.from(scores.entries()).sort((a,b)=>b[1]-a[1])[0][0]||null;
  };

  // ========================= СОСТОЯНИЕ (как у вас) ==========================
  const qp = new URLSearchParams(location.search);
  const state={
    flavors:[],
    activeBrand:"",
    search:"",
    parts:[],
    title:"",
    notes:"",
    guestMixes:[],
    activeTab:"builder",
    user:null,
    showSplash:false,
    logoUrl:null,
    adminToken: (localStorage.getItem('admin_token') || ""),
    adminPrompt: qp.get('admin') === '1'
  };
  const isAdmin=()=> !!(state.adminToken && state.adminToken.length>=6);

  // ========================= ИНИЦИАЛИЗАЦИЯ (как у вас) ======================
  function initAuth(){
    try{
      var u=window?.Telegram?.WebApp?.initDataUnsafe?.user;
      if(u){
        var name=[u.first_name,u.last_name].filter(Boolean).join(' ')||u.username||('User '+u.id);
        state.user={id:String(u.id),name,username:u.username};
        state.showSplash = true;
        return;
      }
    }catch(_){}
    state.user = { id:"anon", name:"Гость" };
    state.showSplash = true;
  }

  async function detectLogo(){
    async function exists(url){ try{ const r=await fetch(url,{method:'HEAD',cache:'no-store'}); return r.ok; }catch(_){ return false; } }
    const candidates=[ './logo.jpg','./logo.jpeg','./logo.JPG','./logo.JPEG','./AKGpihYIdG2xycCNV3hAm2gVxkuF4tS5.jpg' ];
    for(const c of candidates){ if(await exists(c)){ state.logoUrl=c; return; } }
    state.logoUrl=null;
  }
  function LogoSVG(cls){
    return (
      '<svg class="'+(cls||'w-8 h-8')+'" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">' +
      '  <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#38bdf8"/><stop offset="1" stop-color="#a78bfa"/></linearGradient></defs>' +
      '  <circle cx="32" cy="32" r="30" fill="url(#g)" opacity="0.2"/>' +
      '  <path d="M32 10c-4 4-4 8 0 12 4 4 4 8 0 12-4 4-4 8 0 12" stroke="#c7d2fe" stroke-width="3" fill="none" stroke-linecap="round"/>' +
      '  <circle cx="32" cy="50" r="3" fill="#c7d2fe"/>' +
      '</svg>'
    );
  }

  // ========================= ДАННЫЕ ТОЛЬКО ИЗ API ===========================
  function normalizeFlavorRecord(f){
    const brand = String(f?.brand || '').trim();
    const name  = String(f?.name  || '').trim();
    const id = String((f && (f._id || f.id)) || (brand+'-'+name).toLowerCase().replace(/\s+/g,'-')).trim();
    const tags = Array.isArray(f?.tags)
      ? f.tags
      : (f?.tags ? String(f.tags).split(',').map(s=>s.trim()).filter(Boolean) : undefined);
    const strength10 = (Number.isFinite(f?.strength10) ? Number(f.strength10)
                      : Number.isFinite(f?.strength)   ? Number(f.strength) : undefined);
    const description = f?.description ? String(f.description) : undefined;
    return { id, brand, name, description, tags, strength10 };
  }

  async function loadFlavors(){
    try{
      const r = await api('/api/flavors');
      if (r.ok){
        const data = await r.json();
        state.flavors = Array.isArray(data) ? data.map(normalizeFlavorRecord) : [];
        state.activeBrand = state.activeBrand || (state.flavors[0]?.brand) || "";
        return;
      }
    }catch(_){}
    state.flavors = [];
  }

  async function loadGuestMixes(){
    try{
      const r = await api('/api/mixes');
      if (r.ok){
        const arr = await r.json();
        state.guestMixes = Array.isArray(arr) ? arr : [];
        state.guestMixes.sort((a,b)=>(b?.createdAt||0)-(a?.createdAt||0));
      } else {
        state.guestMixes = [];
      }
    }catch(_){ state.guestMixes = []; }
  }

  // ========================= FLAVORS API HELPERS =============================
  const flavorsApi = {
    async create(payload, token){
      const r = await api('/api/flavors', {
        method: 'POST',
        headers: { 'X-Admin-Token': token || '' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('Не удалось добавить вкус: '+(await r.text().catch(()=>r.status)));
      return true;
    },
    async removeByBrandName(brand, name, token){
      const r = await api('/api/flavors', {
        method: 'POST',
        headers: { 'X-Admin-Token': token || '' },
        body: JSON.stringify({ action:'delete', brand: String(brand).trim(), name: String(name).trim() })
      });
      if (!r.ok) throw new Error('Удаление вкуса не удалось: '+(await r.text().catch(()=>r.status)));
      return true;
    }
  };

  // ========================= УДАЛЕНИЕ ВКУСА (как было) ======================
  async function deleteFlavorOnServer(flavorId, token){
    let fl = (state.flavors || []).find(f => f && f.id === flavorId);
    if (!fl) { await loadFlavors(); fl = (state.flavors || []).find(f => f && f.id === flavorId); }
    if (!fl || !fl.brand || !fl.name) throw new Error('Не удалось определить brand/name для вкуса "'+flavorId+'". Обновите список вкусов.');
    return flavorsApi.removeByBrandName(String(fl.brand).trim(), String(fl.name).trim(), token);
  }

  // ========================= УДАЛЕНИЕ МИКСА (добавлен админ-путь) ===========
  async function deleteMixOnServer(id, user){
    const uid = String(user && user.id || '');

    // НОВОЕ: если есть админ-токен — сначала пробуем удалить как админ,
    // ТЕМ ЖЕ ПУТЁМ, как вы удаляете вкусы (POST /api/mixes {action:'delete',id})
    try{
      const adminToken =
        (state && state.adminToken) ||
        localStorage.getItem('admin_token') ||
        localStorage.getItem('adminToken') || '';

      if (adminToken && adminToken.length >= 6) {
        const r = await api('/api/mixes', {
          method:'POST',
          headers: { 'X-Admin-Token': adminToken, 'Content-Type':'application/json' },
          body: JSON.stringify({ action:'delete', id: String(id) })
        });
        if (r && r.ok) return true;
      }
    }catch(_){}

    // Старые пути — автор удаляет свой
    const headers = { 'X-Author-Id': uid, 'X-User-Id': uid };

    // 1) DELETE /api/mixes/:id
    let t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 2) DELETE /api/mixes/:id?authorId=...
    t = await api('/api/mixes/'+encodeURIComponent(id)+'?authorId='+encodeURIComponent(uid), { method:'DELETE', headers }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 3) POST /api/mixes/delete { id, authorId }
    t = await api('/api/mixes/delete', { method:'POST', headers, body: JSON.stringify({ id, authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 4) POST override
    t = await api('/api/mixes/'+encodeURIComponent(id)+'?_method=DELETE', { method:'POST', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 5) DELETE с body
    t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    let status = t ? t.status : 'нет ответа';
    let body = '';
    try {
      const ct = t && t.headers ? (t.headers.get('content-type')||'') : '';
      body = t ? (ct.includes('json') ? JSON.stringify(await t.json()) : await t.text()) : '';
    } catch(_) {}
    throw new Error('Удаление микса не удалось: ' + status + (body ? ' — ' + body : ''));
  }

  // ========================= ПОИСК ==========================================
  function filterFlavorsByQueryAdv(flavors, query){
    function normalize(s){ return String(s||'').toLowerCase().replace(/ё/g,'е').trim(); }
    var q = normalize(query);
    if(!q) return flavors||[];
    var SYN = {"киви":["kiwi"],"банан":["banana"],"манго":["mango"],"лимон":["lemon","citrus"],"апельсин":["orange"],"грейпфрут":["grapefruit"],"арбуз":["watermelon"],"дыня":["melon"],"виноград":["grape"],"персик":["peach"],"яблок":["apple"],"маракуй":["passion"],"клубник":["strawberry"],"черник":["blueberry"],"мята":["mint"],"лед":["ice","freeze","frost","cold"],"ваниль":["vanilla"],"печень":["cookie","bisc"],"шоколад":["choco","chocolate"],"кисл":["sour"],"слад":["sweet"]};
    var tokens = q.split(/\s+/).filter(Boolean);
    function textOf(f){ return normalize([f && f.name, f && f.description, Array.isArray(f && f.tags)? (f.tags.join(' ')) : '' ].join(' ')); }
    return (flavors||[]).filter(function(f){
      var text = textOf(f);
      return tokens.every(function(t){
        var vars = new Set([t]);
        Object.keys(SYN).forEach(function(k){ if(k.indexOf(t)>-1) SYN[k].forEach(function(x){vars.add(x);}); });
        return Array.from(vars).some(function(v){ return text.indexOf(v)>-1; });
      });
    });
  }

  // ========================= РЕНДЕР (без изменений) =========================
  function render(){
    var root = document.getElementById('root');
    if(!root) return;

    var brands = Array.from(new Set((state.flavors||[]).map(function(f){return f.brand;}))).filter(Boolean).sort();
    var flavorsOfActive = (state.flavors||[]).filter(function(f){return normalizeBrand(f.brand)===state.activeBrand;});
    var searchedFlavors = filterFlavorsByQueryAdv(state.flavors, state.search);
    var listFlavors = state.search ? searchedFlavors : flavorsOfActive;
    var total = percentSum(state.parts);

    var mixStrength10 = (function(parts, flavors){
      if(!Array.isArray(parts)||!Array.isArray(flavors)) return null;
      var t=percentSum(parts); if(!parts.length||t<=0) return null;
      var w=0; for(var i=0;i<parts.length;i++){
        var p=parts[i]; var pr=safePercent(p && p.percent); if(pr<=0) continue;
        var fl=flavors.find(function(x){return x && x.id===(p && p.flavorId);}); if(!fl) continue;
        w += getStrength10(fl) * (pr/t);
      }
      return w? Math.round(w*10)/10 : null;
    })(state.parts, state.flavors);
    var mixTaste = getMixTasteLabel(state.parts, state.flavors);

    var strengthBadge='';
    if(typeof mixStrength10==='number'){
      var c=strengthColor(mixStrength10);
      strengthBadge='<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+mixStrength10.toFixed(1)+'</span>';
    }

    var brandsHTML = brands.map(function(b){
      return '<button data-brand="'+escAttr(b)+'" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeBrand===b?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">'+escHTML(b)+'</button>';
    }).join('');

    var flavorsHTML = listFlavors.map(function(f){
      var inMix = state.parts.some(function(p){return p.flavorId===f.id;});
      var s = getStrength10(f);
      var c = strengthColor(s);
      var desc = f.description ? '<div class="text-[11px] text-slate-400 truncate">'+escHTML(f.description)+'</div>' : '';
      return (
        '<div class="flex items-center justify-between gap-2 text-sm">' +
          '<div class="min-w-0">' +
            '<div class="flex items-center gap-2">' +
              '<div class="font-medium truncate" title="'+escAttr((f.brand||'')+' • '+(f.name||''))+'">'+escHTML(f.name)+' <span class="opacity-60">('+escHTML(f.brand)+')</span></div>' +
              '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+s.toFixed(1)+'</span>' +
            '</div>' +
            desc +
          '</div>' +
          '<button data-add="'+escAttr(f.id)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] '+(inMix?'opacity-50 cursor-not-allowed border border-slate-700':'border border-slate-700 hover:bg-slate-800')+'">'+(inMix?'✓':'+')+'</button>' +
        '</div>'
      );
    }).join('');

    var partsHTML = state.parts.map(function(p){
      var fl = state.flavors.find(function(x){return x.id===p.flavorId;});
      var name = (fl && fl.name) || p.flavorId;
      return (
        '<div class="flex items-center gap-2 text-sm">' +
          '<span class="truncate w-36" title="'+escAttr(name)+'">'+escHTML(name)+'</span>' +
          '<input type="range" min="0" max="100" step="5" class="w-28" value="'+safePercent(p.percent)+'" data-range="'+escAttr(p.flavorId)+'"/>' +
          '<span class="w-10 text-right" data-percent-for="'+escAttr(p.flavorId)+'">'+safePercent(p.percent)+'%</span>' +
          '<button data-remove="'+escAttr(p.flavorId)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] hover:bg-slate-800">Удалить</button>' +
        '</div>'
      );
    }).join('');

    var guestHTML = state.guestMixes.map(function(m){
      var c = typeof m.strength10==='number' ? strengthColor(m.strength10) : strengthColor(null);
      var sBadge = typeof m.strength10==='number' ? '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+m.strength10.toFixed(1)+'</span>' : '';
      var tBadge = m.taste ? '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(m.taste)+'</span>' : '';
      var notes = m.notes ? ('<div class="text-[11px] text-slate-400">'+escHTML(m.notes)+'</div>') : '';
      var parts = Array.isArray(m.parts) ? m.parts.map(function(p){
        var fl = state.flavors.find(function(x){return x.id===(p && p.flavorId);});
        var label = (fl && fl.name) || (p && p.flavorId) || '';
        return '<div class="text-[12px] text-slate-300">'+escHTML(label)+' — <b>'+safePercent(p && p.percent)+'%</b></div>';
      }).join('') : '';
      return (
        '<div class="rounded-2xl border border-slate-800 bg-slate-900 p-3 space-y-2">' +
          '<div class="flex items-center justify-between gap-2">' +
            '<div class="min-w-0">' +
              '<div class="flex items-center gap-2">' +
                '<div class="font-semibold truncate">'+escHTML(m.title||'Микс')+'</div>' +
                sBadge + tBadge +
              '</div>' +
              '<div class="text-[11px] text-slate-400 truncate">Автор: '+escHTML(m.author||'Гость')+'</div>' +
            '</div>' +
            '<button data-del="'+escAttr(m.id)+'" class="inline-flex items-center justify-center rounded-xl h-7 px-2 text-[11px] border border-rose-700 text-rose-300 hover:bg-rose-900/40">Удалить</button>' +
          '</div>' +
          notes +
          '<div class="mt-1 space-y-0.5">'+parts+'</div>' +
        '</div>'
      );
    }).join('');

    const headerHTML =
      '<header class="flex items-center justify-between">' +
        '<div class="flex items-center gap-2 min-w-0">'+LogoSVG()+'<h1 class="text-lg font-bold truncate">Hookah Mixes</h1></div>' +
        '<div class="flex items-center gap-2">' +
          '<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">Здравствуйте, '+escHTML(state.user && state.user.name ? state.user.name : 'Гость')+'</span>' +
          '<button data-tab="builder" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeTab==='builder'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">Конструктор</button>' +
          '<button data-tab="guest" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeTab==='guest'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">Миксы гостей</button>' +
          (isAdmin()?('<button data-tab="admin" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeTab==='admin'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">Админ</button>'):'') +
        '</div>' +
      '</header>';

    const brandsBlock =
      '<div class="rounded-2xl border border-slate-800 bg-slate-900">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">Бренды</div></div>' +
        '<div class="p-3 space-y-2">' +
          '<div class="space-y-2">' +
            '<input id="search" placeholder="Поиск вкуса по названию…" value="'+escAttr(state.search||'')+'" class="h-9 w-full rounded-xl border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 px-3 text-sm outline-none focus:ring-2 focus:ring-slate-600" />' +
            '<div class="grid grid-cols-2 gap-1">'+brandsHTML+(brands.length===0?'<div class="text-[12px] text-slate-400">Нет брендов (добавьте вкусы)</div>':'')+'</div>' +
          '</div>' +
          '<div id="flavorsMeta" class="text-[11px] text-slate-400">'+(state.search ? ('Найдено: '+listFlavors.length) : (state.activeBrand ? ('Вкусы бренда: '+escHTML(state.activeBrand)) : ''))+'</div>' +
          '<div id="flavorsList">'+flavorsHTML+(listFlavors.length===0?('<div class="text-[12px] text-slate-400">'+(state.search?'Ничего не найдено':'Нет вкусов для этого бренда')+'</div>'):'')+'</div>' +
        '</div>' +
      '</div>';

    const mixBlock =
      '<div class="rounded-2xl border border-slate-800 bg-slate-900" id="mixBlock">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">Микс</div></div>' +
        '<div class="p-3 space-y-2">' +
          (state.parts.length===0?'<div class="text-[12px] text-slate-400">Добавьте вкусы из списка</div>':'') +
          partsHTML +
          '<div class="flex items-center justify-between text-[12px]">' +
            '<span>Итог: <b id="mixTotal">'+total+'</b>%</span>' +
            '<div class="flex items-center gap-2"><span id="mixStrength">'+strengthBadge+'</span><span id="mixTaste">'+(mixTaste?('<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(mixTaste)+'</span>'):'')+'</span></div>' +
          '</div>' +
        '</div>' +
      '</div>';

    const builder =
      '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">' + brandsBlock + mixBlock + '</div>' +
      '<div class="rounded-2xl border border-slate-800 bg-slate-900 p-3 mt-3 space-y-2">' +
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-2">' +
          '<input id="title" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="Название микса" />' +
          '<input id="notes" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="Заметки (необязательно)" />' +
        '</div>' +
        '<div class="flex gap-2">' +
          '<button id="saveMix" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] bg-slate-100 text-slate-900 hover:bg-white">Сохранить микс</button>' +
          '<button id="goGuest" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-slate-700 hover:bg-slate-800">Перейти к миксам гостей</button>' +
        '</div>' +
      '</div>';

    const guest =
      '<div class="space-y-2">' +
        (state.guestMixes.length?guestHTML:'<div class="text-[12px] text-slate-400">Пока миксов нет</div>') +
      '</div>';

    const adminBlock = (
      '<div class="rounded-2xl border border-slate-800 bg-slate-900 p-3 space-y-2">' +
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-2">' +
        '  <input id="admBrand" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="Бренд" />' +
        '  <input id="admName"  class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="Название" />' +
        '  <input id="admTags"  class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="Теги (через запятую)" />' +
        '  <input id="admStrength" type="number" min="1" max="10" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="Крепость 1–10 (необязательно)" />' +
        '  <textarea id="admDesc" class="min-h-[72px] rounded-xl border border-slate-700 bg-slate-900 px-3 py-2" placeholder="Описание (необязательно)"></textarea>' +
        '</div>' +
        '<div class="flex gap-2">' +
        '  <button id="admAddFlavor" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] bg-slate-100 text-slate-900 hover:bg-white">Добавить вкус</button>' +
        '  <button id="admReload"    class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-slate-700 hover:bg-slate-800">Обновить список</button>' +
        '  <button id="admClearToken" class="ml-auto inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-rose-700 text-rose-300 hover:bg-rose-900/40">Выйти из админки</button>' +
        '</div>' +
        '<div><div class="text-xs font-semibold mb-2">Все вкусы</div><div id="admFlavorList" class="space-y-1"></div></div>' +
      '</div>'
    );

    const adminLoginBlock = (!isAdmin() && state.adminPrompt) ? (
      '<div class="rounded-2xl border border-slate-800 bg-slate-900">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">Админ-доступ</div></div>' +
        '<div class="p-3 space-y-2">' +
          '<input id="admToken" class="h-9 w-full rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="Вставьте X-Admin-Token" />' +
          '<div class="flex gap-2">' +
            '<button id="admSaveToken" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] bg-slate-100 text-slate-900 hover:bg-white">Сохранить</button>' +
            '<button id="admCancel" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-slate-700 hover:bg-slate-800">Отмена</button>' +
          '</div>' +
        '</div>' +
      '</div>'
    ) : '';

    root.innerHTML =
      '<div class="max-w-3xl mx-auto p-3 md:p-6 space-y-3">'+
        headerHTML +
        '<div class="grid grid-cols-1 gap-3">' +
          (state.activeTab==='builder'? builder : state.activeTab==='guest'? guest : adminBlock) +
          adminLoginBlock +
        '</div>'+
      '</div>';

    // ==== бинды (как у вас) ====
    root.querySelectorAll('[data-brand]').forEach(function(btn){
      btn.addEventListener('click', function(){ state.activeBrand = btn.getAttribute('data-brand'); state.search=''; render(); });
    });
    var search = root.querySelector('#search'); if(search){ search.addEventListener('input', function(){ state.search = this.value; updateSearchUI(); }); }
    var titleEl = root.querySelector('#title'); if(titleEl){ titleEl.addEventListener('input', function(){ state.title=this.value; }); }
    var notesEl = root.querySelector('#notes'); if(notesEl){ notesEl.addEventListener('input', function(){ state.notes=this.value; }); }

    // кнопки вкладок
    root.querySelectorAll('[data-tab]').forEach(function(btn){ btn.addEventListener('click', function(){ state.activeTab = btn.getAttribute('data-tab'); render(); }); });

    // добавить вкус в микс
    bindAddButtons();

    // range/удаление в миксе
    attachMixEvents();

    // Сохранить микс
    var saveBtn = root.querySelector('#saveMix');
    if (saveBtn){
      saveBtn.addEventListener('click', async function(){
        if (!isMixValid(state.parts, state.title)){ alert('Соберите микс на 100% и укажите название (минимум 3 символа)'); return; }
        var mix = {
          title:String(state.title).trim(),
          parts: state.parts.slice(),
          notes:String(state.notes||'').trim(),
          author: state.user.name || 'Гость',
          authorId: state.user.id || null,
          createdAt: Date.now(),
          taste: getMixTasteLabel(state.parts, state.flavors) || null,
          strength10: (function(){ var t=percentSum(state.parts); if(!t) return null; var w=0; for(var i=0;i<state.parts.length;i++){ var p=state.parts[i]; var pr=safePercent(p.percent); if(pr<=0) continue; var fl=state.flavors.find(function(x){return x && x.id===p.flavorId;}); if(!fl) continue; w+=getStrength10(fl)*(pr/t);} return w?Math.round(w*10)/10:null; })()
        };

        try{
          var r=await api('/api/mixes',{method:'POST',body:JSON.stringify(mix)});
          if(!r.ok){ alert('Не удалось сохранить микс ('+r.status+'): '+(await r.text().catch(()=>''))); return; }
          await loadGuestMixes();
          state.title=''; state.notes=''; state.parts=[]; state.activeTab='guest';
          render();
        }catch(e){
          console.error(e); alert('Ошибка сети при сохранении');
        }
      });
    }
    var goGuest = root.querySelector('#goGuest'); if (goGuest) { goGuest.addEventListener('click', function(){ state.activeTab='guest'; render(); }); }

    // Удаление микса (кнопки на карточках)
    root.querySelectorAll('[data-del]').forEach(function(btn){
      btn.addEventListener('click', async function(){
        const id = btn.getAttribute('data-del');
        if (!id) return;
        if (!confirm('Удалить микс?')) return;
        try{
          await deleteMixOnServer(id, state.user);
          await loadGuestMixes();
          render();
        }catch(e){
          console.error(e); alert((e && e.message) ? e.message : 'Ошибка удаления');
        }
      });
    });

    // Админ-доступ (сохранить/скрыть)
    var tokBtn = root.querySelector('#admSaveToken');
    if (tokBtn){
      tokBtn.addEventListener('click', function(){
        var v = (root.querySelector('#admToken')||{}).value || '';
        try{ localStorage.setItem('admin_token', v); }catch(_){}
        state.adminToken = v || "";
        state.adminPrompt = false;
        state.activeTab = 'admin';
        render();
      });
    }
    var tokCancel = root.querySelector('#admCancel');
    if (tokCancel){
      tokCancel.addEventListener('click', function(){ state.adminPrompt = false; render(); });
    }

    // Админ-вкладка
    if (isAdmin() && state.activeTab === 'admin'){
      buildAdminFlavorList(root);

      var btnReload = root.querySelector('#admReload');
      if (btnReload){
        btnReload.addEventListener('click', async function(){
          await loadFlavors();
          state.activeBrand = state.activeBrand || (state.flavors[0] && state.flavors[0].brand) || '';
          render();
        });
      }
      var btnLogout = root.querySelector('#admClearToken');
      if (btnLogout){
        btnLogout.addEventListener('click', function(){
          try{ localStorage.removeItem('admin_token'); }catch(_){}
          state.adminToken = "";
          state.activeTab = 'builder';
          render();
        });
      }
      var btnAdd = root.querySelector('#admAddFlavor');
      if (btnAdd){
        btnAdd.addEventListener('click', async function(){
          var brand = (root.querySelector('#admBrand')||{}).value||'';
          var name  = (root.querySelector('#admName')||{}).value||'';
          var tags  = (root.querySelector('#admTags')||{}).value||'';
          var desc  = (root.querySelector('#admDesc')||{}).value||'';
          var str10 = (root.querySelector('#admStrength')||{}).value||'';
          if (!brand.trim() || !name.trim()){ alert('Укажите бренд и название'); return; }
          var payload = {
            id: (brand.trim()+'-'+name.trim()).replace(/\s+/g,'-').toLowerCase(),
            brand: brand.trim(),
            name: name.trim(),
            description: desc.trim() || undefined,
            tags: tags ? tags.split(',').map(function(s){return s.trim();}).filter(Boolean) : undefined,
            strength10: str10 ? Number(str10) : undefined
          };
          try{
            var r = await api('/api/flavors', {
              method:'POST',
              headers: { 'X-Admin-Token': state.adminToken || '' },
              body: JSON.stringify(payload)
            });
            if (!r.ok){
              var txt = await r.text().catch(function(){return '';});
              alert('Не удалось добавить ('+r.status+'): '+txt);
              return;
            }
            await loadFlavors();
            state.activeBrand = state.activeBrand || (state.flavors[0] && state.flavors[0].brand) || '';
            render();
          }catch(e){
            console.error(e); alert('Ошибка сети при добавлении вкуса');
          }
        });
      }
    }
  }

  // Построение списка вкусов в админке + удаление (как было)
  function buildAdminFlavorList(root){
    var list = root.querySelector('#admFlavorList');
    if (!list) return;
    var byBrand = {};
    (state.flavors||[]).forEach(function(f){
      var b = (f.brand||'').trim() || 'Без бренда';
      (byBrand[b]||(byBrand[b]=[])).push(f);
    });

    var html = Object.keys(byBrand).sort().map(function(brand){
      var rows = byBrand[brand].sort(function(a,b){ return a.name.localeCompare(b.name, 'ru'); })
        .map(function(f){
          return (
            '<div class="flex items-center justify-between gap-2 text-[12px] border border-slate-800 rounded-lg px-2 py-1">' +
              '<div class="min-w-0 truncate"><span class="opacity-70">'+escHTML(brand)+'</span> • '+escHTML(f.name)+'</div>' +
              '<button data-del-flavor="'+escAttr(f.id)+'" class="inline-flex items-center justify-center h-7 px-2 rounded-md border border-rose-700 text-rose-300 hover:bg-rose-900/40">Удалить</button>' +
            '</div>'
          );
        }).join('');
      return (
        '<div class="space-y-1">' +
          '<div class="text-[11px] uppercase tracking-wide text-slate-400">'+escHTML(brand)+'</div>' +
          rows +
        '</div>'
      );
    }).join('') || '<div class="text-[12px] text-slate-400">Пока нет вкусов</div>';
    list.innerHTML = html;

    root.querySelectorAll('[data-del-flavor]').forEach(function(btn){
      btn.addEventListener('click', async function(){
        var id = btn.getAttribute('data-del-flavor');
        if (!id) return;
        if (!confirm('Удалить вкус "'+id+'"? Это действие необратимо.')) return;
        try{
          await deleteFlavorOnServer(id, state.adminToken || '');
          await loadFlavors();
          if (!state.flavors.some(function(f){ return normalizeBrand(f.brand)===state.activeBrand; })) {
            state.activeBrand = (state.flavors[0] && state.flavors[0].brand) || '';
          }
          render();
        } catch(e){
          console.error(e);
          alert('Не удалось удалить вкус. ' + (e && e.message ? e.message : ''));
        }
      });
    });
  }

  function updateMixStatsUI(){
    var total = percentSum(state.parts);
    var tEl = document.getElementById('mixTotal'); if (tEl) tEl.textContent = total;
    var strength = (function(){ var t=percentSum(state.parts); if(!t) return null; var w=0; for(var i=0;i<state.parts.length;i++){ var p=state.parts[i]; var pr=safePercent(p.percent); if(pr<=0) continue; var fl=state.flavors.find(function(x){return x && x.id===p.flavorId;}); if(!fl) continue; w+=getStrength10(fl)*(pr/t);} return w?Math.round(w*10)/10:null; })();
    var sEl = document.getElementById('mixStrength'); if(sEl){ if(typeof strength==='number'){ var c=strengthColor(strength); sEl.innerHTML = '<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+strength.toFixed(1)+'</span>'; } else { sEl.innerHTML=''; } }
    var taste = getMixTasteLabel(state.parts, state.flavors);
    var t2 = document.getElementById('mixTaste'); if(t2){ t2.innerHTML = taste ? ('<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(taste)+'</span>') : ''; }
  }

  function bindAddButtons(){
    var list = document.getElementById('flavorsList'); if(!list) return;
    Array.prototype.forEach.call(list.querySelectorAll('[data-add]'), function(btn){
      btn.addEventListener('click', function(){
        var id=this.getAttribute('data-add');
        if(!id) return; if(state.parts.some(function(p){return p.flavorId===id;})) return;
        var def=Math.min(30, Math.max(0, 100 - percentSum(state.parts)));
        state.parts = state.parts.concat([{ flavorId:id, percent:def }]);
        rerenderMixBlock();
        updateSearchUI();
      });
    });
  }

  function attachMixEvents(){
    Array.prototype.forEach.call(document.querySelectorAll('[data-range]'), function(sl){
      sl.addEventListener('input', function(){
        var id=this.getAttribute('data-range');
        var req=safePercent(this.value);
        var newParts = state.parts.map(function(p){ return p.flavorId===id ? { flavorId:p.flavorId, percent: clampPercentForPart(state.parts, id, req) } : p; });
        var newVal = newParts.find(function(p){return p.flavorId===id;}).percent;
        state.parts = newParts;
        if (newVal !== req) { this.value = newVal; }
        updateMixStatsUI();
        var span = document.querySelector('[data-percent-for="'+id+'"]');
        if(span) span.textContent = newVal + '%';
      });
    });
    Array.prototype.forEach.call(document.querySelectorAll('[data-remove]'), function(btn){
      btn.addEventListener('click', function(){ var id=this.getAttribute('data-remove'); state.parts = state.parts.filter(function(p){return p.flavorId!==id;}); rerenderMixBlock(); });
    });
  }

  function rerenderMixBlock(){
    var container = document.getElementById('mixBlock'); if(!container) return;
    var total = percentSum(state.parts);
    var strength = (function(){ var t=percentSum(state.parts); if(!t) return null; var w=0; for(var i=0;i<state.parts.length;i++){ var p=state.parts[i]; var pr=safePercent(p.percent); if(pr<=0) continue; var fl=state.flavors.find(function(x){return x && x.id===p.flavorId;}); if(!fl) continue; w+=getStrength10(fl)*(pr/t);} return w?Math.round(w*10)/10:null; })();
    var strengthBadge=''; if(typeof strength==='number'){ var c=strengthColor(strength); strengthBadge='<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+strength.toFixed(1)+'</span>'; }
    var mixTaste = getMixTasteLabel(state.parts, state.flavors);
    var partsHTML = state.parts.map(function(p){ var fl = state.flavors.find(function(x){return x.id===p.flavorId;}); var name=(fl && fl.name)||p.flavorId; return (
      '<div class="flex items_center gap-2 text-sm">'.replace('items_center','items-center') +
        '<span class="truncate w-36" title="'+escAttr(name)+'">'+escHTML(name)+'</span>' +
        '<input type="range" min="0" max="100" step="5" class="w-28" value="'+safePercent(p.percent)+'" data-range="'+escAttr(p.flavorId)+'"/>' +
        '<span class="w-10 text-right" data-percent-for="'+escAttr(p.flavorId)+'">'+safePercent(p.percent)+'%</span>' +
        '<button data-remove="'+escAttr(p.flavorId)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] hover:bg-slate-800">Удалить</button>' +
      '</div>'
    ); }).join('');
    var html =
      '<div class="px-3 pt-3"><div class="text-xs font-semibold">Микс</div></div>' +
      '<div class="p-3 space-y-2">' +
        (state.parts.length===0?'<div class="text-[12px] text-slate-400">Добавьте вкусы из списка</div>':'') +
        partsHTML +
        '<div class="flex items-center justify-between text-[12px]">' +
          '<span>Итог: <b id="mixTotal">'+total+'</b>%</span>' +
          '<div class="flex items-center gap-2"><span id="mixStrength">'+strengthBadge+'</span><span id="mixTaste">'+(mixTaste?('<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(mixTaste)+'</span>'):'')+'</span></div>' +
        '</div>' +
      '</div>';
    container.innerHTML = html;
    attachMixEvents();
  }

  function updateSearchUI(){
    var meta = document.getElementById('flavorsMeta');
    var list = document.getElementById('flavorsList');
    if(!meta || !list) return;
    var flavorsOfActive = (state.flavors||[]).filter(function(f){return normalizeBrand(f.brand)===state.activeBrand;});
    var searchedFlavors = filterFlavorsByQueryAdv(state.flavors, state.search);
    var listFlavors = state.search ? searchedFlavors : flavorsOfActive;
    meta.textContent = state.search ? ('Найдено: '+listFlavors.length) : (state.activeBrand ? ('Вкусы бренда: '+state.activeBrand) : '');
    list.innerHTML = listFlavors.map(function(f){
      var inMix = state.parts.some(function(p){return p.flavorId===f.id;});
      var s = getStrength10(f); var c = strengthColor(s);
      var desc = f.description ? '<div class="text-[11px] text-slate-400 truncate">'+escHTML(f.description)+'</div>':'';
      return (
        '<div class="flex items-center justify-between gap-2 text-sm">' +
          '<div class="min-w-0">' +
            '<div class="flex items-center gap-2">' +
              '<div class="font-medium truncate" title="'+escAttr((f.brand||'')+' • '+(f.name||''))+'">'+escHTML(f.name)+' <span class="opacity-60">('+escHTML(f.brand)+')</span></div>' +
              '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+s.toFixed(1)+'</span>' +
            '</div>' +
            desc +
          '</div>' +
          '<button data-add="'+escAttr(f.id)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] '+(inMix?'opacity-50 cursor-not-allowed border border-slate-700':'border border-slate-700 hover:bg-slate-800')+'">'+(inMix?'✓':'+')+'</button>' +
        '</div>'
      );
    }).join('') + (listFlavors.length===0?('<div class="text-[12px] text-slate-400">'+(state.search?'Ничего не найдено':'Нет вкусов для этого бренда')+'</div>'):'');
    bindAddButtons();
  }

  // ========================= СТАРТ (как у вас) ==============================
  (async function start(){
    try{
      initAuth();
      await detectLogo();
      await loadFlavors();
      await loadGuestMixes();
      render();

      // Периодический пулл миксов (как было)
      setInterval(async function(){
        const before = JSON.stringify(state.guestMixes?.map(function(m){return m.id;}));
        await loadGuestMixes();
        const after  = JSON.stringify(state.guestMixes?.map(function(m){return m.id;}));
        if (before !== after) render();
      }, 10000);
    }catch(e){ console.error(e); }
  })();

  // ========================= SMOKE TESTS (как было) =========================
  ;(function(){ try{
    console.group('HookahMixes – smoke tests');
    {var p1=[{flavorId:'a',percent:60},{flavorId:'b',percent:40}]; console.assert(percentSum(p1)===100,'sum=100');}
    {var p2=[{flavorId:'a',percent:60},{flavorId:'b',percent:30}]; console.assert(percentSum(p2)===90,'sum=90');}
    {var ok=isMixValid([{flavorId:'a',percent:60},{flavorId:'b',percent:40}], 'Mix'); console.assert(ok===true,'valid=100+title');}
    {var cl=clampPercentForPart([{flavorId:'a',percent:90},{flavorId:'b',percent:0}], 'b', 20); console.assert(cl===10,'clamp remaining');}
    {var cl2=clampPercentForPart([{flavorId:'a',percent:50}], 'a', 150); console.assert(cl2===100,'clamp max');}
    {var r=filterFlavorsByQueryAdv([{id:'1',name:'Mango'},{id:'2',name:'Ice'},{id:'3',name:'Ice Mango'}], 'mango'); console.assert(r.length===2,'search across brands');}
    {var t=getMixTasteLabel([],[]); console.assert(t===null,'taste null');}
    {var cl3=clampPercentForPart([{flavorId:'a',percent:10}], 'a', -5); console.assert(cl3===0,'clamp to 0');}
    console.groupEnd();
  }catch(e){ console.error('Smoke tests error', e); }})();
  </script>
</body>
</html>
