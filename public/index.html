<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#020617" />
  <title>Hookah Mixes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{background:#020617}</style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Ранний экран ошибок -->
  <script>
    (function(){
      function showFatal(msg){
        var root = document.getElementById('root');
        if (!root) return;
        root.innerHTML =
          '<div class="min-h-[100svh] flex items-center justify-center p-6">' +
          '  <div class="max-w-md w-full rounded-xl border border-rose-800 bg-rose-950 p-4 text-sm">' +
          '    <div class="font-semibold text-rose-200 mb-1">Критическая ошибка</div>' +
          '    <div class="text-rose-300/90">'+String(msg||'Unknown')+'</div>' +
          '  </div>' +
          '</div>';
      }
      window.__fatal = showFatal;
      window.addEventListener('error', function(e){
        try{ showFatal(e && e.error && e.error.message || e.message || 'Unexpected error'); }catch(_){}
      });
    })();
  </script>
</head>
<body class="text-slate-100 selection:bg-indigo-400/30 selection:text-indigo-50">
  <div id="root"></div>

  <script>
  (function(){
    "use strict";

    // ========================= УТИЛИТЫ =========================
    const API_BASE = "https://hookhah.onrender.com";
    const qs = (sel, root=document)=> root.querySelector(sel);
    const qsa = (sel, root=document)=> Array.prototype.slice.call(root.querySelectorAll(sel));
    const escHTML = (s)=> String(s==null?'':s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const escAttr = escHTML;
    const clamp = (v, a, b)=> Math.max(a, Math.min(b, v));
    const safePercent = (n)=> (Math.round((Number(n)||0)*10)/10).toFixed(1).replace(/\.0$/,'');
    const nowIso = ()=> (new Date()).toISOString();
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

    const api = async (path, opt)=>{
      const url = (path.startsWith('http')? path : (API_BASE + path));
      const resp = await fetch(url, Object.assign({
        headers: { 'Content-Type':'application/json' },
        credentials: 'omit',
        mode: 'cors',
      }, opt||{}));
      return resp;
    };

    function uuidv4(){
      // простая генерация UUIDv4
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c){
        var r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    function byId(a){ return String(a && a.id || ''); }
    function byCreatedDesc(a,b){ return String(b.createdAt||'') > String(a.createdAt||'') ? 1 : -1; }

    function parseCommaOrArray(v){
      if (!v) return [];
      if (Array.isArray(v)) return v.map(String);
      return String(v).split(',').map(s=>s.trim()).filter(Boolean);
    }

    // ========================= ГЛОБАЛЬНОЕ СОСТОЯНИЕ =========================
    const qp = new URLSearchParams(location.search);
    const state = {
      flavors: [],
      guestMixes: [],
      filteredBrand: '',
      search: '',
      builder: {
        title: '',
        parts: [], // { flavorId, percent }
        notes: '',
      },
      activeTab:"builder",
      user:null,
      showSplash:false,
      logoUrl:null,
      adminToken: (localStorage.getItem('admin_token') || ""),
      adminPrompt: qp.get('admin') === '1'
    };
    const isAdmin=()=> !!(state.adminToken && state.adminToken.length>=6);

    // ========================= ИНИЦИАЛИЗАЦИЯ =========================
    async function initUser(){
      // Пытаемся взять пользователя из Telegram WebApp
      try{
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
          const u = Telegram.WebApp.initDataUnsafe.user;
          state.user = {
            id: String(u.id),
            name: (u.first_name||'') + (u.last_name?(' '+u.last_name):'')
          };
          return;
        }
      }catch(_){}
      // fallback гость
      state.user = {
        id: 'guest-'+Math.random().toString(36).slice(2,8),
        name: 'Гость'
      };
    }

    async function loadFlavors(){
      const r = await api('/api/flavors', { method:'GET' });
      const list = await r.json();
      state.flavors = (Array.isArray(list)? list : []).map(normalizeFlavorRecord);
    }

    function normalizeFlavorRecord(f){
      return {
        id: byId(f),
        brand: String(f.brand||'').trim(),
        name: String(f.name||'').trim(),
        description: String(f.description||'').trim(),
        tags: parseCommaOrArray(f.tags),
        strength10: Number(f.strength10||0)
      };
    }

    async function loadGuestMixes(){
      const r = await api('/api/mixes', { method:'GET' });
      const list = await r.json();
      state.guestMixes = (Array.isArray(list)? list : []).sort(byCreatedDesc);
    }

    function percentSum(parts){
      return (parts||[]).reduce((s,p)=> s + (Number(p && p.percent || 0)||0), 0);
    }

    function clampPercentForPart(parts, idx, newPercent){
      newPercent = clamp(Number(newPercent)||0, 0, 100);
      const copy = (parts||[]).map(p=>({flavorId:p.flavorId, percent:Number(p.percent)||0}));
      const diff = newPercent - (copy[idx] ? copy[idx].percent : 0);
      if (diff <= 0) { // уменьшение — просто применяем
        if (copy[idx]) copy[idx].percent = newPercent;
        return copy;
      }
      // увеличение — нужно срезать у других
      let remain = diff;
      for (let i=0;i<copy.length;i++){
        if (i===idx) continue;
        const take = Math.min(copy[i].percent, remain);
        copy[i].percent -= take;
        remain -= take;
        if (remain <= 0) break;
      }
      copy[idx].percent += (diff - remain);
      copy[idx].percent = clamp(copy[idx].percent, 0, 100);
      return copy;
    }

    function computeStrength10(parts){
      // среднее по шкале 1..10 на основе strength10 вкусов
      let s = 0, w = 0;
      for (const p of (parts||[])){
        const f = state.flavors.find(x=> byId(x)===String(p.flavorId));
        if (!f) continue;
        const wgt = Number(p.percent)||0;
        s += (Number(f.strength10)||0) * wgt;
        w += wgt;
      }
      if (w<=0) return 0;
      return Math.round(s / w);
    }

    function getMixTasteLabel(parts){
      // простая эвристика по тегам/названиям
      const names = (parts||[]).map(p=>{
        const f = state.flavors.find(x=> byId(x)===String(p.flavorId));
        return f ? (f.brand+' '+f.name) : '';
      }).join(' ').toLowerCase();
      const T = [
        ['мята','mint','ice','лед','cold','freeze','frost','cool','iceberg','ice-','-ice'],
        ['цитрус','лимон','лайм','lemon','lime','citrus','orange','мандарин','апельсин'],
        ['ягод','berry','вишн','клубн','straw','rasp','blueb','blackb','смород','черник'],
        ['фрукт','fruit','манго','mango','ананас','pine','персик','peach','арбуз','melon','дын'],
        ['десерт','vanilla','шоколад','choco','ирис','карам','десерт','бисквит','крем'],
        ['специи','прян','spice','корица','ginger','имбирь','гвоздик','anis']
      ];
      for (const group of T){
        for (const k of group){
          if (names.includes(k)) return group[0];
        }
      }
      return '';
    }

    // ========================= РЕНДЕР =========================
    function render(){
      const root = document.getElementById('root');
      if (!root) return;

      const brands = Array.from(new Set(state.flavors.map(f=> f.brand))).sort((a,b)=> a.localeCompare(b,'ru'));
      const search = String(state.search||'').trim().toLowerCase();
      const filtered = state.flavors.filter(f=>{
        if (state.filteredBrand && f.brand !== state.filteredBrand) return false;
        if (search){
          const hay = (f.brand+' '+f.name+' '+(f.description||'')+' '+(f.tags||[]).join(',')).toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });

      const activeTab = state.activeTab;

      const tabsHtml =
        '<div class="flex items-center gap-2">' +
          '<button data-tab="builder" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(activeTab==='builder'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">Микс</button>' +
          '<button data-tab="guests" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(activeTab==='guests'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">Миксы гостей</button>' +
          (isAdmin()?('<button data-tab="admin" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(activeTab==='admin'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">Админ</button>'):'') +
        '</div>';

      // === TAB: BUILDER ===
      const parts = state.builder.parts;
      const partsHtml = (parts||[]).map((p, idx)=>{
        const f = state.flavors.find(x=> byId(x)===String(p.flavorId));
        return (
          '<div class="flex items-center gap-2 border border-slate-800 rounded-xl p-2">' +
            '<div class="min-w-0 flex-1">' +
              '<div class="text-sm truncate">'+escHTML(f? (f.brand+' • '+f.name) : p.flavorId)+'</div>' +
              '<input type="range" min="0" max="100" step="1" value="'+escAttr((Number(p.percent)||0))+'" data-idx="'+idx+'" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer" />' +
            '</div>' +
            '<div class="text-sm w-12 text-right">'+safePercent(p.percent)+'%</div>' +
            '<button class="rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-50 text-[12px] h-8 px-2" data-rm="'+idx+'">Убрать</button>' +
          '</div>'
        );
      }).join('');

      const strength10 = computeStrength10(parts);
      const tasteLabel = getMixTasteLabel(parts);

      let guestsHtml = '';
      if (activeTab === 'guests'){
        guestsHtml = (state.guestMixes||[]).map(m=>{
          const inner = (m.parts||[]).map(pp=>{
            const fl = state.flavors.find(x=> byId(x)===String(pp.flavorId));
            return '<div class="flex items-center gap-2"><span class="truncate mr-2">'+escHTML(fl?fl.name:pp.flavorId)+'</span><span class="opacity-70">'+safePercent(pp.percent)+'%</span></div>';
          }).join('');
          var canDelete = !!((state.user && (m.authorId && String(m.authorId)===String(state.user.id))) || isAdmin());
          var delBtn = canDelete ? '<button data-del="'+escAttr(m.id)+'" class="ml-auto inline-flex items-center justify-center rounded-lg bg-rose-900/20 border border-rose-700 text-rose-300 hover:bg-rose-900/40">Удалить</button>' : '';
          return (
            '<div class="border border-slate-800 rounded-xl p-2 text-sm">' +
              '<div class="flex items-center gap-2">' +
                '<div class="font-semibold truncate">'+escHTML(m.title)+'</div>' +
                '<div class="opacity-70 text-[12px]">'+escHTML(new Date(m.createdAt).toLocaleString())+'</div>' +
                '<div class="ml-auto opacity-80 text-[12px]">Автор: '+escHTML(m.author||'Гость')+'</div>' +
                delBtn +
              '</div>' +
              '<div class="mt-2 grid grid-cols-2 gap-2">'+inner+'</div>' +
              (m.notes?('<div class="mt-2 text-[12px] opacity-80">'+escHTML(m.notes)+'</div>'):'') +
            '</div>'
          );
        }).join('') || '<div class="text-sm text-slate-400">Пока нет миксов</div>';
      }

      // === TAB: ADMIN ===
      const adminHtml = (
        '<div class="space-y-3">' +
          '<div class="rounded-xl border border-slate-800 p-3 bg-slate-900/40">' +
            '<div class="text-[12px] opacity-80 mb-1">Админ-доступ</div>' +
            '<div class="flex items-center gap-2">' +
              '<input id="admToken" type="password" placeholder="Вставьте токен" class="flex-1 rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none" />' +
              '<button id="admSaveToken" class="rounded-lg bg-indigo-500/20 border border-indigo-700 hover:bg-indigo-500/30 h-9 px-3">Сохранить</button>' +
              (isAdmin()?'<button id="admLogout" class="rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700 h-9 px-3">Выйти</button>':'') +
            '</div>' +
          '</div>' +

          '<div class="rounded-xl border border-slate-800 p-3 bg-slate-900/40">' +
            '<div class="text-[12px] opacity-80 mb-2">Добавить вкус</div>' +
            '<div class="grid grid-cols-1 md:grid-cols-5 gap-2">' +
              '<input id="admBrand" placeholder="Бренд" class="rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none md:col-span-1" />' +
              '<input id="admName" placeholder="Название" class="rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none md:col-span-2" />' +
              '<input id="admTags" placeholder="Теги (через ,)" class="rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none md:col-span-1" />' +
              '<input id="admStrength" placeholder="Крепость 1..10" class="rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none md:col-span-1" />' +
            '</div>' +
            '<div class="mt-2 flex items-center gap-2">' +
              '<input id="admDesc" placeholder="Описание" class="flex-1 rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none" />' +
              '<button id="admAddFlavor" class="rounded-lg bg-emerald-500/20 border border-emerald-700 hover:bg-emerald-500/30 h-9 px-3">Добавить</button>' +
            '</div>' +
          '</div>' +

          '<div class="rounded-xl border border-slate-800 p-3 bg-slate-900/40">' +
            '<div class="text-[12px] opacity-80 mb-2">Список вкусов</div>' +
            '<div id="admFlavorList" class="space-y-2"></div>' +
          '</div>' +
        '</div>'
      );

      root.innerHTML =
        '<div class="max-w-3xl mx-auto p-4 md:p-6 space-y-4">' +
          '<div class="flex items-center justify-between gap-2">' +
            '<div class="flex items-center gap-3">' +
              '<div class="text-xl font-bold">Hookah Mixes</div>' +
              (state.user?('<div class="text-[12px] opacity-80">Привет, '+escHTML(state.user.name)+'</div>'):'') +
            '</div>' +
            '<div>'+tabsHtml+'</div>' +
          '</div>' +

          (activeTab==='builder'
            ? (
              '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">' +
                '<div class="md:col-span-2 space-y-3">' +
                  '<div class="rounded-xl border border-slate-800 p-3 bg-slate-900/40 space-y-2">' +
                    '<input id="mixTitle" placeholder="Название микса" class="w-full rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none" />' +
                    '<div id="mixParts" class="space-y-2">'+partsHtml+'</div>' +
                    '<div class="text-[12px] opacity-80">Сумма: '+safePercent(percentSum(parts))+'%</div>' +
                    '<textarea id="mixNotes" rows="3" placeholder="Заметки" class="w-full rounded-lg px-3 py-2 bg-slate-950 border border-slate-800 outline-none"></textarea>' +
                    '<div class="flex items-center gap-2">' +
                      '<button id="saveMix" class="rounded-lg bg-indigo-500/20 border border-indigo-700 hover:bg-indigo-500/30 h-9 px-3">Сохранить</button>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="space-y-3">' +
                  '<div class="rounded-xl border border-slate-800 p-3 bg-slate-900/40">' +
                    '<div class="text-[12px] opacity-80 mb-2">Поиск вкусов</div>' +
                    '<div class="flex items-center gap-2 mb-2">' +
                      '<select id="brandFilter" class="rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none">' +
                        '<option value="">Все бренды</option>' +
                        + brands.map(b=> '<option value="'+escAttr(b)+'">'+escHTML(b)+'</option>').join('') +
                      '</select>' +
                      '<input id="searchInp" placeholder="Поиск..." class="flex-1 rounded-lg h-9 px-3 bg-slate-950 border border-slate-800 outline-none" />' +
                    '</div>' +
                    '<div id="flavorsList" class="space-y-2 max-h-[50vh] overflow-auto"></div>' +
                  '</div>' +
                '</div>' +
              '</div>'
            )
            : (activeTab==='guests'
                ? ('<div class="space-y-3">'+guestsHtml+'</div>')
                : adminHtml
              )
          ) +
        '</div>';

      // Наполняем список вкусов в builder'е
      if (activeTab==='builder' || activeTab==='admin'){
        const list = qs('#flavorsList', root);
        if (list){
          const html = filtered.map(f=>{
            return (
              '<div class="flex items-center justify-between gap-2 text-sm border border-slate-800 rounded-xl p-2">' +
                '<div class="min-w-0">' +
                  '<div class="truncate font-semibold">'+escHTML(f.brand)+' • '+escHTML(f.name)+'</div>' +
                  (f.description?'<div class="text-[12px] opacity-70">'+escHTML(f.description)+'</div>':'') +
                  ((f.tags||[]).length>0?'<div class="text-[11px] opacity-70">'+escHTML((f.tags||[]).join(', '))+'</div>':'') +
                '</div>' +
                '<div class="flex items-center gap-2">' +
                  (activeTab==='builder'
                    ? '<button class="rounded-lg bg-emerald-500/20 border border-emerald-700 hover:bg-emerald-500/30 h-8 px-3" data-add="'+escAttr(byId(f))+'">Добавить</button>'
                    : ''
                  ) +
                '</div>' +
              '</div>'
            );
          }).join('') || '<div class="text-sm text-slate-400">Ничего не найдено</div>';
          list.innerHTML = html;

          // обработчики добавления
          qsa('[data-add]', root).forEach(btn=>{
            btn.addEventListener('click', function(){
              const id = btn.getAttribute('data-add');
              if (!id) return;
              const parts = state.builder.parts.slice();
              const existingIdx = parts.findIndex(p=> String(p.flavorId)===String(id));
              if (existingIdx === -1){
                parts.push({ flavorId: id, percent: 20 });
              }
              state.builder.parts = parts;
              render();
            });
          });
        }
      }

      // Список вкусов в админке (с кнопками удалить вкус)
      if (activeTab==='admin'){
        const list = qs('#admFlavorList', root);
        if (list){
          const byBrand = {};
          for (const f of state.flavors){
            if (!byBrand[f.brand]) byBrand[f.brand] = [];
            byBrand[f.brand].push(f);
          }
          const html = Object.keys(byBrand).sort((a,b)=> a.localeCompare(b,'ru')).map(brand=>{
            const rows = byBrand[brand].sort((a,b)=> a.name.localeCompare(b.name,'ru')).map(f=>{
              return (
                '<div class="flex items-center justify-between gap-2 text-[12px] border border-slate-800 rounded-lg px-2 py-1">' +
                  '<div class="min-w-0 truncate"><span class="opacity-70">'+escHTML(brand)+'</span> • '+escHTML(f.name)+'</div>' +
                  '<button data-del-flavor="'+escAttr(f.id)+'" class="rounded-lg bg-rose-900/20 border border-rose-700 text-rose-300 hover:bg-rose-900/40">Удалить</button>' +
                '</div>'
              );
            }).join('');
            return (
              '<div class="space-y-1">' +
                '<div class="text-[11px] uppercase tracking-wide text-slate-400">'+escHTML(brand)+'</div>' +
                rows +
              '</div>'
            );
          }).join('') || '<div class="text-[12px] text-slate-400">Пока нет вкусов</div>';
          list.innerHTML = html;

          qsa('[data-del-flavor]', root).forEach(btn=>{
            btn.addEventListener('click', async function(){
              var id = btn.getAttribute('data-del-flavor');
              if (!id) return;
              if (!confirm('Удалить вкус "'+id+'"? Это действие необратимо.')) return;
              try{
                const payload = { action:'delete', id };
                const headers = { 'X-Admin-Token': state.adminToken, 'Content-Type':'application/json' };
                const r = await api('/api/flavors', { method:'POST', headers, body: JSON.stringify(payload) });
                if (!r.ok) throw new Error('Не удалось удалить вкус');
                await loadFlavors();
                render();
              }catch(e){
                console.error(e);
                alert((e && e.message) ? e.message : 'Ошибка удаления вкуса');
              }
            });
          });
        }
      }

      // === общие обработчики ===

      // Переключение вкладок
      qsa('[data-tab]', root).forEach(btn=>{
        btn.addEventListener('click', function(){
          state.activeTab = btn.getAttribute('data-tab') || 'builder';
          render();
        });
      });

      // Поиск и бренд-фильтр
      const brandSel = qs('#brandFilter', root);
      const searchInp = qs('#searchInp', root);
      if (brandSel){
        brandSel.value = state.filteredBrand || '';
        brandSel.addEventListener('change', function(){
          state.filteredBrand = brandSel.value || '';
          render();
        });
      }
      if (searchInp){
        searchInp.value = state.search || '';
        searchInp.addEventListener('input', function(){
          state.search = searchInp.value || '';
          render();
        });
      }

      // Обработчики в конструкторе
      if (activeTab==='builder'){
        const title = qs('#mixTitle', root);
        const notes = qs('#mixNotes', root);
        const partsRoot = qs('#mixParts', root);

        if (title){
          title.value = state.builder.title || '';
          title.addEventListener('input', function(){
            state.builder.title = title.value || '';
          });
        }
        if (notes){
          notes.value = state.builder.notes || '';
          notes.addEventListener('input', function(){
            state.builder.notes = notes.value || '';
          });
        }
        if (partsRoot){
          qsa('input[type="range"][data-idx]', partsRoot).forEach(inp=>{
            inp.addEventListener('input', function(){
              const idx = Number(inp.getAttribute('data-idx')||'0');
              const val = Number(inp.value||0);
              state.builder.parts = clampPercentForPart(state.builder.parts, idx, val);
              render();
            });
          });
          qsa('[data-rm]', partsRoot).forEach(btn=>{
            btn.addEventListener('click', function(){
              const idx = Number(btn.getAttribute('data-rm')||'-1');
              if (idx>=0){
                const cp = state.builder.parts.slice();
                cp.splice(idx,1);
                state.builder.parts = cp;
                render();
              }
            });
          });
        }

        const saveBtn = qs('#saveMix', root);
        if (saveBtn){
          saveBtn.addEventListener('click', async function(){
            try{
              const body = buildMixPayload();
              const r = await api('/api/mixes', { method:'POST', body: JSON.stringify(body) });
              if (!r.ok) throw new Error('Не удалось сохранить');

              // очистим форму и покажем вкладку гостей
              state.builder = { title:'', parts:[], notes:'' };
              await loadGuestMixes();
              state.activeTab = 'guests';
              render();
            }catch(e){
              console.error(e); alert('Ошибка сети при сохранении');
            }
          });
        }
      }

      // Удаление своего/любой (если админ) микса
      qsa('[data-del]', root).forEach(function(btn){
        btn.addEventListener('click', async function(){
          const id = btn.getAttribute('data-del');
          if (!id) return;
          if (!confirm('Удалить микс?')) return;
          try{
            await deleteMixOnServer(id, state.user, isAdmin() ? state.adminToken : '');
            await loadGuestMixes();
            render();
          }catch(e){
            console.error(e); alert((e && e.message) ? e.message : 'Ошибка удаления');
          }
        });
      });

      // Админ-доступ (сохранить/скрыть)
      var tokBtn = root.querySelector('#admSaveToken');
      if (tokBtn){
        tokBtn.addEventListener('click', function(){
          var v = (root.querySelector('#admToken')||{}).value || '';
          try{ localStorage.setItem('admin_token', v); }catch(_){}
          state.adminToken = v || "";
          state.adminPrompt = false;
          if (state.activeTab!=='admin') state.activeTab='admin';
          render();
        });
      }
      var tokCancel = root.querySelector('#admLogout');
      if (tokCancel){
        tokCancel.addEventListener('click', function(){
          try{ localStorage.removeItem('admin_token'); }catch(_){}
          state.adminToken = "";
          state.activeTab = 'builder';
          render();
        });
      }
      var btnAdd = root.querySelector('#admAddFlavor');
      if (btnAdd){
        btnAdd.addEventListener('click', async function(){
          try{
            var brand = (qs('#admBrand',root)||{}).value || '';
            var name = (qs('#admName',root)||{}).value || '';
            var tags = (qs('#admTags',root)||{}).value || '';
            var desc = (qs('#admDesc',root)||{}).value || '';
            var st = (qs('#admStrength',root)||{}).value || '';
            if (!brand || !name) { alert('Укажите бренд и название'); return; }
            var payload = { brand, name, tags, description: desc, strength10: Number(st||0) };
            var headers = { 'X-Admin-Token': state.adminToken, 'Content-Type':'application/json' };
            var r = await api('/api/flavors', { method:'POST', headers, body: JSON.stringify(payload) });
            if (!r.ok) throw new Error('Не удалось добавить вкус');
            await loadFlavors();
            render();
          }catch(e){
            console.error(e);
            alert((e && e.message) ? e.message : 'Ошибка добавления вкуса');
          }
        });
      }
    }

    function buildMixPayload(){
      const p = (state.builder.parts||[]).map(x=>({ flavorId: byId(x), percent: Number(x.percent)||0 }));
      return {
        id: uuidv4(),
        title: String(state.builder.title||'Микс').slice(0,100),
        parts: p,
        notes: String(state.builder.notes||'').slice(0,2000),
        author: String(state.user && state.user.name || 'Гость'),
        authorId: String(state.user && state.user.id || ''),
        createdAt: nowIso(),
        strength10: computeStrength10(p),
        taste: getMixTasteLabel(p)
      };
    }

    // ========================= УДАЛЕНИЕ МИКСА (без создания) ===================
    async function deleteMixOnServer(id, user, adminToken){
      const uid = String(user && user.id || '');
      const headers = { 'X-Author-Id': uid, 'X-User-Id': uid };
      if (adminToken) headers['X-Admin-Token'] = adminToken;

      // 1) DELETE /api/mixes/:id
      let t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers }).catch(()=>null);
      if (t && (t.ok || t.status===204)) return true;

      // 2) DELETE /api/mixes/:id?authorId=...
      t = await api('/api/mixes/'+encodeURIComponent(id)+'?authorId='+encodeURIComponent(uid), { method:'DELETE', headers }).catch(()=>null);
      if (t && (t.ok || t.status===204)) return true;

      // 3) POST /api/mixes/delete { id, authorId }
      t = await api('/api/mixes/delete', { method:'POST', headers, body: JSON.stringify({ id, authorId: uid }) }).catch(()=>null);
      if (t && (t.ok || t.status===204)) return true;

      // 4) POST override
      t = await api('/api/mixes/'+encodeURIComponent(id)+'?_method=DELETE', { method:'POST', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
      if (t && (t.ok || t.status===204)) return true;

      // 5) DELETE с body
      t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
      if (t && (t.ok || t.status===204)) return true;

      throw new Error('Удалить не удалось');
    }

    // ========================= BOOT =========================
    async function boot(){
      try{
        await initUser();
        await loadFlavors();
        await loadGuestMixes();
        render();

        // Периодическое обновление гостевых миксов
        setInterval(async ()=>{
          try{
            const prev = (state.guestMixes||[]).map(m=> m.id).join(',');
            await loadGuestMixes();
            const curr = (state.guestMixes||[]).map(m=> m.id).join(',');
            if (prev !== curr) render();
          }catch(_){}
        }, 10000);
      }catch(e){
        console.error(e);
        (__fatal||function(){})('Инициализация не удалась: ' + (e && e.message || e));
      }
    }

    boot();
  })();
  </script>
</body>
</html>
