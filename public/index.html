<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Hookah Mixes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif; background:#0b1220; color:#e6edf3; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab { padding:8px 12px; border:1px solid #1f2a44; border-radius:10px; background:#0f172a; cursor:pointer; font-size:13px; }
    .tab.active { background:#1e293b; border-color:#334155; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
    .card { background:#0f172a; border:1px solid #1f2a44; border-radius:14px; padding:12px; }
    .muted { color:#94a3b8; font-size:12px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 12px; border-radius:10px; font-size:13px; cursor:pointer; border:1px solid #1f2a44; background:#0b1220; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:white; }
    .btn.danger { background:#b91c1c; border-color:#b91c1c; color:white; }
    .btn:disabled { opacity: .6; cursor: default; }
    .input, textarea { width:100%; background:#0b1220; border:1px solid #1f2a44; color:#e6edf3; border-radius:10px; padding:8px 10px; }
    textarea { min-height:100px; resize:vertical; }
    .row { display:flex; gap:8px; align-items:center; }
    .row.wrap { flex-wrap:wrap; }
    .row > * { flex:1 1 auto; }
    .tag { font-size:11px; border:1px solid #1f2a44; background:#0b1220; border-radius:999px; padding:2px 8px; margin-right:4px; }
    .small { font-size:12px; }
    .warning { border:1px solid #ca8a04; background:#0b1220; color:#f1f5f9; border-radius:10px; padding:10px; }
    .ui-card { background:#0f172a; border:1px solid #1f2a44; border-radius:14px; }
    .px-3 { padding-left:12px; padding-right:12px; }
    .pt-3 { padding-top:12px; }
    .p-3  { padding:12px; }
    .space-y-2 > * + * { margin-top:8px; }
  </style>

  <!-- === Глобальный резолвер токена — ДОЛЖЕН идти раньше любых других скриптов === -->
  <script>
  (function(){
    window.getAdminToken = window.getAdminToken || function(){
      try{
        if (window.state && state.adminToken) return String(state.adminToken||'');
        const v = document.getElementById('admToken')?.value; if (v) return String(v||'');
        const ls = localStorage.getItem('admin_token'); if (ls) return String(ls||'');
      }catch(_){}
      return '';
    };
    // дублируем как глобальную переменную (если где-то вызывают без window.)
    // eslint-disable-next-line no-var
    var getAdminToken = window.getAdminToken;

    // синхронизация токена при нажатии «Сохранить токен»
    document.addEventListener('click', function(e){
      const btn = e.target?.closest?.('#admSaveToken');
      if (!btn) return;
      try{
        const v = String(document.getElementById('admToken')?.value || '');
        if (v){
          try{ localStorage.setItem('admin_token', v); }catch(_){}
          if (window.state) state.adminToken = v;
        }
      }catch(_){}
    }, true);
  })();
  </script>
</head>

<body>
  <div class="container">
    <div class="tabs" id="tabs"></div>
    <div id="content"></div>
  </div>

  <script>
  // ========================= УТИЛИТЫ / API =========================
  const api = (path, opts={}) => fetch(path, {
    headers: { 'Content-Type':'application/json; charset=UTF-8', ...(opts.headers||{}) },
    ...opts
  });

  // Нормализатор бренда (и ключ — чтобы вы не ловили ReferenceError)
  const normalizeBrand = b => (b||'').trim();
  const brandKey = b => String((b||'').trim().toLowerCase().replace(/[^a-z0-9а-яё]+/gi,''));

  // === ВАЖНО: если ваш бэкенд использует иные пути — поменяйте здесь:
  const ENDPOINTS = {
    mixes:       '/api/mixes',
    flavors:     '/api/flavors',
    stopWords:   '/api/stop-words',
    like: id => `/api/mixes/${encodeURIComponent(id)}/like` // если у вас иначе — поправьте здесь
  };

  // ========================= СОСТОЯНИЕ =========================
  const state = {
    activeTab: 'guest',
    user: null,              // { id, name } — если авторизован
    guestMixes: [],          // список миксов гостей
    myMixes: [],             // если нужно
    adminToken: '',          // заполнится из getAdminToken() при рендере
  };

  // ========================= STOP-WORDS (client) =========================
  const STOP_WORDS_KEY = 'FORBIDDEN_MIX_WORDS';
  function loadStopWordsLocal(){
    try{ const raw = localStorage.getItem(STOP_WORDS_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr)?arr:[]; }
    catch(_){ return []; }
  }
  function saveStopWordsLocal(list){
    const arr = (Array.isArray(list)?list:[]).map(s=>String(s||'').trim()).filter(Boolean);
    try{ localStorage.setItem(STOP_WORDS_KEY, JSON.stringify(arr)); }catch(_){}
    return arr;
  }
  function validateText(title, notes){
    const words = loadStopWordsLocal(); if(!words.length) return { ok:true };
    const hay = [String(title||''), String(notes||'')].join('\n').toLowerCase();
    const bad = words.find(w => hay.includes(String(w||'').toLowerCase()));
    return bad ? { ok:false, word: bad } : { ok:true };
  }

  async function loadStopWordsServer(){
    try{
      const r = await api(ENDPOINTS.stopWords);
      if (r.ok){
        const d = await r.json().catch(()=>({words:[]}));
        return saveStopWordsLocal(Array.isArray(d && d.words) ? d.words : []);
      }
    }catch(_){}
    return loadStopWordsLocal();
  }

  // Сохранение стоп-слов: сначала PUT, затем POST как фолбэк
  async function saveStopWordsServer(list){
    const words = (Array.isArray(list)?list:[]).map(s=>String(s||'').trim()).filter(Boolean);
    const headers = { 'X-Admin-Token': window.getAdminToken() };

    let r = await api(ENDPOINTS.stopWords, { method:'PUT', headers, body: JSON.stringify({ words }) });
    if (!r.ok) r = await api(ENDPOINTS.stopWords, { method:'POST', headers, body: JSON.stringify({ words }) });

    if (!r.ok){
      let msg=''; try{ msg = await r.text(); }catch(_){}
      throw new Error('Сохранение стоп-слов не удалось: ' + r.status + (msg ? (' — ' + msg) : ''));
    }
    saveStopWordsLocal(words);
  }

  // Применить стоп-слова к существующим миксам (удаление нарушающих)
  async function enforceStopWords(){
    try{
      await loadGuestMixes();
      const bad = state.guestMixes.filter(m => !validateText(m?.title, m?.notes).ok);
      for (const m of bad){
        try{
          await fetch(`${ENDPOINTS.mixes}/${encodeURIComponent(m.id)}`, {
            method: 'DELETE',
            headers: { 'X-Admin-Token': window.getAdminToken() }
          });
        }catch(_){}
      }
      if (bad.length) await loadGuestMixes();
    }catch(_){}
  }

  // ========================= MIXES / FLAVORS API =========================
  async function loadGuestMixes(){
    try{
      const r = await api(ENDPOINTS.mixes);
      if (r.ok){
        state.guestMixes = await r.json().catch(()=>[]);
      }
    }catch(_){}
  }

  // Лайк / дизлайк (анти-даблклик в UI на стороне рендера)
  async function likeMixOnServer(id){
    const r = await api(ENDPOINTS.like(id), { method:'POST' });
    if (!r.ok){ let t=''; try{ t=await r.text(); }catch(_){}; throw new Error(t || r.status); }
  }
  async function unlikeMixOnServer(id){
    const r = await api(ENDPOINTS.like(id), { method:'DELETE' });
    if (!r.ok){ let t=''; try{ t=await r.text(); }catch(_){}; throw new Error(t || r.status); }
  }

  // Админ: создать вкус (X-Admin-Token — всегда есть из разных источников)
  async function createFlavorOnServer(payload, token){
    const tokenToUse = String(
      token ??
      (window.state && state.adminToken) ??
      (document.getElementById('admToken')?.value) ??
      localStorage.getItem('admin_token') ?? ''
    );
    const r = await api(ENDPOINTS.flavors, {
      method: 'POST',
      headers: { 'X-Admin-Token': tokenToUse },
      body: JSON.stringify(payload)
    });
    if (!r.ok){
      let t=''; try{ t=await r.text(); }catch(_){}
      throw new Error('Не удалось создать вкус: ' + r.status + (t ? (' — ' + t) : ''));
    }
    return r.json();
  }
  async function deleteFlavorOnServer(id, token){
    const tokenToUse = String(
      token ??
      (window.state && state.adminToken) ??
      (document.getElementById('admToken')?.value) ??
      localStorage.getItem('admin_token') ?? ''
    );
    const r = await fetch(`${ENDPOINTS.flavors}/${encodeURIComponent(id)}`, {
      method: 'DELETE',
      headers: { 'X-Admin-Token': tokenToUse }
    }).catch(()=>null);
    return !!(r && (r.ok || r.status===204));
  }

  // ========================= РЕНДЕР =========================
  const tabs = [
    { id:'guest', label:'Гостевые миксы' },
    { id:'create', label:'Создать микс' },
    { id:'admin', label:'Админ' },
  ];

  function render(){
    // tabs
    const t = document.getElementById('tabs');
    t.innerHTML = '';
    tabs.forEach(tb=>{
      const el = document.createElement('button');
      el.className = 'tab' + (state.activeTab===tb.id ? ' active':'');
      el.textContent = tb.label;
      el.onclick = async ()=>{
        state.activeTab = tb.id;
        render();
        if (tb.id==='guest') { await loadGuestMixes(); render(); }
        if (tb.id==='admin') { try{ document.getElementById('admToken').value = window.getAdminToken(); }catch(_){} }
      };
      t.appendChild(el);
    });

    // content
    const c = document.getElementById('content');
    c.innerHTML = '';

    if (state.activeTab==='guest'){
      const wrap = document.createElement('div');
      wrap.className = 'grid';
      (state.guestMixes||[]).forEach(mix=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row wrap" style="justify-content:space-between;">
            <div><strong>${(mix.title||'Без названия')}</strong></div>
            <div class="small muted">Автор: ${mix.authorName || 'Гость'}</div>
          </div>
          <div class="muted" style="margin:6px 0 10px">${mix.notes ? String(mix.notes) : ''}</div>
          <div style="margin:8px 0">${(mix.parts||[]).map(p=>`<span class="tag">${(p.brand||'')}${p.name?(' — '+p.name):''}</span>`).join(' ')}</div>
          <div class="row" style="justify-content:space-between; margin-top:8px">
            <button class="btn" data-like="${mix.id}">❤️ ${Array.isArray(mix.likers)?mix.likers.length:0}</button>
            ${mix.canDelete ? `<button class="btn danger" data-del="${mix.id}">Удалить</button>`:''}
          </div>
        `;
        wrap.appendChild(card);
      });
      c.appendChild(wrap);

      // лайки
      c.querySelectorAll('[data-like]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if (btn.dataset.busy==='1') return;
          btn.dataset.busy='1';
          const id = btn.getAttribute('data-like');
          const mix = state.guestMixes.find(m=>m.id===id);
          const liked = Array.isArray(mix?.likers) && state.user && mix.likers.includes(String(state.user.id));
          try{
            if (liked) await unlikeMixOnServer(id);
            else        await likeMixOnServer(id);
            await loadGuestMixes();
            render();
          }catch(e){
            alert('Не удалось обновить лайк: ' + (e && (e.message || e) || ''));
          }finally{
            delete btn.dataset.busy;
          }
        });
      });

      // удаление своего (если доступно)
      c.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if (!confirm('Удалить микс?')) return;
          btn.disabled = true;
          try{
            await fetch(`${ENDPOINTS.mixes}/${encodeURIComponent(btn.getAttribute('data-del'))}`, { method:'DELETE' });
            await loadGuestMixes(); render();
          }catch(e){ alert('Не удалось удалить'); }
          finally{ btn.disabled=false; }
        });
      });
    }

    if (state.activeTab==='create'){
      const form = document.createElement('div');
      form.className = 'card';
      form.innerHTML = `
        <div class="row wrap">
          <div class="row" style="flex:1 1 240px">
            <input id="title" class="input" placeholder="Название микса" />
          </div>
        </div>
        <div style="margin-top:8px">
          <textarea id="notes" placeholder="Описание / заметки"></textarea>
        </div>
        <div class="row" style="margin-top:10px; justify-content:space-between;">
          <div class="muted small">Проверка на запрещённые слова выполняется автоматически</div>
          <button id="save" class="btn primary">Сохранить</button>
        </div>
      `;
      c.appendChild(form);

      // блокируем сохранение, если стоп-слово
      form.querySelector('#save').addEventListener('click', async ()=>{
        const title = form.querySelector('#title').value || '';
        const notes = form.querySelector('#notes').value || '';
        const v = validateText(title, notes);
        if (!v.ok){ alert('Микс содержит запрещённое слово: ' + v.word); return; }

        // здесь должен быть ваш реальный вызов сохранения микса на сервер
        // пример:
        try{
          const r = await api(ENDPOINTS.mixes, { method:'POST', body: JSON.stringify({ title, notes, parts: [] }) });
          if (!r.ok){ let t=''; try{ t=await r.text(); }catch(_){}; throw new Error(t || r.status); }
          alert('Сохранено!');
          state.activeTab='guest'; await loadGuestMixes(); render();
        }catch(e){ alert('Не удалось сохранить: ' + (e.message||e)); }
      });
    }

    if (state.activeTab==='admin'){
      const admin = document.createElement('div');
      admin.innerHTML = `
        <div class="grid">
          <!-- Карточка: Токен -->
          <div class="ui-card">
            <div class="px-3 pt-3">
              <div class="muted small" style="text-transform:uppercase; letter-spacing:.08em">Доступ</div>
              <div><strong>Админ-токен</strong></div>
            </div>
            <div class="p-3 space-y-2">
              <input id="admToken" class="input" placeholder="Вставьте токен" value="${window.getAdminToken()}" />
              <div class="row" style="justify-content:flex-end">
                <button id="admSaveToken" class="btn primary">Сохранить токен</button>
              </div>
            </div>
          </div>

          <!-- Карточка: Вкусы -->
          <div class="ui-card">
            <div class="px-3 pt-3">
              <div class="muted small" style="text-transform:uppercase; letter-spacing:.08em">Справочники</div>
              <div><strong>Все вкусы</strong></div>
            </div>
            <div class="p-3 space-y-2">
              <div id="admFlavorList" class="muted small">Здесь будет список вкусов (под эту карточку крепится блок «Запрещённые слова»).</div>
              <div class="row wrap">
                <input id="flavorName" class="input" placeholder="Название вкуса" />
                <button id="createFlavor" class="btn primary" style="flex:0 0 auto">Добавить вкус</button>
              </div>
              <div class="muted small">При добавлении используется X-Admin-Token из формы/LocalStorage/state.</div>
            </div>
          </div>

          <!-- Карточка: Запрещённые слова (встраиваем сразу, а также будет авто-инжектор для надёжности) -->
          <div class="ui-card">
            <div class="px-3 pt-3">
              <div class="muted small" style="text-transform:uppercase; letter-spacing:.08em">Модерация</div>
              <div><strong>Запрещённые слова</strong></div>
            </div>
            <div class="p-3 space-y-2">
              <textarea id="admForbidden" class="input" style="min-height:140px" placeholder="Одно слово на строку"></textarea>
              <div class="muted small">Если слово встречается в названии или описании — микс нельзя сохранить. При добавлении новых слов нарушающие старые миксы удаляются автоматически.</div>
              <div class="row" style="justify-content:flex-end; gap:8px">
                <button id="admStopWordsLoad" class="btn">Загрузить с сервера</button>
                <button id="admStopWordsSave" class="btn primary">Сохранить</button>
              </div>
            </div>
          </div>
        </div>
      `;
      c.appendChild(admin);

      // поведение: вкусы
      admin.querySelector('#createFlavor').addEventListener('click', async ()=>{
        const name = admin.querySelector('#flavorName').value.trim();
        if (!name) return;
        try{
          await createFlavorOnServer({ name });
          admin.querySelector('#flavorName').value='';
          alert('Вкус добавлен');
        }catch(e){ alert(e && e.message || 'Ошибка добавления вкуса'); }
      });

      // стоп-слова UI
      const area = admin.querySelector('#admForbidden');
      try{ area.value = (loadStopWordsLocal()||[]).join('\n'); }catch(_){ area.value=''; }

      admin.querySelector('#admStopWordsLoad').addEventListener('click', async ()=>{
        await loadStopWordsServer();
        area.value = (loadStopWordsLocal()||[]).join('\n');
      });

      admin.querySelector('#admStopWordsSave').addEventListener('click', async ()=>{
        const list = String(area.value||'').split(/\r?\n|,|;/).map(s=>s.trim()).filter(Boolean);
        try{
          await saveStopWordsServer(list);
          await enforceStopWords();
          alert('Сохранено и применено.');
        }catch(e){
          alert(e && e.message || 'Не удалось сохранить список');
        }
      });
    }
  }

  // Блокируем сохранение микса и из любого другого существующего кода (глобальный перехват на #save)
  document.addEventListener('click', function(e){
    const btn = e.target?.closest?.('#save');
    if (!btn) return;
    try{
      const titleEl = document.getElementById('title');
      const notesEl = document.getElementById('notes');
      const v = validateText(titleEl ? titleEl.value : '', notesEl ? notesEl.value : '');
      if (!v.ok){ e.preventDefault(); e.stopImmediatePropagation(); alert('Микс содержит запрещённое слово: ' + v.word); }
    }catch(_){}
  }, true);

  // ========================= ИНИЦИАЛИЗАЦИЯ =========================
  (async function init(){
    try{ state.adminToken = window.getAdminToken(); }catch(_){}
    await loadGuestMixes();
    render();
  })();
  </script>
</body>
</html>
