<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#020617" />
  <title>Hookah Mixes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{background:#020617}</style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- –†–∞–Ω–Ω–∏–π —ç–∫—Ä–∞–Ω –æ—à–∏–±–æ–∫ -->
  <script>
    (function(){
      function showFatal(msg){
        var root = document.getElementById('root');
        if (!root) return;
        root.innerHTML =
          '<div class="min-h-[100svh] flex items-center justify-center p-6">' +
          '  <div class="max-w-md w-full rounded-xl border border-rose-800 bg-rose-950 p-4 text-sm">' +
          '    <div class="font-bold mb-2 text-rose-200">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</div>' +
          '    <div class="text-rose-100/90 whitespace-pre-wrap break-words">' + String(msg || 'Unknown error') + '</div>' +
          '  </div>' +
          '</div>';
      }
      window.addEventListener('error', function(e){
        var m = (e && (e.message || (e.error && e.error.message))) || 'Script error';
        showFatal(m);
      });
      window.addEventListener('unhandledrejection', function(e){
        var m = (e && (e.reason && (e.reason.message || e.reason))) || 'Unhandled rejection';
        showFatal(m);
      });
    })();
  </script>
</head>
<body class="text-slate-100">
  <div id="root" class="min-h-[100svh]"></div>

  <script>
  // ========================= API ============================================
  const API_BASE = "https://hookhah.onrender.com";
  function api(path, opts={}) {
    const headers = { Accept: "application/json", ...(opts.headers||{}) };
    // –ê–≤—Ç–æ-Content-Type –¥–ª—è JSON body
    if (opts.body && !headers["Content-Type"] && !(opts.body instanceof FormData)) {
      headers["Content-Type"] = "application/json; charset=UTF-8";
    }
    return fetch(API_BASE + path, { cache: "no-store", ...opts, headers });
  }

  // ========================= –£–¢–ò–õ–ò–¢–´ ========================================
  const safeNum = (v, d=0) => { const n = Number(v); return Number.isFinite(n)?n:d; };
  const safePercent = (v) => Math.max(0, Math.min(100, safeNum(v, 0)));
  const percentSum = (parts=[]) => (Array.isArray(parts)?parts.reduce((a,b)=>a+safePercent(b && b.percent),0):0);
  const isMixValid = (parts,title) => (Array.isArray(parts)?(parts.length>0 && percentSum(parts)===100 && String(title||'').trim().length>=3):false);
  const clampPercentForPart=(parts,targetId,newVal)=>{
    const other=percentSum(parts.filter(x=>x&&x.flavorId!==targetId));
    return Math.max(0,Math.min(safePercent(newVal),100-other));
  };
  const uuidv4=()=>{let dt=Date.now();if(typeof performance!='undefined'&&typeof performance.now==='function')dt+=performance.now();return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=(dt+Math.random()*16)%16|0;dt=Math.floor(dt/16);const v=c==='x'?r:(r&0x3)|0x8;return v.toString(16);});};
  const normalizeBrand=(b)=>(b||'').trim();
  const BRAND_STRENGTH10_DEFAULTS={Darkside:5,"Black Burn":6,BlackBurn:6,MustHave:5,Overdose:6,Bonch:7,Starline:3};
  const getStrength10=(f)=>{
    if(!f) return 5;
    if(typeof f.strength10==='number'&&Number.isFinite(f.strength10)) return Math.max(1,Math.min(10,f.strength10));
    return BRAND_STRENGTH10_DEFAULTS[normalizeBrand(f.brand)]??5;
  };
  const strengthColor=(v)=>{
    if(v==null)return{bg:"bg-slate-800",text:"text-slate-200",border:"border-slate-700"};
    if(v<4)return{bg:"bg-emerald-950",text:"text-emerald-300",border:"border-emerald-800"};
    if(v<7)return{bg:"bg-amber-950",text:"text-amber-300",border:"border-amber-800"};
    return{bg:"bg-rose-950",text:"text-rose-300",border:"border-rose-800"};
  };
  const tasteWordFromTag=(tag)=>{
    if(tag==null)return null;const t=String(tag).toLowerCase().trim();if(!t)return null;
    const rules=[
      [/(–∫–∏—Å–ª|sour|–ª–∏–º–æ–Ω|lime|–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç)/,"–∫–∏—Å–ª—ã–π"],
      [/(—Å–ª–∞–¥–∫|sweet|sugar|–º–µ–¥|honey)/,"—Å–ª–∞–¥–∫–∏–π"],
      [/(–ø—Ä—è–Ω|spice|ginger|–∏–º–±–∏—Ä)/,"–ø—Ä—è–Ω—ã–π"],
      [/(–ª–µ–¥|ice|cold|frost|–º—è—Ç)/,"–ª–µ–¥—è–Ω–æ–π"],
      [/(—Ñ—Ä—É–∫—Ç|fruit|—è–±–ª–æ–∫|banana|mango|pineapple|grape|orange|pear|melon|berry)/,"—Ñ—Ä—É–∫—Ç–æ–≤—ã–π"],
      [/(–¥–µ—Å–µ—Ä—Ç|dessert|cake|pie|cookie|choco|cream|vanilla|waffle)/,"–¥–µ—Å–µ—Ä—Ç–Ω—ã–π"]
    ];
    for (const [re,w] of rules){ if(re.test(t)) return w; }
    return null;
  };
  const getMixTasteLabel=(parts,flavors)=>{
    if(!Array.isArray(parts)||!Array.isArray(flavors)||parts.length===0)return null;
    const total=percentSum(parts); if(total<=0)return null;
    const scores=new Map();
    const add=(raw,w)=>{const word=tasteWordFromTag(raw);if(word)scores.set(word,(scores.get(word)||0)+w);};
    for (const p of parts){
      const w=safePercent(p&&p.percent); if(w<=0)continue;
      const fl=flavors.find(f=>f&&f.id===(p&&p.flavorId)); if(!fl)continue;
      if(fl.tags) for(const t of fl.tags) add(t,w);
      if(fl.name) for(const tk of String(fl.name).toLowerCase().split(/[^a-z–∞-—è0-9]+/i)) add(tk,Math.max(1,w*0.6));
      if(fl.description) for(const tk of String(fl.description).toLowerCase().split(/[^a-z–∞-—è0-9]+/i)) add(tk,Math.max(1,w*0.3));
    }
    if(!scores.size)return null;
    return Array.from(scores.entries()).sort((a,b)=>b[1]-a[1])[0][0]||null;
  };
  const escAttr=(s)=>String(s).replace(/"/g,'&quot;');
  const escHTML=(s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // ========================= –°–û–°–¢–û–Ø–ù–ò–ï ======================================
  const qp = new URLSearchParams(location.search);
  const state={
    flavors:[],
    activeBrand:"",
    search:"",
    parts:[],
    title:"",
    notes:"",
    guestMixes:[],
    activeTab:"builder",
    user:null,
    showSplash:false,
    logoUrl:null,
    adminToken: (localStorage.getItem('admin_token') || ""),
    adminPrompt: qp.get('admin') === '1'
  };
  const isAdmin=()=> !!(state.adminToken && state.adminToken.length>=6);

  // ========================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===================================
  function initAuth(){
    try{
      var u=window?.Telegram?.WebApp?.initDataUnsafe?.user;
      if(u){
        var name=[u.first_name,u.last_name].filter(Boolean).join(' ')||u.username||('User '+u.id);
        state.user={id:String(u.id),name,username:u.username};
        state.showSplash = true;
        return;
      }
    }catch(_){}
    state.user = { id:"anon", name:"–ì–æ—Å—Ç—å" };
    state.showSplash = true;
  }

  // ========================= –î–ê–ù–ù–´–ï –¢–û–õ–¨–ö–û –ò–ó API ===========================
  async function loadFlavors(){
    try{
      const r = await api('/api/flavors');
      if (r.ok){
        const data = await r.json();
        state.flavors = Array.isArray(data) ? data.map(normalizeFlavorRecord) : [];
        state.activeBrand = state.activeBrand || (state.flavors[0]?.brand) || "";
        return;
      }
    }catch(_){}
    state.flavors = [];
  }
  function normalizeFlavorRecord(f){
    const brand = String(f?.brand || '').trim();
    const name  = String(f?.name  || '').trim();
    const id = String((f && (f._id || f.id)) || (brand+'-'+name).toLowerCase().replace(/\s+/g,'-')).trim();
    const tags = Array.isArray(f?.tags)
      ? f.tags
      : (f?.tags ? String(f.tags).split(',').map(s=>s.trim()).filter(Boolean) : undefined);
    const strength10 = (Number.isFinite(f?.strength10) ? Number(f.strength10)
                      : Number.isFinite(f?.strength)   ? Number(f.strength) : undefined);
    const description = f?.description ? String(f.description) : undefined;
    return { id, brand, name, description, tags, strength10 };
  }

  async function loadGuestMixes(){
    try{
      const r = await api('/api/mixes');
      if (r.ok){
        const arr = await r.json();
        state.guestMixes = Array.isArray(arr) ? arr : [];
        state.guestMixes.sort((a,b)=>(b?.createdAt||0)-(a?.createdAt||0));
      } else {
        state.guestMixes = [];
      }
    }catch(_){ state.guestMixes = []; }
  }

  async function detectLogo(){
    async function exists(url){ try{ const r=await fetch(url,{method:'HEAD',cache:'no-store'}); return r.ok; }catch(_){ return false; } }
    const candidates=[ './logo.jpg','./logo.jpeg','./logo.JPG','./logo.JPEG','./AKGpihYIdG2xycCNV3hAm2gVxkuF4tS5.jpg' ];
    for(const c of candidates){ if(await exists(c)){ state.logoUrl=c; return; } }
    state.logoUrl=null;
  }
  function LogoSVG(cls){
    return (
      '<svg class="'+(cls||'w-8 h-8')+'" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">' +
      '  <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#38bdf8"/><stop offset="1" stop-color="#a78bfa"/></linearGradient></defs>' +
      '  <circle cx="32" cy="32" r="30" fill="url(#g)" opacity="0.2"/>' +
      '  <path d="M32 10c-4 4-4 8 0 12 4 4 4 8 0 12-4 4-4 8 0 12" stroke="#c7d2fe" stroke-width="3" fill="none" stroke-linecap="round"/>' +
      '  <circle cx="32" cy="50" r="3" fill="#c7d2fe"/>' +
      '</svg>'
    );
  }

  // ========================= FLAVORS API HELPERS =============================
  const flavorsApi = {
    async create(payload, token){
      const r = await api('/api/flavors', {
        method: 'POST',
        headers: { 'X-Admin-Token': token || '' },
        body: JSON.stringify(payload) // {brand,name,tags?,strength10?,description?}
      });
      if (!r.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤–∫—É—Å: '+(await r.text().catch(()=>r.status)));
      return true;
    },
    async removeByBrandName(brand, name, token){
      // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π –º–∞—Ä—à—Ä—É—Ç –ø–æ —Ç–≤–æ–µ–º—É —Ç–µ—Å—Ç—É: POST /api/flavors { action:'delete', brand, name }
      const r = await api('/api/flavors', {
        method: 'POST',
        headers: { 'X-Admin-Token': token || '' },
        body: JSON.stringify({ action:'delete', brand: String(brand).trim(), name: String(name).trim() })
      });
      if (!r.ok) throw new Error('–£–¥–∞–ª–µ–Ω–∏–µ –≤–∫—É—Å–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å: '+(await r.text().catch(()=>r.status)));
      return true;
    }
  };

  // ========================= –£–î–ê–õ–ï–ù–ò–ï –í–ö–£–°–ê (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç helpers) ============
  async function deleteFlavorOnServer(flavorId, token){
    let fl = (state.flavors || []).find(f => f && f.id === flavorId);
    if (!fl) { await loadFlavors(); fl = (state.flavors || []).find(f => f && f.id === flavorId); }
    if (!fl || !fl.brand || !fl.name) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å brand/name –¥–ª—è –≤–∫—É—Å–∞ "'+flavorId+'". –û–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –≤–∫—É—Å–æ–≤.');
    return flavorsApi.removeByBrandName(String(fl.brand).trim(), String(fl.name).trim(), token);
  }

  // ========================= –£–î–ê–õ–ï–ù–ò–ï –ú–ò–ö–°–ê (–±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è) ===================
  async function deleteMixOnServer(id, user){
    const uid = String(user && user.id || '');
    const headers = { 'X-Author-Id': uid, 'X-User-Id': uid };

    // 1) DELETE /api/mixes/:id
    let t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 2) DELETE /api/mixes/:id?authorId=...
    t = await api('/api/mixes/'+encodeURIComponent(id)+'?authorId='+encodeURIComponent(uid), { method:'DELETE', headers }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 3) POST /api/mixes/delete { id, authorId }
    t = await api('/api/mixes/delete', { method:'POST', headers, body: JSON.stringify({ id, authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 4) POST override
    t = await api('/api/mixes/'+encodeURIComponent(id)+'?_method=DELETE', { method:'POST', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 5) DELETE —Å body
    t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    let status = t ? t.status : '–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞';
    let body = '';
    try {
      const ct = t && t.headers ? (t.headers.get('content-type')||'') : '';
      body = t ? (ct.includes('json') ? JSON.stringify(await t.json()) : await t.text()) : '';
    } catch(_) {}
    throw new Error('–£–¥–∞–ª–µ–Ω–∏–µ –º–∏–∫—Å–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å: ' + status + (body ? ' ‚Äî ' + body : ''));
  }

  // ========================= –ü–û–ò–°–ö ==========================================
  function filterFlavorsByQueryAdv(flavors, query){
    function normalize(s){ return String(s||'').toLowerCase().replace(/—ë/g,'–µ').trim(); }
    var q = normalize(query);
    if(!q) return flavors||[];
    var SYN = {"–∫–∏–≤–∏":["kiwi"],"–±–∞–Ω–∞–Ω":["banana"],"–º–∞–Ω–≥–æ":["mango"],"–ª–∏–º–æ–Ω":["lemon","citrus"],"–∞–ø–µ–ª—å—Å–∏–Ω":["orange"],"–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç":["grapefruit"],"–∞—Ä–±—É–∑":["watermelon"],"–¥—ã–Ω—è":["melon"],"–≤–∏–Ω–æ–≥—Ä–∞–¥":["grape"],"–ø–µ—Ä—Å–∏–∫":["peach"],"—è–±–ª–æ–∫":["apple"],"–º–∞—Ä–∞–∫—É–π":["passion"],"–∫–ª—É–±–Ω–∏–∫":["strawberry"],"—á–µ—Ä–Ω–∏–∫":["blueberry"],"–º—è—Ç–∞":["mint"],"–ª–µ–¥":["ice","freeze","frost","cold"],"–≤–∞–Ω–∏–ª—å":["vanilla"],"–ø–µ—á–µ–Ω—å":["cookie","bisc"],"—à–æ–∫–æ–ª–∞–¥":["choco","chocolate"],"–∫–∏—Å–ª":["sour"],"—Å–ª–∞–¥":["sweet"]};
    var tokens = q.split(/\s+/).filter(Boolean);
    function textOf(f){ return normalize([f && f.name, f && f.description, Array.isArray(f && f.tags)? (f.tags.join(' ')) : '' ].join(' ')); }
    return (flavors||[]).filter(function(f){
      var text = textOf(f);
      return tokens.every(function(t){
        var vars = new Set([t]);
        Object.entries(SYN).forEach(function(pair){ var ru=pair[0], arr=pair[1]; if(t.indexOf(ru) !== -1){ arr.forEach(function(v){ vars.add(v); }); } });
        var hit = false; vars.forEach(function(v){ if(text.indexOf(v) !== -1) hit = true; });
        return hit;
      });
    });
  }

  // ========================= –†–ï–ù–î–ï–† =========================================
  function render(){
    var root=document.getElementById('root');
    if(!root) return;

    if(!state.user){
      root.innerHTML = '<div class="min-h-[100svh] flex items-center justify-center p-6 text-sm">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>';
      return;
    }

    if(state.showSplash){
      const logoBlock = state.logoUrl ? '<img src="'+state.logoUrl+'" alt="logo" class="w-24 h-24 rounded-xl object-cover shadow"/>' : (LogoSVG('w-24 h-24'));
      root.innerHTML =
        '<div class="min-h-[100svh] bg-slate-950 text-slate-100 flex items-center justify-center p-6">' +
        '  <div class="w-full max-w-sm text-center shadow rounded-2xl border border-slate-800 bg-slate-900 p-6 space-y-4">' +
        '    <div class="flex items-center justify-center">'+logoBlock+'</div>' +
        '    <div class="text-lg font-bold">–≥–æ—Ç–æ–≤—ã —Å—Ç–∞—Ç—å –∫–∞–ª—å—è–Ω–Ω—ã–º –º–∏–∫—Å–æ–ª–æ–≥–æ–º</div>' +
        '    <button id="goApp" class="inline-flex items-center justify-center rounded-xl h-10 px-4 text-[14px] bg-slate-100 text-slate-900 hover:bg-white">–ø–æ–µ—Ö–∞–ª–∏</button>' +
        '  </div>' +
        '</div>';
      var go=document.getElementById('goApp');
      if(go){ go.addEventListener('click', function(){ state.showSplash=false; render(); }); }
      return;
    }

    var brands = Array.from(new Set((state.flavors||[]).map(function(f){return normalizeBrand(f.brand);}))).filter(Boolean).sort();
    var flavorsOfActive = (state.flavors||[]).filter(function(f){return normalizeBrand(f.brand)===state.activeBrand;});
    var searchedFlavors = filterFlavorsByQueryAdv(state.flavors, state.search);
    var listFlavors = state.search ? searchedFlavors : flavorsOfActive;
    var total = percentSum(state.parts);

    var mixStrength10 = (function(parts, flavors){
      if(!Array.isArray(parts)||!Array.isArray(flavors)) return null;
      var t=percentSum(parts); if(!parts.length||t<=0) return null;
      var w=0; for(var i=0;i<parts.length;i++){
        var p=parts[i]; var pr=safePercent(p && p.percent); if(pr<=0) continue;
        var fl=flavors.find(function(x){return x && x.id===(p && p.flavorId);}); if(!fl) continue;
        w += getStrength10(fl) * (pr/t);
      }
      return w? Math.round(w*10)/10 : null;
    })(state.parts, state.flavors);
    var mixTaste = getMixTasteLabel(state.parts, state.flavors);

    var strengthBadge='';
    if(typeof mixStrength10==='number'){
      var c=strengthColor(mixStrength10);
      strengthBadge='<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+mixStrength10.toFixed(1)+'</span>';
    }

    var brandsHTML = brands.map(function(b){
      return '<button data-brand="'+escAttr(b)+'" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeBrand===b?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">'+escHTML(b)+'</button>';
    }).join('');

    var flavorsHTML = listFlavors.map(function(f){
      var inMix = state.parts.some(function(p){return p.flavorId===f.id;});
      var s = getStrength10(f);
      var c = strengthColor(s);
      var desc = f.description ? '<div class="text-[11px] text-slate-400 truncate">'+escHTML(f.description)+'</div>' : '';
      return (
        '<div class="flex items-center justify-between gap-2 text-sm">' +
          '<div class="min-w-0">' +
            '<div class="flex items-center gap-2">' +
              '<div class="font-medium truncate" title="'+escAttr((f.brand||'')+' ‚Ä¢ '+(f.name||''))+'">'+escHTML(f.name)+' <span class="opacity-60">('+escHTML(f.brand)+')</span></div>' +
              '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+s.toFixed(1)+'</span>' +
            '</div>' +
            desc +
          '</div>' +
          '<button data-add="'+escAttr(f.id)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] '+(inMix?'opacity-50 cursor-not-allowed border border-slate-700':'border border-slate-700 hover:bg-slate-800')+'">'+(inMix?'‚úì':'+')+'</button>' +
        '</div>'
      );
    }).join('');

    var partsHTML = state.parts.map(function(p){
      var fl = state.flavors.find(function(x){return x.id===p.flavorId;});
      var name = (fl && fl.name) || p.flavorId;
      return (
        '<div class="flex items-center gap-2 text-sm">' +
          '<span class="truncate w-36" title="'+escAttr(name)+'">'+escHTML(name)+'</span>' +
          '<input type="range" min="0" max="100" step="5" class="w-28" value="'+safePercent(p.percent)+'" data-range="'+escAttr(p.flavorId)+'"/>' +
          '<span class="w-10 text-right" data-percent-for="'+escAttr(p.flavorId)+'">'+safePercent(p.percent)+'%</span>' +
          '<button data-remove="'+escAttr(p.flavorId)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] hover:bg-slate-800">–£–¥–∞–ª–∏—Ç—å</button>' +
        '</div>'
      );
    }).join('');

    var guestHTML = state.guestMixes.map(function(m){
      var c = typeof m.strength10==='number' ? strengthColor(m.strength10) : strengthColor(null);
      var sBadge = typeof m.strength10==='number' ? '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+m.strength10.toFixed(1)+'</span>' : '';
      var tBadge = m.taste ? '<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(m.taste)+'</span>' : '';
      var notes = m.notes ? '<div class="text-[12px] opacity-80 mt-1">'+escHTML(m.notes)+'</div>' : '';
      var parts = (m.parts||[]).map(function(pp){
        var fl = state.flavors.find(function(x){return x.id===pp.flavorId;});
        return '<div class="flex items-center justify-between text-[12px]"><span class="truncate mr-2">'+escHTML(fl?fl.name:pp.flavorId)+'</span><span class="opacity-70">'+safePercent(pp.percent)+'%</span></div>';
      }).join('');
      var canDelete = !!(state.user && (m.authorId && String(m.authorId)===String(state.user.id)));
      var delBtn = canDelete ? '<button data-del="'+escAttr(m.id)+'" class="ml-auto inline-flex items-center justify-center rounded-xl h-7 px-2 text-[11px] border border-rose-700 text-rose-300 hover:bg-rose-900/40">–£–¥–∞–ª–∏—Ç—å</button>' : '';
      return (
        '<div class="border border-slate-800 rounded-xl p-2 text-sm">' +
          '<div class="flex items-center gap-2">' +
            '<div class="font-semibold truncate">'+escHTML(m.title)+'</div>' +
            sBadge + tBadge + delBtn +
          '</div>' +
          '<div class="text-[11px] text-slate-400">–º–∏–∫—Å –æ—Ç '+escHTML(m.author||'–ì–æ—Å—Ç—å')+'</div>' +
          notes +
          '<div class="mt-1 space-y-0.5">'+parts+'</div>' +
        '</div>'
      );
    }).join('');

    const headerHTML =
      '<header class="flex items-center justify-between">' +
        '<div class="flex items-center gap-2 min-w-0">'+LogoSVG()+'<h1 class="text-lg font-bold truncate">Hookah Mixes</h1></div>' +
        '<div class="flex items-center gap-2">' +
          '<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, '+escHTML(state.user && state.user.name ? state.user.name : '–ì–æ—Å—Ç—å')+'</span>' +
          '<button data-tab="builder" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeTab==='builder'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>' +
          '<button data-tab="guest" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeTab==='guest'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">–ú–∏–∫—Å—ã –≥–æ—Å—Ç–µ–π</button>' +
          (isAdmin()?('<button data-tab="admin" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(state.activeTab==='admin'?'bg-slate-100 text-slate-900':'border border-slate-700 hover:bg-slate-800')+'">–ê–¥–º–∏–Ω</button>'):'') +
        '</div>' +
      '</header>';

    const brandsBlock =
      '<div class="rounded-2xl border border-slate-800 bg-slate-900">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">–ë—Ä–µ–Ω–¥—ã</div></div>' +
        '<div class="p-3 space-y-2">' +
          '<div class="space-y-2">' +
            '<input id="search" placeholder="–ü–æ–∏—Å–∫ –≤–∫—É—Å–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶" value="'+escAttr(state.search||'')+'" class="h-9 w-full rounded-xl border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 px-3 text-sm outline-none focus:ring-2 focus:ring-slate-600" />' +
            '<div class="grid grid-cols-2 gap-1">'+brandsHTML+(brands.length===0?'<div class="text-[12px] text-slate-400">–ù–µ—Ç –±—Ä–µ–Ω–¥–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ –≤–∫—É—Å—ã)</div>':'')+'</div>' +
          '</div>' +
          '<div id="flavorsMeta" class="text-[11px] text-slate-400">'+(state.search ? ('–ù–∞–π–¥–µ–Ω–æ: '+listFlavors.length) : (state.activeBrand ? ('–í–∫—É—Å—ã –±—Ä–µ–Ω–¥–∞: '+escHTML(state.activeBrand)) : ''))+'</div>' +
          '<div id="flavorsList">'+flavorsHTML+(listFlavors.length===0?('<div class="text-[12px] text-slate-400">'+(state.search?'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ':'–ù–µ—Ç –≤–∫—É—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–µ–Ω–¥–∞')+'</div>'):'')+'</div>' +
        '</div>' +
      '</div>';

    const mixBlock =
      '<div class="rounded-2xl border border-slate-800 bg-slate-900" id="mixBlock">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">–ú–∏–∫—Å</div></div>' +
        '<div class="p-3 space-y-2">' +
          (state.parts.length===0?'<div class="text-[12px] text-slate-400">–î–æ–±–∞–≤—å—Ç–µ –≤–∫—É—Å—ã –∏–∑ —Å–ø–∏—Å–∫–∞</div>':'') +
          partsHTML +
          '<div class="flex items-center justify-between text-[12px]">' +
            '<span>–ò—Ç–æ–≥: <b id="mixTotal">'+total+'</b>%</span>' +
            '<div class="flex items-center gap-2">' +
              '<span id="mixStrength">'+strengthBadge+'</span>' +
              '<span id="mixTaste">'+(mixTaste?('<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(mixTaste)+'</span>'):'')+'</span>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

    const titleBlock =
      '<div class="rounded-2xl border border-slate-800 bg-slate-900">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ</div></div>' +
        '<div class="p-3 space-y-2">' +
          '<input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–∫—Å–∞" value="'+escAttr(state.title||'')+'" class="h-9 w-full rounded-xl border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 px-3 text-sm outline-none focus:ring-2 focus:ring-slate-600" />' +
          '<textarea id="notes" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –∑–∞–º–µ—Ç–∫–∏‚Ä¶" class="min-h-[72px] w-full rounded-xl border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-600">'+escHTML(state.notes||'')+'</textarea>' +
          '<div class="flex gap-2">' +
            '<button id="reset" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-slate-700 hover:bg-slate-800">–°–±—Ä–æ—Å</button>' +
            '<button id="save" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] '+(isMixValid(state.parts,state.title)?'bg-slate-100 text-slate-900':'opacity-50 cursor-not-allowed border border-slate-700')+'">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' +
          '</div>' +
        '</div>' +
      '</div>';

    const adminBlock = (!isAdmin() ? '' :
      ('<div class="rounded-2xl border border-slate-800 bg-slate-900">' +
       '  <div class="px-3 pt-3"><div class="text-xs font-semibold">–ê–¥–º–∏–Ω</div></div>' +
       '  <div class="p-3 space-y-4 text-sm">' +
       '    <div class="text-[11px] text-slate-400">–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –≤–∫—É—Å—ã.</div>' +
       '    <div class="grid grid-cols-1 gap-2">' +
       '      <input id="admBrand" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="–ë—Ä–µ–Ω–¥" />' +
       '      <input id="admName" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />' +
       '      <input id="admTags" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />' +
       '      <input id="admStrength" type="number" min="1" max="10" class="h-9 rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å 1‚Äì10 (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />' +
       '      <textarea id="admDesc" class="min-h-[72px] rounded-xl border border-slate-700 bg-slate-900 px-3 py-2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>' +
       '    </div>' +
       '    <div class="flex gap-2">' +
       '      <button id="admAddFlavor" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] bg-slate-100 text-slate-900 hover:bg-white">–î–æ–±–∞–≤–∏—Ç—å –≤–∫—É—Å</button>' +
       '      <button id="admReload" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-slate-700 hover:bg-slate-800">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>' +
       '      <button id="admClearToken" class="ml-auto inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-rose-700 text-rose-300 hover:bg-rose-900/40">–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏</button>' +
       '    </div>' +
       '    <div>' +
       '      <div class="text-xs font-semibold mb-2">–í—Å–µ –≤–∫—É—Å—ã</div>' +
       '      <div id="admFlavorList" class="space-y-1"></div>' +
       '    </div>' +
       '  </div>' +
       '</div>')
    );

    const adminLoginBlock = (!isAdmin() && state.adminPrompt) ? (
      '<div class="rounded-2xl border border-slate-800 bg-slate-900">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">–ê–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø</div></div>' +
        '<div class="p-3 space-y-2">' +
          '<input id="admToken" class="h-9 w-full rounded-xl border border-slate-700 bg-slate-900 px-3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ X-Admin-Token" />' +
          '<div class="flex gap-2">' +
            '<button id="admSaveToken" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] bg-slate-100 text-slate-900 hover:bg-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>' +
            '<button id="admCancel" class="inline-flex items-center justify-center rounded-xl h-9 px-3 text-[12px] border border-slate-700 hover:bg-slate-800">–°–∫—Ä—ã—Ç—å</button>' +
          '</div>' +
          '<div id="admMsg" class="text-[11px] text-slate-400">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –≤–∫–ª–∞–¥–∫–∞ ¬´–ê–¥–º–∏–Ω¬ª.</div>' +
        '</div>' +
      '</div>'
    ) : '';

    const guestBlock =
      '<div class="rounded-2xl border border-slate-800 bg-slate-900">' +
        '<div class="px-3 pt-3"><div class="text-xs font-semibold">–ú–∏–∫—Å—ã –≥–æ—Å—Ç–µ–π</div></div>' +
        '<div class="p-3 space-y-2">' +
          (state.guestMixes.length===0?'<div class="text-[12px] text-slate-400">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–∏–∫—Å–æ–≤</div>':'') +
          guestHTML +
        '</div>' +
      '</div>';

    const bodyHTML =
      '<div class="min-h-[100svh] bg-slate-950 text-slate-100 p-3">' +
        '<div class="mx-auto w-full max-w-md space-y-3">' +
          headerHTML +
          (state.activeTab==='builder' ? (adminLoginBlock + brandsBlock + mixBlock + titleBlock) : '') +
          (state.activeTab==='guest'   ? (guestBlock) : '') +
          (state.activeTab==='admin'   ? (adminBlock) : '') +
        '</div>' +
      '</div>';

    root.innerHTML = bodyHTML;

    // ===== –°–æ–±—ã—Ç–∏—è =====
    Array.prototype.forEach.call(root.querySelectorAll('[data-tab]'), function(btn){
      btn.addEventListener('click', async function(){
        state.activeTab = this.getAttribute('data-tab');
        if (state.activeTab === 'guest') { await loadGuestMixes(); }
        render();
      });
    });
    Array.prototype.forEach.call(root.querySelectorAll('[data-brand]'), function(btn){
      btn.addEventListener('click', function(){ state.activeBrand = this.getAttribute('data-brand'); state.search=''; render(); });
    });
    var search = root.querySelector('#search');
    if(search){ search.addEventListener('input', function(e){ state.search = e.target.value; updateSearchUI(); }); }
    bindAddButtons();
    attachMixEvents();

    var titleEl=root.querySelector('#title'); if(titleEl){ titleEl.addEventListener('input', function(e){ state.title = e.target.value; }); }
    var notesEl=root.querySelector('#notes'); if(notesEl){ notesEl.addEventListener('input', function(e){ state.notes = e.target.value; }); }
    var resetEl=root.querySelector('#reset'); if(resetEl){ resetEl.addEventListener('click', function(){ state.title=''; state.notes=''; state.parts=[]; render(); }); }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∏–∫—Å–∞
    var saveEl=root.querySelector('#save');
    if(saveEl){
      saveEl.addEventListener('click', async function(){
        if(!isMixValid(state.parts, state.title)) return;
        if(!state.user) return;

        var mix={
          id:uuidv4(),
          title:String(state.title).trim(),
          parts: state.parts.slice(),
          notes:String(state.notes||'').trim(),
          author: state.user.name || '–ì–æ—Å—Ç—å',
          authorId: state.user.id || null,
          createdAt: Date.now(),
          taste: getMixTasteLabel(state.parts, state.flavors) || null,
          strength10: (function(){ var t=percentSum(state.parts); if(!t) return null; var w=0; for(var i=0;i<state.parts.length;i++){ var p=state.parts[i]; var pr=safePercent(p.percent); if(pr<=0) continue; var fl=state.flavors.find(function(x){return x && x.id===p.flavorId;}); if(!fl) continue; w+=getStrength10(fl)*(pr/t);} return w?Math.round(w*10)/10:null; })()
        };

        try{
          var r=await api('/api/mixes',{method:'POST',body:JSON.stringify(mix)});
          if(!r.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∏–∫—Å ('+r.status+'): '+(await r.text().catch(()=>''))); return; }
          await loadGuestMixes();
          state.title=''; state.notes=''; state.parts=[]; state.activeTab='guest';
          render();
        }catch(e){
          console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
      });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –º–∏–∫—Å–∞
    root.querySelectorAll('[data-del]').forEach(function(btn){
      btn.addEventListener('click', async function(){
        const id = btn.getAttribute('data-del');
        if (!id) return;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–∏–∫—Å?')) return;
        try{
          await deleteMixOnServer(id, state.user);
          await loadGuestMixes();
          render();
        }catch(e){
          console.error(e); alert((e && e.message) ? e.message : '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
      });
    });

    // –ê–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/—Å–∫—Ä—ã—Ç—å)
    var tokBtn = root.querySelector('#admSaveToken');
    if (tokBtn){
      tokBtn.addEventListener('click', function(){
        var v = (root.querySelector('#admToken')||{}).value || '';
        try{ localStorage.setItem('admin_token', v); }catch(_){}
        state.adminToken = v || "";
        state.adminPrompt = false;
        state.activeTab = 'admin';
        render();
      });
    }
    var tokCancel = root.querySelector('#admCancel');
    if (tokCancel){
      tokCancel.addEventListener('click', function(){ state.adminPrompt = false; render(); });
    }

    // –ê–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫–∞
    if (isAdmin() && state.activeTab === 'admin'){
      buildAdminFlavorList(root);

      var btnReload = root.querySelector('#admReload');
      if (btnReload){
        btnReload.addEventListener('click', async function(){
          await loadFlavors();
          state.activeBrand = state.activeBrand || (state.flavors[0] && state.flavors[0].brand) || '';
          render();
        });
      }
      var btnLogout = root.querySelector('#admClearToken');
      if (btnLogout){
        btnLogout.addEventListener('click', function(){
          try{ localStorage.removeItem('admin_token'); }catch(_){}
          state.adminToken = "";
          state.activeTab = 'builder';
          render();
        });
      }
      var btnAdd = root.querySelector('#admAddFlavor');
      if (btnAdd){
        btnAdd.addEventListener('click', async function(){
          var brand = (root.querySelector('#admBrand')||{}).value||'';
          var name  = (root.querySelector('#admName')||{}).value||'';
          var tags  = (root.querySelector('#admTags')||{}).value||'';
          var desc  = (root.querySelector('#admDesc')||{}).value||'';
          var str10 = (root.querySelector('#admStrength')||{}).value||'';
          if (!brand.trim() || !name.trim()){ alert('–£–∫–∞–∂–∏—Ç–µ –±—Ä–µ–Ω–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
          var payload = {
            id: (brand.trim()+'-'+name.trim()).replace(/\s+/g,'-').toLowerCase(),
            brand: brand.trim(),
            name: name.trim(),
            description: desc.trim() || undefined,
            tags: tags ? tags.split(',').map(function(s){return s.trim();}).filter(Boolean) : undefined,
            strength10: str10 ? Number(str10) : undefined
          };
          try{
            var r = await api('/api/flavors', {
              method:'POST',
              headers: { 'X-Admin-Token': state.adminToken || '' },
              body: JSON.stringify(payload)
            });
            if (!r.ok){
              var txt = await r.text().catch(function(){return '';});
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å ('+r.status+'): '+txt);
              return;
            }
            await loadFlavors();
            state.activeBrand = state.activeBrand || (state.flavors[0] && state.flavors[0].brand) || '';
            render();
          }catch(e){
            console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤–∫—É—Å–∞');
          }
        });
      }
    }
  }

  // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–∫—É—Å–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ + —É–¥–∞–ª–µ–Ω–∏–µ
  function buildAdminFlavorList(root){
    var list = root.querySelector('#admFlavorList');
    if (!list) return;
    var byBrand = {};
    (state.flavors||[]).forEach(function(f){
      var b = (f.brand||'').trim() || '–ë–µ–∑ –±—Ä–µ–Ω–¥–∞';
      (byBrand[b]||(byBrand[b]=[])).push(f);
    });

    var html = Object.keys(byBrand).sort().map(function(brand){
      var rows = byBrand[brand].sort(function(a,b){ return a.name.localeCompare(b.name, 'ru'); })
        .map(function(f){
          return (
            '<div class="flex items-center justify-between gap-2 text-[12px] border border-slate-800 rounded-lg px-2 py-1">' +
              '<div class="min-w-0 truncate"><span class="opacity-70">'+escHTML(brand)+'</span> ‚Ä¢ '+escHTML(f.name)+'</div>' +
              '<button data-del-flavor="'+escAttr(f.id)+'" class="inline-flex items-center justify-center h-7 px-2 rounded-md border border-rose-700 text-rose-300 hover:bg-rose-900/40">–£–¥–∞–ª–∏—Ç—å</button>' +
            '</div>'
          );
        }).join('');
      return (
        '<div class="space-y-1">' +
          '<div class="text-[11px] uppercase tracking-wide text-slate-400">'+escHTML(brand)+'</div>' +
          rows +
        '</div>'
      );
    }).join('') || '<div class="text-[12px] text-slate-400">–ü–æ–∫–∞ –Ω–µ—Ç –≤–∫—É—Å–æ–≤</div>';
    list.innerHTML = html;

    root.querySelectorAll('[data-del-flavor]').forEach(function(btn){
      btn.addEventListener('click', async function(){
        var id = btn.getAttribute('data-del-flavor');
        if (!id) return;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤–∫—É—Å "'+id+'"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
        try{
          await deleteFlavorOnServer(id, state.adminToken || '');
          await loadFlavors();
          if (!state.flavors.some(function(f){ return normalizeBrand(f.brand)===state.activeBrand; })) {
            state.activeBrand = (state.flavors[0] && state.flavors[0].brand) || '';
          }
          render();
        } catch(e){
          console.error(e);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤–∫—É—Å. ' + (e && e.message ? e.message : ''));
        }
      });
    });
  }

  // ======= –ß–∞—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI =======
  function updateMixStatsUI(){
    var total = percentSum(state.parts);
    var totalEl = document.getElementById('mixTotal'); if(totalEl) totalEl.textContent = String(total);
    var t = percentSum(state.parts); var w=0; if(t>0){ for(var i=0;i<state.parts.length;i++){ var p=state.parts[i]; var pr=safePercent(p.percent); if(pr<=0) continue; var fl=state.flavors.find(function(x){return x && x.id===p.flavorId;}); if(fl) w += getStrength10(fl) * (pr/t); } }
    var strength = w? Math.round(w*10)/10 : null;
    var sEl = document.getElementById('mixStrength'); if(sEl){ if(typeof strength==='number'){ var c=strengthColor(strength); sEl.innerHTML = '<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+strength.toFixed(1)+'</span>'; } else { sEl.innerHTML=''; } }
    var taste = getMixTasteLabel(state.parts, state.flavors);
    var tEl = document.getElementById('mixTaste'); if(tEl){ tEl.innerHTML = taste ? ('<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(taste)+'</span>') : ''; }
  }

  function bindAddButtons(){
    var list = document.getElementById('flavorsList'); if(!list) return;
    Array.prototype.forEach.call(list.querySelectorAll('[data-add]'), function(btn){
      btn.addEventListener('click', function(){
        var id=this.getAttribute('data-add');
        if(!id) return; if(state.parts.some(function(p){return p.flavorId===id;})) return;
        var def=Math.min(30, Math.max(0, 100 - percentSum(state.parts)));
        state.parts = state.parts.concat([{ flavorId:id, percent:def }]);
        rerenderMixBlock();
        updateSearchUI();
      });
    });
  }

  function attachMixEvents(){
    Array.prototype.forEach.call(document.querySelectorAll('[data-range]'), function(sl){
      sl.addEventListener('input', function(){
        var id=this.getAttribute('data-range');
        var req=safePercent(this.value);
        var newParts = state.parts.map(function(p){ return p.flavorId===id ? { flavorId:p.flavorId, percent: clampPercentForPart(state.parts, id, req) } : p; });
        var newVal = newParts.find(function(p){return p.flavorId===id;}).percent;
        state.parts = newParts;
        if (newVal !== req) { this.value = newVal; }
        updateMixStatsUI();
        var span = document.querySelector('[data-percent-for="'+id+'"]');
        if(span) span.textContent = newVal + '%';
      });
    });
    Array.prototype.forEach.call(document.querySelectorAll('[data-remove]'), function(btn){
      btn.addEventListener('click', function(){ var id=this.getAttribute('data-remove'); state.parts = state.parts.filter(function(p){return p.flavorId!==id;}); rerenderMixBlock(); });
    });
  }

  function rerenderMixBlock(){
    var container = document.getElementById('mixBlock'); if(!container) return;
    var total = percentSum(state.parts);
    var strength = (function(){ var t=percentSum(state.parts); if(!t) return null; var w=0; for(var i=0;i<state.parts.length;i++){ var p=state.parts[i]; var pr=safePercent(p.percent); if(pr<=0) continue; var fl=state.flavors.find(function(x){return x && x.id===p.flavorId;}); if(!fl) continue; w+=getStrength10(fl)*(pr/t);} return w?Math.round(w*10)/10:null; })();
    var strengthBadge=''; if(typeof strength==='number'){ var c=strengthColor(strength); strengthBadge='<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+strength.toFixed(1)+'</span>'; }
    var mixTaste = getMixTasteLabel(state.parts, state.flavors);
    var partsHTML = state.parts.map(function(p){ var fl = state.flavors.find(function(x){return x.id===p.flavorId;}); var name=(fl && fl.name)||p.flavorId; return (
      '<div class="flex items_center gap-2 text-sm">'.replace('items_center','items-center') +
        '<span class="truncate w-36" title="'+escAttr(name)+'">'+escHTML(name)+'</span>' +
        '<input type="range" min="0" max="100" step="5" class="w-28" value="'+safePercent(p.percent)+'" data-range="'+escAttr(p.flavorId)+'"/>' +
        '<span class="w-10 text-right" data-percent-for="'+escAttr(p.flavorId)+'">'+safePercent(p.percent)+'%</span>' +
        '<button data-remove="'+escAttr(p.flavorId)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] hover:bg-slate-800">–£–¥–∞–ª–∏—Ç—å</button>' +
      '</div>'
    ); }).join('');
    var html =
      '<div class="px-3 pt-3"><div class="text-xs font-semibold">–ú–∏–∫—Å</div></div>' +
      '<div class="p-3 space-y-2">' +
        (state.parts.length===0?'<div class="text-[12px] text-slate-400">–î–æ–±–∞–≤—å—Ç–µ –≤–∫—É—Å—ã –∏–∑ —Å–ø–∏—Å–∫–∞</div>':'') +
        partsHTML +
        '<div class="flex items-center justify-between text-[12px]">' +
          '<span>–ò—Ç–æ–≥: <b id="mixTotal">'+total+'</b>%</span>' +
          '<div class="flex items-center gap-2"><span id="mixStrength">'+strengthBadge+'</span><span id="mixTaste">'+(mixTaste?('<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] border border-slate-700 bg-slate-900">'+escHTML(mixTaste)+'</span>'):'')+'</span></div>' +
        '</div>' +
      '</div>';
    container.innerHTML = html;
    attachMixEvents();
  }

  function updateSearchUI(){
    var meta = document.getElementById('flavorsMeta');
    var list = document.getElementById('flavorsList');
    if(!meta || !list) return;
    var flavorsOfActive = (state.flavors||[]).filter(function(f){return normalizeBrand(f.brand)===state.activeBrand;});
    var searchedFlavors = filterFlavorsByQueryAdv(state.flavors, state.search);
    var listFlavors = state.search ? searchedFlavors : flavorsOfActive;
    meta.textContent = state.search ? ('–ù–∞–π–¥–µ–Ω–æ: '+listFlavors.length) : (state.activeBrand ? ('–í–∫—É—Å—ã –±—Ä–µ–Ω–¥–∞: '+state.activeBrand) : '');
    list.innerHTML = listFlavors.map(function(f){
      var inMix = state.parts.some(function(p){return p.flavorId===f.id;});
      var s = getStrength10(f); var c = strengthColor(s);
      var desc = f.description ? '<div class="text-[11px] text-slate-400 truncate">'+escHTML(f.description)+'</div>':'';
      return (
        '<div class="flex items-center justify-between gap-2 text-sm">' +
          '<div class="min-w-0">' +
            '<div class="flex items-center gap-2">' +
              '<div class="font-medium truncate" title="'+escAttr((f.brand||'')+' ‚Ä¢ '+(f.name||''))+'">'+escHTML(f.name)+' <span class="opacity-60">('+escHTML(f.brand)+')</span></div>' +
              '<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border '+c.bg+' '+c.text+' '+c.border+'">'+s.toFixed(1)+'</span>' +
            '</div>' +
            desc +
          '</div>' +
          '<button data-add="'+escAttr(f.id)+'" class="inline-flex items-center justify-center rounded-xl h-8 px-2 text-[12px] '+(inMix?'opacity-50 cursor-not-allowed border border-slate-700':'border border-slate-700 hover:bg-slate-800')+'">'+(inMix?'‚úì':'+')+'</button>' +
        '</div>'
      );
    }).join('') + (listFlavors.length===0?('<div class="text-[12px] text-slate-400">'+(state.search?'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ':'–ù–µ—Ç –≤–∫—É—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–µ–Ω–¥–∞')+'</div>'):'');
    bindAddButtons();
  }

  // ========================= –°–¢–ê–†–¢ ==========================================
  (async function start(){
    try{
      initAuth();
      await detectLogo();
      await loadFlavors();
      await loadGuestMixes();
      render();

      // –ü–æ–ª–ª–∏–Ω–≥ –º–∏–∫—Å–æ–≤
      setInterval(async function(){
        const before = JSON.stringify(state.guestMixes?.map(function(m){return m.id;}));
        await loadGuestMixes();
        const after  = JSON.stringify(state.guestMixes?.map(function(m){return m.id;}));
        if (before !== after) render();
      }, 10000);
    }catch(e){ console.error(e); }
  })();

  // ========================= SMOKE TESTS ====================================
  ;(function(){ try{
    console.group('HookahMixes ‚Äì smoke tests');
    {var p1=[{flavorId:'a',percent:60},{flavorId:'b',percent:40}]; console.assert(percentSum(p1)===100,'sum=100');}
    {var p2=[{flavorId:'a',percent:60},{flavorId:'b',percent:30}]; console.assert(percentSum(p2)===90,'sum=90');}
    {var ok=isMixValid([{flavorId:'a',percent:60},{flavorId:'b',percent:40}], 'Mix'); console.assert(ok===true,'valid=100+title');}
    {var cl=clampPercentForPart([{flavorId:'a',percent:90},{flavorId:'b',percent:0}], 'b', 20); console.assert(cl===10,'clamp remaining');}
    {var cl2=clampPercentForPart([{flavorId:'a',percent:50}], 'a', 150); console.assert(cl2===100,'clamp max');}
    {var r=filterFlavorsByQueryAdv([{id:'1',name:'Mango'},{id:'2',name:'Ice'},{id:'3',name:'Ice Mango'}], 'mango'); console.assert(r.length===2,'search across brands');}
    {var t=getMixTasteLabel([],[]); console.assert(t===null,'taste null');}
    {var cl3=clampPercentForPart([{flavorId:'a',percent:10}], 'a', -5); console.assert(cl3===0,'clamp to 0');}
    console.groupEnd();
  }catch(e){ console.error('Smoke tests error', e); }})();
  </script>

<!-- === BANNED WORDS ADMIN UI (floating button + modal) === -->
<style>
  .bw-fab{position:fixed;right:18px;bottom:18px;z-index:50;border-radius:9999px;padding:10px 14px;font-weight:600;background:#111;color:#fff;box-shadow:0 6px 14px rgba(0,0,0,.15);opacity:.9}
  .bw-fab:hover{opacity:1}
  .bw-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:60}
  .bw-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:70}
  .bw-card{width:min(800px,92vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .bw-head{padding:16px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .bw-body{padding:16px 20px}
  .bw-foot{padding:12px 20px;border-top:1px solid #eee;display:flex;gap:12px;justify-content:flex-end}
  .bw-input, .bw-textarea{width:100%;border:1px solid #ddd;border-radius:10px;padding:10px 12px;font:inherit}
  .bw-textarea{min-height:220px;resize:vertical;white-space:pre}
  .bw-btn{border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .bw-btn.primary{background:#111;color:#fff}
  .bw-btn.secondary{background:#f2f2f2}
  .bw-note{font-size:12px;color:#666;margin-top:6px}
</style>

<button id="bw-fab" class="bw-fab" title="–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞">–°–ª–æ–≤–∞ üö´</button>
<div id="bw-back" class="bw-back"></div>
<div id="bw-modal" class="bw-modal" aria-hidden="true">
  <div class="bw-card">
    <div class="bw-head">
      <div style="font-weight:700">–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞</div>
      <button class="bw-btn secondary" id="bw-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="bw-body">
      <p>–ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ ‚Äî —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ <em>–≤—Ö–æ–∂–¥–µ–Ω–∏—é</em> (—Ä–µ–≥–∏—Å—Ç—Ä –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è).</p>
      <textarea id="bw-words" class="bw-textarea" spellcheck="false" placeholder="–ø—Ä–∏–º–µ—Ä:&#10;—Å–ø–∞–π—Å&#10;–Ω–∞—Ä–∫–æ—Ç–∏–∫"></textarea>
      <div class="bw-note">–°–æ–≤–µ—Ç: –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ –ø–æ–¥—Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–µ–≥–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞.</div>
      <div style="margin-top:14px">
        <label style="font-size:12px;color:#666">Admin Token (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)</label>
        <input id="bw-token" class="bw-input" type="password" placeholder="X-Admin-Token">
      </div>
    </div>
    <div class="bw-foot">
      <button class="bw-btn secondary" id="bw-reload">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞</button>
      <button class="bw-btn primary" id="bw-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';
  var openBtn = document.getElementById('bw-fab');
  var modal   = document.getElementById('bw-modal');
  var back    = document.getElementById('bw-back');
  var closeBtn= document.getElementById('bw-close');
  var saveBtn = document.getElementById('bw-save');
  var reloadBtn = document.getElementById('bw-reload');
  var wordsTA = document.getElementById('bw-words');
  var tokenI  = document.getElementById('bw-token');

  function show(){ modal.style.display='flex'; back.style.display='block'; modal.setAttribute('aria-hidden','false'); }
  function hide(){ modal.style.display='none'; back.style.display='none'; modal.setAttribute('aria-hidden','true'); }

  async function reloadServer(){
    try{
      const r = await fetch('/api/banned-words');
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      const arr = Array.isArray(data.words) ? data.words : [];
      wordsTA.value = arr.join('\\n');
      alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ' + arr.length + ' —à—Ç.');
    }catch(e){
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e && e.message || e));
    }
  }

  async function save(){
    const token = String(tokenI.value||'').trim();
    if(!token){ alert('–í–≤–µ–¥–∏—Ç–µ Admin Token'); return; }
    const list = wordsTA.value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
    try{
      const r = await fetch('/api/banned-words', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'X-Admin-Token': token },
        body: JSON.stringify({ words: list })
      });
      if(!r.ok){
        let err={}; try{ err = await r.json(); }catch(_){}
        throw new Error(err && err.error || ('HTTP '+r.status));
      }
      const data = await r.json();
      alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + (data.words ? data.words.length : list.length) + ' —à—Ç.');
      // –ß—Ç–æ–±—ã –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ä–∞–∑—É –ø–æ–¥—Ö–≤–∞—Ç–∏–ª—Å—è –≤ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É.
      location.reload();
    }catch(e){
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (e && e.message || e));
    }
  }

  openBtn && openBtn.addEventListener('click', function(){ reloadServer().finally(show); });
  closeBtn && closeBtn.addEventListener('click', hide);
  back && back.addEventListener('click', hide);
  reloadBtn && reloadBtn.addEventListener('click', reloadServer);
  saveBtn && saveBtn.addEventListener('click', save);
})();
</script>

</body>
</html>
