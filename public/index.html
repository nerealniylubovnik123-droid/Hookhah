<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Hookah Mixes — Admin & Guest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --border:#1f2a44; --text:#e5e7eb; --muted:#9ca3af;
      --green:#10b981; --green2:#065f46; --rose:#f43f5e; --rose2:#7f1d1d;
      --accent:#60a5fa; --accent2:#1e3a8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg, #0a0f1f 0%, #0f172a 100%); color:var(--text);
    }
    .container{max-width:980px; margin:0 auto; padding:20px}
    h1{margin:0 0 12px 0; font-size:22px}
    h2{margin:24px 0 10px 0; font-size:18px}
    .row{display:flex; gap:14px; flex-wrap:wrap}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow:0 6px 24px rgba(0,0,0,.25)
    }
    .w-half{flex:1 1 480px; min-width:320px}
    .w-full{flex:1 1 100%}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px}
    input, textarea, select{
      width:100%; background:#0b1020; color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:10px; outline:none;
    }
    input:focus, textarea:focus{border-color:#29406e; box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      height:36px; padding:0 12px; border-radius:10px; border:1px solid var(--border);
      background:#0e1527; color:var(--text); cursor:pointer;
    }
    .btn:hover{background:#121b33}
    .btn-primary{border-color:#1f3b86; background:#122457}
    .btn-primary:hover{background:#162c6a}
    .btn-danger{border-color:var(--rose2); color:#fecaca}
    .btn-danger:hover{background:#2a0e15}
    .btn-green{border-color:#0b5d4b; color:#bbf7d0}
    .btn-green:hover{background:#0f2e26}
    .toolbar{display:flex; gap:10px; align-items:end; flex-wrap:wrap}
    .list{display:grid; gap:12px}
    .mix-card{
      border:1px solid var(--border); border-radius:14px; padding:12px; background:#0c1326;
    }
    .mix-head{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .badges{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .badge{font-size:11px; padding:2px 8px; border:1px solid #2b3d63; color:#c7d2fe; border-radius:999px}
    .muted{color:var(--muted)}
    .hr{height:1px; background:var(--border); margin:10px 0}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; height:28px; padding:0 10px; border-radius:999px; border:1px solid var(--border)}
    .like-btn{display:inline-flex; align-items:center; height:28px; padding:0 10px; border-radius:999px; border:1px solid #324064; cursor:pointer}
    .like-btn.liked{border-color:#14532d; color:#bbf7d0; background:#0a1f17}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{border-bottom:1px dashed var(--border); padding:8px; text-align:left}
    .table th{font-weight:600; color:#cbd5e1}
    .right{margin-left:auto}
    .flex{display:flex; gap:8px; align-items:center}
    .spacer{flex:1}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Hookah Mixes</h1>

    <!-- Панель администратора / пользователя -->
    <div class="card w-full">
      <div class="toolbar">
        <div style="min-width:240px; flex:1">
          <label>Admin token (для операций админа)</label>
          <div class="flex">
            <input id="admTok" type="password" placeholder="X-Admin-Token" />
            <button id="saveTok" class="btn btn-primary">Сохранить</button>
            <button id="clearTok" class="btn">Очистить</button>
          </div>
          <div class="small muted" id="admState"></div>
        </div>

        <div style="min-width:220px">
          <label>Ваш userId (для лайков и удаления своего)</label>
          <div class="flex">
            <input id="userId" type="text" placeholder="например, user123" />
            <button id="saveUser" class="btn btn-green">ОК</button>
          </div>
          <div class="small muted">Будет отправляться в заголовках X-User-Id/X-Author-Id</div>
        </div>

        <div class="spacer"></div>

        <button id="refresh" class="btn">Обновить данные</button>
      </div>
    </div>

    <div class="row">
      <!-- Вкусы -->
      <div class="card w-half">
        <h2>Вкусы</h2>
        <div class="toolbar">
          <div style="flex:1; min-width:200px">
            <label>Brand</label>
            <input id="flBrand" type="text" placeholder="DarkSide" />
          </div>
          <div style="flex:1; min-width:200px">
            <label>Name</label>
            <input id="flName" type="text" placeholder="Cola" />
          </div>
        </div>
        <div class="toolbar" style="margin-top:8px">
          <button id="addFlavor" class="btn btn-green">+ Добавить вкус (админ)</button>
          <button id="delFlavor" class="btn btn-danger">Удалить вкус (админ)</button>
        </div>
        <div class="hr"></div>
        <div id="flavorsBox" class="list"></div>
      </div>

      <!-- Миксы -->
      <div class="card w-half">
        <h2>Гостевые миксы</h2>

        <div class="grid">
          <div>
            <label>Заголовок</label>
            <input id="mixTitle" type="text" placeholder="Мой топовый микс" />
          </div>
          <div>
            <label>Автор (имя)</label>
            <input id="mixAuthor" type="text" placeholder="Ваше имя" />
          </div>
          <div>
            <label>Части (свободный текст)</label>
            <input id="mixParts" type="text" placeholder="50% XYZ, 30% ABC, 20% DEF" />
          </div>
          <div>
            <label>Заметки</label>
            <input id="mixNotes" type="text" placeholder="на льду, с апельсином..." />
          </div>
        </div>

        <div class="toolbar" style="margin-top:8px">
          <button id="addMix" class="btn btn-green">+ Добавить микс</button>
        </div>

        <div class="hr"></div>
        <div id="mixesBox" class="list"></div>
      </div>
    </div>
  </div>

  <script>
  // ======== Состояние и утилиты =========
  const state = {
    adminToken: localStorage.getItem('adminToken') || '',
    user: { id: localStorage.getItem('userId') || '' },
    flavors: [],
    mixes: [],
  };

  function isAdmin(){ return !!state.adminToken && state.adminToken.length > 0 }

  function escHTML(s){
    return String(s==null?'':s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }
  function escAttr(s){ return escHTML(s).replace(/"/g,'&quot;') }

  async function api(url, opts){
    opts = opts || {};
    opts.headers = opts.headers || {};
    // если есть тело и не указан тип — ставим JSON
    if (opts.body && !opts.headers['Content-Type']) {
      opts.headers['Content-Type'] = 'application/json';
    }
    return fetch(url, opts);
  }

  // ======== ФЛЕЙВОРЫ =========
  async function loadFlavors(){
    const r = await api('/api/flavors');
    state.flavors = await r.json().catch(()=>[]);
  }

  function flavorId(brand, name){
    return (String(brand)+'-'+String(name))
      .toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9\-._]+/g,'');
  }

  async function addFlavor(){
    const brand = document.getElementById('flBrand').value.trim();
    const name  = document.getElementById('flName').value.trim();
    if(!brand || !name){ alert('Укажите brand и name'); return }
    if(!isAdmin()){ alert('Нужен Admin token'); return }

    const r = await api('/api/flavors', {
      method:'POST',
      headers:{ 'X-Admin-Token': state.adminToken },
      body: JSON.stringify({ brand, name })
    });
    const data = await r.json().catch(()=>null);
    if(!r.ok){ alert('Ошибка добавления вкуса: '+r.status+' '+(data && data.error || '')); return }
    await loadFlavors(); renderFlavors();
  }

  async function deleteFlavor(){
    const brand = document.getElementById('flBrand').value.trim();
    const name  = document.getElementById('flName').value.trim();
    if(!brand || !name){ alert('Укажите brand и name'); return }
    if(!isAdmin()){ alert('Нужен Admin token'); return }

    // A) старый способ по action:'delete'
    let r = await api('/api/flavors', {
      method:'POST',
      headers:{ 'X-Admin-Token': state.adminToken, 'Content-Type':'application/json' },
      body: JSON.stringify({ action:'delete', brand, name })
    }).catch(()=>null);

    // B) fallback: DELETE по id
    if(!r || !r.ok){
      r = await api('/api/flavors/'+encodeURIComponent(flavorId(brand,name)), {
        method:'DELETE',
        headers:{ 'X-Admin-Token': state.adminToken }
      }).catch(()=>null);
    }
    // C) fallback: DELETE по brand+name
    if(!r || !r.ok){
      r = await api('/api/flavors/by-brand-name?brand='+encodeURIComponent(brand)+'&name='+encodeURIComponent(name), {
        method:'DELETE',
        headers:{ 'X-Admin-Token': state.adminToken }
      }).catch(()=>null);
    }
    if(!r || !r.ok){
      let body=''; try{ body = r ? await r.text() : '' }catch(_){}
      alert('Удаление вкуса не удалось: '+(r?r.status:'нет ответа')+' '+body); return;
    }
    await loadFlavors(); renderFlavors();
  }

  function renderFlavors(){
    const box = document.getElementById('flavorsBox');
    if(!state.flavors || !state.flavors.length){
      box.innerHTML = '<div class="muted">Нет данных</div>'; return;
    }
    let html = '<table class="table"><thead><tr><th>Brand</th><th>Name</th><th>ID</th></tr></thead><tbody>';
    for(const f of state.flavors){
      const id = f.id || flavorId(f.brand, f.name);
      html += '<tr>'+
        '<td>'+escHTML(f.brand)+'</td>'+
        '<td>'+escHTML(f.name)+'</td>'+
        '<td class="small muted">'+escHTML(id)+'</td>'+
      '</tr>';
    }
    html += '</tbody></table>';
    box.innerHTML = html;
  }

  // ======== МИКСЫ =========
  async function loadGuestMixes(){
    const r = await api('/api/mixes');
    state.mixes = await r.json().catch(()=>[]);
  }

  async function addMix(){
    const title  = document.getElementById('mixTitle').value.trim() || 'Без названия';
    const author = document.getElementById('mixAuthor').value.trim();
    const parts  = document.getElementById('mixParts').value.trim();
    const notes  = document.getElementById('mixNotes').value.trim();
    const authorId = state.user.id || '';

    const body = {
      title, author, authorId,
      parts: parts ? parts.split(',').map(s=>s.trim()).filter(Boolean) : [],
      notes
    };
    const r = await api('/api/mixes', {
      method:'POST',
      body: JSON.stringify(body)
    });
    if(!r.ok){ alert('Ошибка добавления микса'); return }
    document.getElementById('mixTitle').value = '';
    document.getElementById('mixAuthor').value = '';
    document.getElementById('mixParts').value = '';
    document.getElementById('mixNotes').value = '';
    await loadGuestMixes(); renderMixes();
  }

  // Удаление микса (админ — любой, автор — свой)
  async function deleteMixOnServer(id, user){
    const uid = String(user && user.id || '');
    const headers = {
      'X-Author-Id': uid,
      'X-User-Id': uid,
      ...(isAdmin() ? { 'X-Admin-Token': (state.adminToken || '') } : {})
    };

    // 1) DELETE /api/mixes/:id
    let t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 2) DELETE /api/mixes/:id?authorId=...
    t = await api('/api/mixes/'+encodeURIComponent(id)+'?authorId='+encodeURIComponent(uid), { method:'DELETE', headers }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 3) POST /api/mixes/delete { id, authorId }
    t = await api('/api/mixes/delete', { method:'POST', headers, body: JSON.stringify({ id, authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 4) POST override _method=DELETE
    t = await api('/api/mixes/'+encodeURIComponent(id)+'?_method=DELETE', { method:'POST', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    // 5) DELETE с body
    t = await api('/api/mixes/'+encodeURIComponent(id), { method:'DELETE', headers, body: JSON.stringify({ authorId: uid }) }).catch(()=>null);
    if (t && (t.ok || t.status===204)) return true;

    return false;
  }

  function renderMixes(){
    const box = document.getElementById('mixesBox');
    if(!state.mixes || !state.mixes.length){
      box.innerHTML = '<div class="muted">Пока миксов нет</div>'; return;
    }
    box.innerHTML = state.mixes.map(m=>{
      const canDelete = !!( (state.user && m.authorId && String(m.authorId)===String(state.user.id)) || isAdmin() );
      const delBtn = canDelete
        ? '<button class="btn btn-danger small" data-del="'+escAttr(m.id)+'">Удалить</button>' : '';

      const likesCount = Number(m.likes||0);
      const youLike = Array.isArray(m.likedBy) && state.user && m.likedBy.includes(String(state.user.id));
      const likeBtnClass = 'like-btn'+(youLike?' liked':'');
      const likeBtn =
        '<button class="'+likeBtnClass+'" data-like="'+escAttr(m.id)+'">❤ <span data-like-count="'+escAttr(m.id)+'" style="margin-left:4px">'+likesCount+'</span></button>';

      const sBadge = (m.strength10!=null) ? '<span class="badge">Крепость: '+escHTML(m.strength10)+'/10</span>' : '';
      const tBadge = (m.taste!=null) ? '<span class="badge">Вкус: '+escHTML(m.taste)+'</span>' : '';

      return `
        <div class="mix-card">
          <div class="mix-head">
            <div class="flex">
              <div class="pill" title="Автор">
                👤&nbsp;${escHTML(m.author || 'Гость')}
              </div>
              <div class="pill muted">id: ${escHTML(m.id)}</div>
            </div>
            <div class="actions">${likeBtn} ${delBtn}</div>
          </div>
          <div class="hr"></div>
          <div class="flex">
            <div class="badge" style="border-color:#2b3d63;color:#c7d2fe">${escHTML(m.title || 'Без названия')}</div>
            ${sBadge} ${tBadge}
          </div>
          ${m.parts && m.parts.length ? `<div class="small muted" style="margin-top:6px">Части: ${escHTML(m.parts.join(', '))}</div>` : ``}
          ${m.notes ? `<div class="small" style="margin-top:6px">Заметки: ${escHTML(m.notes)}</div>` : ``}
        </div>
      `;
    }).join('');

    // навесим обработчики
    // удаление
    box.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-del');
        if(!id) return;
        if(!confirm('Удалить микс?')) return;
        const ok = await deleteMixOnServer(id, state.user);
        if(!ok){ alert('Удаление не удалось'); return }
        await loadGuestMixes(); renderMixes();
      });
    });

    // лайк / анлайк
    box.querySelectorAll('[data-like]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-like');
        if(!id) return;
        const uid = String(state.user && state.user.id || 'anon');
        try{
          const r = await api('/api/mixes/'+encodeURIComponent(id)+'/like', {
            method:'POST',
            headers:{ 'X-User-Id': uid }
          });
          const data = await r.json().catch(()=>null);
          if(r.ok && data && data.ok){
            await loadGuestMixes(); renderMixes();
          }else{
            alert('Не удалось поставить лайк');
          }
        }catch(e){
          alert('Ошибка сети при лайке');
        }
      });
    });
  }

  // ======== Инициализация UI =========
  function renderTop(){
    document.getElementById('admTok').value = state.adminToken || '';
    document.getElementById('userId').value = state.user.id || '';
    const s = document.getElementById('admState');
    s.textContent = isAdmin() ? 'Режим админа активен' : 'Админ-токен не задан';
  }

  async function init(){
    // кнопки/инпуты
    document.getElementById('saveTok').addEventListener('click', ()=>{
      const v = document.getElementById('admTok').value.trim();
      state.adminToken = v; localStorage.setItem('adminToken', v);
      renderTop();
    });
    document.getElementById('clearTok').addEventListener('click', ()=>{
      state.adminToken = ''; localStorage.removeItem('adminToken');
      document.getElementById('admTok').value = '';
      renderTop();
    });
    document.getElementById('saveUser').addEventListener('click', ()=>{
      const v = document.getElementById('userId').value.trim();
      state.user.id = v; localStorage.setItem('userId', v);
      renderTop();
    });
    document.getElementById('refresh').addEventListener('click', async ()=>{
      await loadFlavors(); renderFlavors();
      await loadGuestMixes(); renderMixes();
    });

    document.getElementById('addFlavor').addEventListener('click', addFlavor);
    document.getElementById('delFlavor').addEventListener('click', deleteFlavor);

    document.getElementById('addMix').addEventListener('click', addMix);

    // первичная подгрузка
    renderTop();
    await loadFlavors(); renderFlavors();
    await loadGuestMixes(); renderMixes();
  }

  init();
  </script>
</body>
</html>
