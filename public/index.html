<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c0f" />
  <title>Hookah Mixes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0c0f; --card:#12141a; --border:#243142; --text:#e5e7eb; --muted:#94a3b8;
      --ac1:#f59e0b; --ac2:#fdba74;
    }
    body{
      background:
        radial-gradient(900px 800px at 10% -10%, rgba(245,158,11,.12), transparent 60%),
        radial-gradient(700px 500px at 95% 0, rgba(253,186,116,.07), transparent 55%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .ui-card{background:rgba(18,20,26,.82); border:1px solid rgba(148,163,184,.18); border-radius:1rem}
    .btn{border:1px solid var(--border); border-radius:.75rem; height:36px; padding:0 12px; font-size:12px}
    .btn-primary{border:0; background:linear-gradient(90deg,var(--ac1),var(--ac2)); color:#0b0c0f; font-weight:700; border-radius:.75rem; height:36px; padding:0 12px; font-size:12px}
    .chip{border:1px solid var(--border); border-radius:.75rem; padding:.25rem .5rem; font-size:12px}
    input,textarea,select{background:#0f1218; border:1px solid var(--border); border-radius:.75rem; padding:.5rem .75rem}
    a{color:#f8b14f}
  </style>

  <!-- Ранний обработчик ошибок -->
  <script>
    (function(){
      function showFatal(msg){
        var root = document.getElementById('root');
        if (!root) return;
        root.innerHTML =
          '<div class="min-h-[100svh] flex items-center justify-center p-6">' +
          '  <div class="max-w-md w-full rounded-xl border border-rose-800 bg-rose-950 p-4 text-sm">' +
          '    <div class="font-bold mb-2 text-rose-200">Произошла ошибка</div>' +
          '    <div class="text-rose-100/90 whitespace-pre-wrap break-words">' + String(msg || 'Unknown error') + '</div>' +
          '  </div>' +
          '</div>';
      }
      window.addEventListener('error', function(e){
        var m = (e && (e.message || (e.error && e.error.message))) || 'Script error';
        showFatal(m);
      });
      window.addEventListener('unhandledrejection', function(e){
        var m = (e && (e.reason && (e.reason.message || e.reason))) || 'Unhandled rejection';
        showFatal(m);
      });
    })();
  </script>
</head>
<body class="min-h-[100svh]">
  <div id="root" class="max-w-3xl mx-auto p-3"></div>

<script>
// =================== Helper ===================
const API_BASE = '';
const api = (path, opts = {}) => fetch(API_BASE + path, {
  cache: 'no-store',
  ...opts,
  headers: {
    'Content-Type': 'application/json; charset=UTF-8',
    ...(opts.headers || {})
  }
});
const esc = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const norm = s => String(s||'').toLowerCase().replace(/ё/g,'е');

// =================== State ===================
const state = {
  user: null,
  flavors: [],
  guestMixes: [],
  parts: [],
  title: '',
  notes: '',
  activeTab: 'builder', // builder | community | admin
  adminToken: localStorage.getItem('admin_token') || '',
  // stop-words список мы не держим постоянно — подгружаем перед сохранением
};

function initUser(){
  try{
    const u = window?.Telegram?.WebApp?.initDataUnsafe?.user;
    if (u){
      const name = [u.first_name,u.last_name].filter(Boolean).join(' ') || u.username || ('User '+u.id);
      state.user = { id:String(u.id), name, username:u.username };
      return;
    }
  }catch(_) {}
  state.user = { id:'anon', name:'Гость' };
}

// =================== API calls ===================
async function loadFlavors(){
  const r = await api('/api/flavors');
  state.flavors = r.ok ? await r.json() : [];
}
async function loadGuestMixes(){
  try{
    const r = await api('/api/mixes');
    state.guestMixes = r.ok ? (await r.json()) : [];
    // normalize likers/likedBy + likesCount
    state.guestMixes = state.guestMixes.map(m => {
      if (!Array.isArray(m.likers)  && Array.isArray(m.likedBy)) m.likers  = m.likedBy.slice();
      if (!Array.isArray(m.likedBy) && Array.isArray(m.likers))  m.likedBy = m.likers.slice();
      const count = Array.isArray(m.likedBy) ? m.likedBy.length
                   : (Array.isArray(m.likers) ? m.likers.length
                   : (Number(m.likesCount)||0));
      m.likesCount = count;
      return m;
    });
  }catch(_){
    state.guestMixes=[];
  }
}
async function toggleLikeOnServer(mixId){
  const r = await api(`/api/mixes/${encodeURIComponent(mixId)}/like`, {
    method:'POST',
    headers:{ 'X-User-Id': state.user?.id || 'anon' }
  });
  if (!r.ok) throw new Error('like '+r.status);
  return r.json();
}
async function deleteMixOnServer(mixId){
  const r = await api(`/api/mixes/${encodeURIComponent(mixId)}`, {
    method:'DELETE',
    headers:{ 'X-User-Id': state.user?.id || '' }
  });
  if (!r.ok) throw new Error('delete '+r.status);
}
async function saveMixOnServer(mix){
  const r = await api('/api/mixes', { method:'POST', body: JSON.stringify(mix) });
  if (!r.ok){
    try{
      const d = await r.json();
      if (d && d.error === 'banned_word') throw new Error('Запрещённое слово: '+d.word);
    }catch(_) {}
    throw new Error('save '+r.status);
  }
}
async function loadStopWords(){
  const r = await api('/api/stop-words', { cache:'no-store' });
  if (!r.ok) return [];
  const d = await r.json();
  return Array.isArray(d.words) ? d.words : [];
}
async function saveStopWords(words){
  const token = (document.getElementById('admToken')?.value || state.adminToken || '').trim();
  const r = await api('/api/stop-words', {
    method:'POST',
    headers:{ 'X-Admin-Token': token },
    body: JSON.stringify({ words })
  });
  if (!r.ok) throw new Error('HTTP '+r.status);
}

// =================== Mix logic ===================
const safePct = v => Math.max(0, Math.min(100, Number(v)||0));
const percentSum = parts => (parts||[]).reduce((s,p)=>s+safePct(p?.percent),0);
const isMixValid = (parts, title) => percentSum(parts)===100 && String(title||'').trim().length>=3;

function strength10OfFlavor(f){
  if (!f) return 5;
  if (typeof f.strength10 === 'number' && Number.isFinite(f.strength10)) return Math.max(1, Math.min(10, f.strength10));
  return 5;
}
function mixStrength10(parts, flavors){
  if (!Array.isArray(parts)||!Array.isArray(flavors)||!parts.length) return null;
  const t = percentSum(parts); if(t<=0) return null; let w=0;
  for(const p of parts){
    const pr=safePct(p?.percent); if(pr<=0) continue;
    const fl=flavors.find(x=>x&&x.id===(p&&p.flavorId)); if(!fl) continue;
    w += strength10OfFlavor(fl)*(pr/t);
  }
  return w? Math.round(w*10)/10 : null;
}
function hasBannedLocal(title, notes, words){
  try{
    const hay = norm(String(title||'')+'\n'+String(notes||''));
    return (Array.isArray(words)?words:[]).find(w => hay.includes(norm(w))) || null;
  }catch(_){ return null; }
}

// =================== Render ===================
function render(){
  const total = percentSum(state.parts);
  const mS = mixStrength10(state.parts, state.flavors);
  const sBadge = (typeof mS==='number') ? ('<span class="chip">'+mS.toFixed(1)+'</span>') : '';

  const mixHTML = `
    <div class="ui-card p-3">
      <div class="text-[10px] uppercase text-slate-300/70">Сборка</div>
      <div class="flex items-center justify-between">
        <div class="font-semibold">Ваш микс</div>
        <div>${sBadge}</div>
      </div>

      <div class="mt-2 space-y-2" id="parts">
        ${state.parts.map(p=>{
          const fl=state.flavors.find(x=>x.id===p.flavorId);
          const nm = fl ? (esc(fl.brand)+' — '+esc(fl.name)) : esc(p.flavorId);
          return `
            <div class="flex items-center gap-2 text-sm">
              <span class="truncate w-48" title="${nm}">${nm}</span>
              <input type="range" min="0" max="100" step="5" class="w-32" value="${safePct(p.percent)}" data-range="${esc(p.flavorId)}"/>
              <span class="w-10 text-right" data-percent-for="${esc(p.flavorId)}">${safePct(p.percent)}%</span>
              <button data-remove="${esc(p.flavorId)}" class="btn">Удалить</button>
            </div>`;
        }).join('') || '<div class="text-sm text-slate-400">Добавьте вкусы из списка ниже</div>'}
      </div>

      <div class="mt-2 text-sm flex items-center justify-between">
        <span>Итог: <b id="mixTotal">${total}</b>%</span>
      </div>

      <div class="mt-3 grid gap-2">
        <input id="title" class="w-full" placeholder="Название микса" value="${esc(state.title)}"/>
        <textarea id="notes" class="w-full" placeholder="Комментарий" rows="3">${esc(state.notes)}</textarea>
        <button id="save" class="btn-primary">${isMixValid(state.parts,state.title)?'Сохранить':'Заполните 100% и название'}</button>
      </div>
    </div>
  `;

  const flavorsHTML = (state.flavors||[]).map(f=>{
    const inMix = state.parts.some(p=>p.flavorId===f.id);
    const s = strength10OfFlavor(f);
    return `
      <div class="flex items-center justify-between gap-2 text-sm border border-slate-800 rounded-lg px-2 py-1">
        <div class="min-w-0">
          <div class="truncate font-medium">${esc(f.brand || '')} — ${esc(f.name || 'Без названия')}</div>
          ${f.description ? `<div class="text-[11px] opacity-70">${esc(f.description)}</div>`: ''}
        </div>
        <div class="flex items-center gap-2">
          <span class="chip" title="Крепость">${s}</span>
          <button data-add="${esc(f.id)}" class="btn">${inMix?'В миксе':'Добавить'}</button>
        </div>
      </div>`;
  }).join('');

  const guestHTML = (state.guestMixes||[]).map(m=>{
    const likes = (typeof m.likesCount==='number' ? m.likesCount
                 : (Array.isArray(m.likedBy)? m.likedBy.length
                    : (Array.isArray(m.likers)? m.likers.length : 0)));
    const isMine = (state.user && m.authorId && String(m.authorId)===String(state.user.id));
    return `
      <div class="flex items-center justify-between gap-2 text-sm border border-slate-800 rounded-lg px-2 py-1">
        <div class="min-w-0">
          <div class="truncate font-medium">${esc(m.title)}</div>
          <div class="text-[11px] opacity-70">${likes} ❤</div>
        </div>
        <div class="flex items-center gap-2">
          <button data-like="${esc(m.id)}" class="btn">❤</button>
          <button data-apply="${esc(m.id)}" class="btn">Загрузить</button>
          ${ isMine ? `<button data-del="${esc(m.id)}" class="btn">Удалить</button>` : '' }
        </div>
      </div>`;
  }).join('');

  const adminHTML = `
    <div class="ui-card p-3">
      <div class="text-[10px] uppercase text-slate-300/70">Админ</div>

      <div class="font-semibold mb-2">Доступ</div>
      <div class="grid gap-2 mb-4">
        <input id="admToken" class="w-full" placeholder="X-Admin-Token" value="${esc(state.adminToken)}"/>
        <div class="flex gap-2">
          <button id="admSaveToken" class="btn-primary">Сохранить токен</button>
          <button id="admClearToken" class="btn">Выйти</button>
        </div>
      </div>

      <div class="font-semibold mb-2">Запрещённые слова</div>
      <div class="grid gap-2 mb-4">
        <textarea id="admWords" rows="6" placeholder="каждое слово — с новой строки"></textarea>
        <div class="flex gap-2">
          <button id="admLoadWords" class="btn">Загрузить</button>
          <button id="admSaveWords" class="btn-primary">Сохранить</button>
        </div>
        <div class="text-[11px] opacity-70">Проверка: по вхождению (регистр игнорируется). Применяется и к уже сохранённым миксам.</div>
      </div>

      <div class="font-semibold mb-2">Добавить вкус</div>
      <div class="grid gap-2">
        <input id="admBrand" placeholder="Бренд"/>
        <input id="admName"  placeholder="Название"/>
        <input id="admTags"  placeholder="Теги (через запятую)"/>
        <input id="admStrength" type="number" min="1" max="10" placeholder="Крепость 1–10 (необязательно)"/>
        <textarea id="admDesc" rows="3" placeholder="Описание (необязательно)"></textarea>
        <button id="admAddFlavor" class="btn-primary">Добавить вкус</button>
      </div>
      <div class="mt-3">
        <button id="admReload" class="btn">Обновить список вкусов</button>
      </div>
    </div>
  `;

  const navHTML = `
    <div class="flex gap-2 mb-3">
      <button data-tab="builder" class="btn ${state.activeTab==='builder'?'btn-primary':''}">Сборка</button>
      <button data-tab="community" class="btn ${state.activeTab==='community'?'btn-primary':''}">Комьюнити</button>
      <button data-tab="admin" class="btn ${state.activeTab==='admin'?'btn-primary':''}">Админ</button>
    </div>
  `;

  const body = `
    ${navHTML}

    ${state.activeTab==='builder' ? `
      <div class="grid gap-3">
        ${mixHTML}
        <div class="ui-card p-3">
          <div class="text-[10px] uppercase text-slate-300/70">Вкусы</div>
          <div class="grid gap-2 mt-2">${flavorsHTML || '<div class="text-sm text-slate-400">Пока нет вкусов</div>'}</div>
        </div>
      </div>
    ` : ''}

    ${state.activeTab==='community' ? `
      <div class="ui-card p-3">
        <div class="text-[10px] uppercase text-slate-300/70">Комьюнити</div>
        <div class="grid gap-2 mt-2">${guestHTML || '<div class="text-sm text-slate-400">Пока нет</div>'}</div>
      </div>
    ` : ''}

    ${state.activeTab==='admin' ? adminHTML : ''}
  `;

  document.getElementById('root').innerHTML = body;

  // -------- tabs --------
  document.querySelectorAll('[data-tab]').forEach(b=>{
    b.addEventListener('click', ()=>{ state.activeTab = b.getAttribute('data-tab'); render(); });
  });

  // -------- parts controls --------
  document.querySelectorAll('[data-add]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-add');
      const inMix = state.parts.some(p=>p.flavorId===id);
      if (!inMix){
        const left = Math.max(0, 100 - percentSum(state.parts));
        const addPct = Math.min(30, left || 20);
        state.parts = state.parts.concat([{ flavorId:id, percent:addPct }]);
        render();
      }
    });
  });
  document.querySelectorAll('[data-remove]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-remove');
      state.parts = state.parts.filter(p=>p.flavorId!==id);
      render();
    });
  });
  document.querySelectorAll('[data-range]').forEach(r=>{
    r.addEventListener('input', ()=>{
      const id = r.getAttribute('data-range');
      const v = safePct(r.value);
      const other = percentSum(state.parts.filter(x=>x.flavorId!==id));
      const nv = Math.max(0, Math.min(100-other, v));
      state.parts = state.parts.map(p=>p.flavorId===id? {...p, percent:nv } : p);
      render();
    });
  });

  // -------- inputs --------
  const titleEl = document.getElementById('title'); if (titleEl) titleEl.addEventListener('input', ()=>{ state.title = titleEl.value; });
  const notesEl = document.getElementById('notes'); if (notesEl) notesEl.addEventListener('input', ()=>{ state.notes = notesEl.value; });

  // -------- save mix --------
  const saveBtn = document.getElementById('save');
  if (saveBtn) saveBtn.addEventListener('click', async ()=>{
    if (!isMixValid(state.parts,state.title)) return;

    // Локальная проверка запрещённых слов (название + описание)
    try{
      const words = await loadStopWords();
      const bad = hasBannedLocal(state.title, state.notes, words);
      if (bad){ alert('Запрещённое слово: '+bad); return; }
    }catch(_){} // сервер всё равно проверит

    try{
      await saveMixOnServer({
        title: state.title,
        parts: state.parts.map(p=>({ flavorId:p.flavorId, percent:safePct(p.percent) })),
        notes: state.notes,
        author: state.user?.name || 'Гость',
        authorId: state.user?.id || null
      });
      await loadGuestMixes();
      state.parts=[]; state.title=''; state.notes='';
      state.activeTab='community';
      render();
    }catch(e){ alert(e.message || 'Не удалось сохранить'); }
  });

  // -------- community actions --------
  document.querySelectorAll('[data-like]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      try{
        await toggleLikeOnServer(b.getAttribute('data-like'));
        await loadGuestMixes(); render();
      }catch(_){ alert('Не удалось обновить лайк'); }
    });
  });
  document.querySelectorAll('[data-apply]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const m = state.guestMixes.find(x=>x.id===b.getAttribute('data-apply'));
      if (!m) return;
      state.parts = Array.isArray(m.parts) ? m.parts.map(p=>({ flavorId:p.flavorId, percent:safePct(p.percent) })) : [];
      state.title = (m.title || '') + ' (копия)';
      state.notes = m.notes || '';
      state.activeTab='builder';
      render();
    });
  });
  document.querySelectorAll('[data-del]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      if (!confirm('Удалить микс?')) return;
      try{
        await deleteMixOnServer(b.getAttribute('data-del'));
        await loadGuestMixes(); render();
      }catch(_){ alert('Не удалось удалить'); }
    });
  });

  // -------- admin --------
  const tokInput = document.getElementById('admToken');
  if (tokInput){
    tokInput.addEventListener('input', ()=>{
      state.adminToken = tokInput.value;
      try{ localStorage.setItem('admin_token', state.adminToken); }catch(_){}
    });
  }
  const tokBtn = document.getElementById('admSaveToken');
  if (tokBtn) tokBtn.addEventListener('click', ()=>{
    const v = (document.getElementById('admToken')||{}).value || '';
    try{ localStorage.setItem('admin_token', v); }catch(_){}
    state.adminToken = v;
    alert('Токен сохранён');
  });
  const tokClear = document.getElementById('admClearToken');
  if (tokClear) tokClear.addEventListener('click', ()=>{
    try{ localStorage.removeItem('admin_token'); }catch(_){}
    state.adminToken=''; render();
  });

  const wLoad = document.getElementById('admLoadWords');
  if (wLoad) wLoad.addEventListener('click', async ()=>{
    try{
      const arr = await loadStopWords();
      const ta = document.getElementById('admWords');
      if (ta) ta.value = arr.join('\n');
    }catch(_){ alert('Не удалось загрузить список'); }
  });

  const wSave = document.getElementById('admSaveWords');
  if (wSave) wSave.addEventListener('click', async ()=>{
    const raw = (document.getElementById('admWords')||{}).value || '';
    const words = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    try{
      await saveStopWords(words);
      alert('Сохранено: '+words.length);
      // сервер сам удалит нарушающие миксы
      await loadGuestMixes(); render();
    }catch(_){ alert('Не удалось сохранить слова — проверьте токен.'); }
  });

  const addFlavor = document.getElementById('admAddFlavor');
  if (addFlavor) addFlavor.addEventListener('click', async ()=>{
    const payload = {
      brand: (document.getElementById('admBrand')||{}).value?.trim() || '',
      name:  (document.getElementById('admName')||{}).value?.trim()  || '',
      tags:  ((document.getElementById('admTags')||{}).value || '').split(',').map(s=>s.trim()).filter(Boolean),
      strength10: Number((document.getElementById('admStrength')||{}).value || '') || undefined,
      description: (document.getElementById('admDesc')||{}).value?.trim() || undefined,
    };
    if (!payload.brand || !payload.name){ alert('Укажите бренд и название'); return; }
    try{
      const tokenNow = (document.getElementById('admToken')?.value || state.adminToken || '').trim();
      const r = await api('/api/flavors', {
        method:'POST',
        headers:{ 'X-Admin-Token': tokenNow },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('HTTP '+r.status);
      await loadFlavors();
      alert('Вкус добавлен');
      render();
    }catch(_){ alert('Не удалось добавить вкус — проверьте токен'); }
  });

  const reloadFl = document.getElementById('admReload');
  if (reloadFl) reloadFl.addEventListener('click', async ()=>{ await loadFlavors(); render(); });
}

// =================== Start ===================
(async function start(){
  initUser();
  await Promise.all([loadFlavors(), loadGuestMixes()]);
  render();

  // авто-обновление гостевых миксов раз в 10с
  setInterval(async ()=>{
    const before = JSON.stringify(state.guestMixes?.map(m=>m.id));
    await loadGuestMixes();
    const after  = JSON.stringify(state.guestMixes?.map(m=>m.id));
    if (before !== after) render();
  }, 10000);
})();
</script>
</body>
</html>
