<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hookah Mixes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0c0f; --card:#12141a; --border:#243142; --text:#e5e7eb; --muted:#94a3b8;
      --ring:#f59e0b; --ac1:#f59e0b; --ac2:#fdba74;
    }
    body{background:radial-gradient(900px 800px at 10% -10%,rgba(245,158,11,.12),transparent 60%),
                 radial-gradient(700px 500px at 95% 0, rgba(253,186,116,.07),transparent 55%),
                 var(--bg); color:var(--text)}
    .ui-card{background:rgba(18,20,26,.82); border:1px solid rgba(148,163,184,.18); border-radius:1rem}
    .btn{border:1px solid var(--border); border-radius:.75rem; height:36px; padding:0 12px; font-size:12px}
    .btn-primary{position:relative; border:0; background:linear-gradient(90deg,var(--ac1),var(--ac2)); color:#0b0c0f; font-weight:700}
    .chip{border:1px solid var(--border); border-radius:.75rem; padding:.25rem .5rem; font-size:12px}
    input,textarea,select{background:#0f1218; border:1px solid var(--border); border-radius:.75rem; padding:.5rem .75rem}
    a{color:#f8b14f}
  </style>
</head>
<body class="min-h-[100svh]">
  <div id="root" class="max-w-3xl mx-auto p-3"></div>

<script>
// -------------------- Helper --------------------
const API_BASE = '';
const api = (path, opts={}) => {
  const init = {
    method: opts.method || 'GET',
    headers: { 'Content-Type':'application/json; charset=UTF-8', ...(opts.headers||{}) },
    cache: 'no-store'
  };
  if (opts.body != null) init.body = opts.body;
  return fetch((API_BASE + path), init);
};
const esc = s => String(s||'').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

// -------------------- State --------------------
const state = {
  user: null,
  flavors: [],
  guestMixes: [],
  parts: [],
  title: '',
  notes: '',
  activeTab: 'builder',
  adminToken: localStorage.getItem('admin_token') || '',
  banned: [], // from server
};

function initUser(){
  try{
    const u = window?.Telegram?.WebApp?.initDataUnsafe?.user;
    if (u){
      const name=[u.first_name,u.last_name].filter(Boolean).join(' ')||u.username||('User '+u.id);
      state.user={ id:String(u.id), name, username:u.username };
      return;
    }
  }catch(_){}
  state.user = { id:'anon', name:'Гость' };
}

// -------------------- API --------------------
async function loadFlavors(){
  const r = await api('/api/flavors'); state.flavors = r.ok ? await r.json() : [];
}
async function loadGuestMixes(){
  const r = await api('/api/mixes'); state.guestMixes = r.ok ? await r.json() : [];
}
async function loadBanned(){
  try{ const r = await api('/api/banned-words'); if(r.ok){ const d=await r.json(); state.banned = Array.isArray(d.words)? d.words : []; } }catch(_){ state.banned = []; }
}
async function saveBannedOnServer(words, token){
  const r = await api('/api/banned-words', { method:'PUT', headers:{ 'X-Admin-Token': token||'' }, body: JSON.stringify({ words })});
  if (!r.ok) throw new Error('HTTP '+r.status+' — '+await r.text().catch(()=>'')); // <-- 403 ловим здесь
}

// -------------------- Logic --------------------
const safePct = v => Math.max(0, Math.min(100, Number(v)||0));
const percentSum = parts => (parts||[]).reduce((s,p)=>s+safePct(p?.percent),0);
const isMixValid = (parts, title) => percentSum(parts)===100 && String(title||'').trim().length>=3;

function strength10OfFlavor(f){
  if (!f) return 5;
  if (typeof f.strength10 === 'number' && Number.isFinite(f.strength10)) return Math.max(1, Math.min(10, f.strength10));
  return 5;
}
function mixStrength10(parts, flavors){
  if (!Array.isArray(parts)||!Array.isArray(flavors)||!parts.length) return null;
  const t = percentSum(parts); if(t<=0) return null; let w=0;
  for(const p of parts){
    const pr=safePct(p?.percent); if(pr<=0) continue;
    const fl=flavors.find(x=>x&&x.id===(p&&p.flavorId)); if(!fl) continue;
    w += strength10OfFlavor(fl)*(pr/t);
  }
  return w? Math.round(w*10)/10 : null;
}

function findBanned(text, list){
  try{
    const norm = s=>String(s||'').toLowerCase().replace(/ё/g,'е');
    const t = norm(text);
    const hits = new Set();
    (Array.isArray(list)?list:[]).forEach(w=>{
      const w2 = norm(w);
      if (w2 && t.includes(w2)) hits.add(String(w));
    });
    return Array.from(hits);
  }catch(_){ return []; }
}

// -------------------- Render --------------------
function render(){
  const brands = Array.from(new Set(state.flavors.map(f=>String(f.brand||'').trim()))).filter(Boolean).sort();
  const listFlavors = state.flavors;

  const total = percentSum(state.parts);
  const mS = mixStrength10(state.parts, state.flavors);
  const sBadge = (typeof mS==='number') ? ('<span class="chip">'+mS.toFixed(1)+'</span>') : '';

  const mixHTML = `
    <div class="ui-card p-3">
      <div class="text-[10px] uppercase text-slate-300/70">Сборка</div>
      <div class="flex items-center justify-between">
        <div class="font-semibold">Ваш микс</div>
        <div>${sBadge}</div>
      </div>

      <div class="mt-2 space-y-2" id="parts">
        ${state.parts.map(p=>{
          const fl=state.flavors.find(x=>x.id===p.flavorId);
          const nm = fl ? (esc(fl.brand)+' — '+esc(fl.name)) : esc(p.flavorId);
          return `
            <div class="flex items-center gap-2 text-sm">
              <span class="truncate w-48" title="${nm}">${nm}</span>
              <input type="range" min="0" max="100" step="5" class="w-32" value="${safePct(p.percent)}" data-range="${esc(p.flavorId)}"/>
              <span class="w-10 text-right" data-percent-for="${esc(p.flavorId)}">${safePct(p.percent)}%</span>
              <button data-remove="${esc(p.flavorId)}" class="btn">Удалить</button>
            </div>`;
        }).join('') || '<div class="text-sm text-slate-400">Добавьте вкусы из списка</div>'}
      </div>

      <div class="mt-2 text-sm flex items-center justify-between">
        <span>Итог: <b id="mixTotal">${total}</b>%</span>
      </div>

      <div class="mt-3 grid gap-2">
        <input id="title" class="w-full" placeholder="Название микса" value="${esc(state.title)}"/>
        <textarea id="notes" class="w-full" placeholder="Комментарий" rows="3">${esc(state.notes)}</textarea>
        <button id="save" class="btn-primary">${isMixValid(state.parts,state.title)?'Сохранить':'Заполните 100% и название'}</button>
      </div>
    </div>
  `;

  const brandsHTML = brands.map(b=>`<span class="chip">${esc(b)}</span>`).join(' ');

  const flavorsHTML = listFlavors.map(f=>{
    const inMix = state.parts.some(p=>p.flavorId===f.id);
    const s = strength10OfFlavor(f);
    return `
      <div class="flex items-center justify-between gap-2 text-sm border border-slate-800 rounded-lg px-2 py-1">
        <div class="min-w-0">
          <div class="truncate font-medium">${esc(f.brand || '')} — ${esc(f.name || 'Без названия')}</div>
          ${f.description ? `<div class="text-[11px] opacity-70">${esc(f.description)}</div>`: ''}
        </div>
        <div class="flex items-center gap-2">
          <span class="chip">${s}</span>
          <button data-add="${esc(f.id)}" class="btn">${inMix?'В миксе':'Добавить'}</button>
        </div>
      </div>`;
  }).join('');

  const guestHTML = state.guestMixes.map(m=>`
    <div class="flex items-center justify-between gap-2 text-sm border border-slate-800 rounded-lg px-2 py-1">
      <div class="min-w-0">
        <div class="truncate font-medium">${esc(m.title)}</div>
        <div class="text-[11px] opacity-70">${Array.isArray(m.likedBy)? m.likedBy.length : (Array.isArray(m.likers)? m.likers.length : 0)} ❤</div>
      </div>
      <div class="flex items-center gap-2">
        <button data-apply="${esc(m.id)}" class="btn">Загрузить</button>
        ${ (state.user && m.authorId && String(m.authorId)===String(state.user.id)) ? `<button data-del="${esc(m.id)}" class="btn">Удалить</button>` : ''}
      </div>
    </div>
  `).join('');

  const adminHTML = `
    <div class="ui-card p-3">
      <div class="text-[10px] uppercase text-slate-300/70">Админ</div>
      <div class="font-semibold mb-2">Доступ</div>
      <div class="grid gap-2 mb-4">
        <input id="admToken" class="w-full" placeholder="X-Admin-Token" value="${esc(state.adminToken)}"/>
        <div class="flex gap-2">
          <button id="admSaveToken" class="btn-primary">Сохранить токен</button>
          <button id="admClearToken" class="btn">Выйти</button>
        </div>
      </div>

      <div class="font-semibold mb-2">Запрещенные слова</div>
      <div class="grid gap-2 mb-4">
        <textarea id="admWords" rows="6" placeholder="каждое слово — с новой строки">${esc((state.banned||[]).join('\n'))}</textarea>
        <div class="flex gap-2">
          <button id="admLoadWords" class="btn">Загрузить</button>
          <button id="admSaveWords" class="btn-primary">Сохранить</button>
        </div>
        <div class="text-[11px] opacity-70">Проверка идёт по вхождению (регистр игнорируется).</div>
      </div>

      <div class="font-semibold mb-2">Добавить вкус</div>
      <div class="grid gap-2">
        <input id="admBrand" placeholder="Бренд"/>
        <input id="admName"  placeholder="Название"/>
        <input id="admTags"  placeholder="Теги (через запятую)"/>
        <input id="admStrength" type="number" min="1" max="10" placeholder="Крепкость 1-10 (необязательно)"/>
        <textarea id="admDesc" rows="3" placeholder="Описание (необязательно)"></textarea>
        <button id="admAddFlavor" class="btn-primary">Добавить вкус</button>
      </div>
      <div class="mt-3">
        <button id="admReload" class="btn">Обновить список вкусов</button>
      </div>
    </div>
  `;

  const navHTML = `
    <div class="flex gap-2 mb-3">
      <button data-tab="builder" class="btn ${state.activeTab==='builder'?'btn-primary':''}">Сборка</button>
      <button data-tab="community" class="btn ${state.activeTab==='community'?'btn-primary':''}">Комьюнити</button>
      <button data-tab="admin" class="btn ${state.activeTab==='admin'?'btn-primary':''}">Админ</button>
    </div>
  `;

  const body = `
    ${navHTML}
    ${state.activeTab==='builder' ? (`
      <div class="grid gap-3">
        ${mixHTML}
        <div class="ui-card p-3">
          <div class="text-[10px] uppercase text-slate-300/70">Вкусы</div>
          <div class="mb-2">${brandsHTML}</div>
          <div class="grid gap-2">${flavorsHTML}</div>
        </div>
      </div>
    `) : ''}

    ${state.activeTab==='community' ? (`
      <div class="ui-card p-3">
        <div class="text-[10px] uppercase text-slate-300/70">Комьюнити</div>
        <div class="grid gap-2">${guestHTML || '<div class="text-sm text-slate-400">Пока нет</div>'}</div>
      </div>
    `) : ''}

    ${state.activeTab==='admin' ? adminHTML : ''}
  `;

  document.getElementById('root').innerHTML = body;

  // Events
  document.querySelectorAll('[data-tab]').forEach(b=>{
    b.addEventListener('click', ()=>{ state.activeTab = b.getAttribute('data-tab'); render(); });
  });
  document.querySelectorAll('[data-add]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-add');
      const inMix = state.parts.some(p=>p.flavorId===id);
      if (!inMix){
        const left = Math.max(0, 100 - percentSum(state.parts));
        const addPct = Math.min(30, left || 20);
        state.parts = state.parts.concat([{ flavorId:id, percent:addPct }]);
        render();
      }
    });
  });
  document.querySelectorAll('[data-remove]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-remove');
      state.parts = state.parts.filter(p=>p.flavorId!==id);
      render();
    });
  });
  document.querySelectorAll('[data-range]').forEach(r=>{
    r.addEventListener('input', ()=>{
      const id = r.getAttribute('data-range');
      const v = safePct(r.value);
      const other = percentSum(state.parts.filter(x=>x.flavorId!==id));
      const nv = Math.max(0, Math.min(100-other, v));
      state.parts = state.parts.map(p=>p.flavorId===id? {...p, percent:nv } : p);
      render();
    });
  });
  const titleEl = document.getElementById('title'); if(titleEl) titleEl.addEventListener('input', ()=>{ state.title = titleEl.value; });
  const notesEl = document.getElementById('notes'); if(notesEl) notesEl.addEventListener('input', ()=>{ state.notes = notesEl.value; });

  const saveBtn = document.getElementById('save');
  if (saveBtn) saveBtn.addEventListener('click', async ()=>{
    const hit = [state.title, state.notes].flatMap(t=>findBanned(t, state.banned));
    if (hit.length){
      alert('Запрещённые слова: '+Array.from(new Set(hit)).join(', '));
      return;
    }
    const mix = {
      title: state.title,
      parts: state.parts.map(p=>({ flavorId:p.flavorId, percent:safePct(p.percent) })),
      notes: state.notes,
      author: state.user?.name || 'Гость',
      authorId: state.user?.id || null
    };
    const r = await api('/api/mixes', { method:'POST', body: JSON.stringify(mix) });
    if (!r.ok){
      try{ const d=await r.json(); if (d && d.error==='banned_word'){ alert('Запрещённое слово: '+d.word); return; } }catch(_){}
      alert('Не удалось сохранить микс ('+r.status+')');
      return;
    }
    alert('Сохранено!');
    await loadGuestMixes();
    state.parts=[]; state.title=''; state.notes='';
    state.activeTab='community';
    render();
  });

  // -------------------- Admin actions --------------------
  const tokBtn = document.getElementById('admSaveToken');
  const tokInput = document.getElementById('admToken');
  if (tokInput) {
    // <<< НОВОЕ: обновлять токен на каждый ввод
    tokInput.addEventListener('input', () => {
      state.adminToken = tokInput.value;
      try { localStorage.setItem('admin_token', state.adminToken); } catch(_) {}
    });
  }
  if (tokBtn) tokBtn.addEventListener('click', ()=>{
    const v = document.getElementById('admToken').value || '';
    try{ localStorage.setItem('admin_token', v); }catch(_){}
    state.adminToken = v;
    alert('Токен сохранён');
  });
  const tokClear = document.getElementById('admClearToken');
  if (tokClear) tokClear.addEventListener('click', ()=>{
    try{ localStorage.removeItem('admin_token'); }catch(_){}
    state.adminToken='';
    render();
  });

  const wLoad = document.getElementById('admLoadWords');
  if (wLoad) wLoad.addEventListener('click', async ()=>{
    await loadBanned();
    render();
  });
  const wSave = document.getElementById('admSaveWords');
  if (wSave) wSave.addEventListener('click', async ()=>{
    const raw = document.getElementById('admWords').value || '';
    const words = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    try{
      // <<< НОВОЕ: брать токен прямо из инпута при сохранении
      const tokenNow = (document.getElementById('admToken')?.value || state.adminToken || '').trim();
      await saveBannedOnServer(words, tokenNow);
      state.banned = words;
      alert('Сохранено: '+words.length);
    }catch(e){
      alert('Не удалось сохранить слова — проверьте токен.');
    }
  });

  const addFlavor = document.getElementById('admAddFlavor');
  if (addFlavor) addFlavor.addEventListener('click', async ()=>{
    const payload = {
      brand: (document.getElementById('admBrand').value||'').trim(),
      name:  (document.getElementById('admName').value||'').trim(),
      tags:  (document.getElementById('admTags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      strength10: Number(document.getElementById('admStrength').value||'') || undefined,
      description: (document.getElementById('admDesc').value||'').trim() || undefined,
    };
    if (!payload.brand || !payload.name){ alert('Укажите бренд и название'); return; }
    try{
      // <<< НОВОЕ: брать токен прямо из инпута при добавлении вкуса
      const tokenNow = (document.getElementById('admToken')?.value || state.adminToken || '').trim();
      const r = await api('/api/flavors', { method:'POST', headers:{ 'X-Admin-Token': tokenNow }, body: JSON.stringify(payload) });
      if (!r.ok){
        alert('Ошибка: '+r.status+' — '+await r.text().catch(()=>'')); return;
      }
      await loadFlavors();
      alert('Вкус добавлен');
      render();
    }catch(e){ alert('Не удалось добавить вкус'); }
  });

  const reloadFl = document.getElementById('admReload');
  if (reloadFl) reloadFl.addEventListener('click', async ()=>{ await loadFlavors(); render(); });
}

(async function start(){
  initUser();
  await Promise.all([loadFlavors(), loadGuestMixes(), loadBanned()]);
  render();
})();
</script>
</body>
</html>
