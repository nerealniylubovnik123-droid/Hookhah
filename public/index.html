<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Hookah Mixes</title>
  <style>
    :root{--bg:#0b0b0c;--fg:#f1f1f1;--muted:#9aa0a6;--card:#16171a;--accent:#22c55e;--danger:#ef4444}
    body.light{--bg:#fafafa;--fg:#0b0b0c;--muted:#6b7280;--card:#ffffff}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #2a2b2f}
    .tabs{display:flex;gap:8px;justify-content:space-between;padding:10px}
    .tab{flex:1;padding:10px 12px;border-radius:10px;text-align:center;cursor:pointer;background:#1f2125;color:var(--fg);border:1px solid #2a2b2f}
    .tab.active{outline:2px solid var(--accent);background:#16251b}
    main{padding:14px;max-width:900px;margin:0 auto}
    .card{background:var(--card);border:1px solid #2a2b2f;border-radius:14px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,input,textarea,button{background:#1f2125;color:var(--fg);border:1px solid #2a2b2f;border-radius:10px;padding:10px}
    textarea{width:100%;min-height:80px}
    .btn{cursor:pointer}
    .btn.primary{background:#12341f;border-color:#205f38}
    .btn.primary:disabled{opacity:.6}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a2b2f;background:#1f2125;color:var(--muted);font-size:12px;margin-right:6px}
    .mix{display:flex;gap:10px;justify-content:space-between;align-items:center}
    .mix .meta{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .fab{position:fixed;right:16px;bottom:16px;z-index:50;background:#fff;color:#000;border:none;border-radius:999px;padding:14px 16px;box-shadow:0 6px 24px rgba(0,0,0,.35);font-weight:700;cursor:pointer}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal .sheet{width:min(640px,92vw);background:#fff;color:#000;border-radius:16px;padding:16px}
    .hidden{display:none}
    .danger{background:#2a1010;border-color:#5d2323}
    .like{cursor:pointer;border:none;background:transparent;font-size:22px}
    .like.liked{color:#ff5577}
    .space{height:8px}
    .grid{display:grid;grid-template-columns:1fr 100px 70px auto;gap:8px;align-items:center}
    @media (max-width:640px){.grid{grid-template-columns:1fr 1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="tabs">
      <div class="tab" data-tab="builder">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</div>
      <div class="tab" data-tab="guest">–ì–æ—Å—Ç–µ–≤—ã–µ</div>
      <div class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏/–¢–µ–º–∞</div>
    </div>
  </header>
  <main id="app"></main>

  <!-- Admin FAB -->
  <button id="fab-banned" class="fab">–°–ª–æ–≤–∞ üö´</button>

  <!-- Admin Modal -->
  <div id="modal" class="modal">
    <div class="sheet">
      <h3 style="margin:0 0 8px">–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞</h3>
      <div class="space"></div>
      <div class="row">
        <button class="btn" id="bw-refresh">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞</button>
      </div>
      <div class="space"></div>
      <label class="muted">–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ)</label>
      <textarea id="bw-text"></textarea>
      <div class="space"></div>
      <label class="muted">Admin Token</label>
      <input id="bw-token" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω" type="password">
      <div class="space"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn" id="bw-close">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn primary" id="bw-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // ---- Helpers ----
    function api(path, init){
      return fetch(path, Object.assign({ headers: { 'Content-Type':'application/json' } }, init||{}));
    }
    function norm(s){ return String(s||'').toLowerCase().replace(/—ë/g,'–µ'); }
    function uid(){ return 'anon-' + Math.random().toString(36).slice(2,10); }
    function fmtDate(ts){ try{ return new Date(ts).toLocaleString(); }catch(e){ return '';} }

    // ---- App state ----
    let state = {
      activeTab: 'builder',
      user: { id: localStorage.getItem('user_id') || ('anon-'+Math.random().toString(36).slice(2,10)), name: '–ì–æ—Å—Ç—å' },
      adminToken: localStorage.getItem('admin_token') || '',
      bannedWords: [],
      // builder
      parts: [], // [{id, percent}]
      title: '',
      notes: '',
      taste: null,
      strength10: null,
      // data
      flavors: [],
      guestMixes: []
    };
    if (!localStorage.getItem('user_id')) localStorage.setItem('user_id', state.user.id);

    // ---- UI Rendering ----
    const appEl = document.getElementById('app');

    function render(){
      document.querySelectorAll('.tab').forEach(t=>{
        t.classList.toggle('active', t.dataset.tab === state.activeTab);
      });
      if (state.activeTab === 'builder') renderBuilder();
      else if (state.activeTab === 'guest') renderGuest();
      else renderSettings();
    }

    function renderBuilder(){
      const flavorsOptions = state.flavors.map(f=>`<option value="${f.id}">${escapeHtml(f.brand)} ‚Äî ${escapeHtml(f.name)}</option>`).join('');
      const partsRows = state.parts.map((p,i)=>`
        <div class="grid">
          <select data-role="part-id" data-index="${i}">${optionWithSelected(flavorsOptions, p.id)}</select>
          <input data-role="part-percent" data-index="${i}" type="number" min="0" max="100" value="${p.percent||0}" placeholder="%">
          <button class="btn" data-role="part-up" data-index="${i}">‚ñ≤</button>
          <button class="btn danger" data-role="part-del" data-index="${i}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `).join('');
      const sum = state.parts.reduce((s,p)=>s+Number(p.percent||0),0);

      const recThird = recommendThirdFlavor();
      const recStrength = recommendByStrengthTaste();

      appEl.innerHTML = `
        <div class="card">
          <div class="row">
            <input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–∫—Å–∞ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)" value="${escapeAttr(state.title)}" style="flex:1">
          </div>
          <div class="space"></div>
          <div class="row" style="gap:6px;flex-wrap:nowrap">
            <button class="btn" id="add-part">+ –í–∫—É—Å</button>
            <span class="chip">–°—É–º–º–∞: ${sum}%</span>
            <span class="chip ${sum===100?'':'muted'}">${sum===100?'OK':'–ù—É–∂–Ω–æ 100%'}</span>
          </div>
          <div class="space"></div>
          <div id="parts">${partsRows || '<div class="muted">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∫—É—Å</div>'}</div>
          <div class="space"></div>
          <div class="row">
            <select id="taste">
              <option value="">–¢–µ–≥ –≤–∫—É—Å–∞ (–æ–ø—Ü.)</option>
              ${['—Ñ—Ä—É–∫—Ç–æ–≤—ã–π','—Ü–∏—Ç—Ä—É—Å','–¥–µ—Å–µ—Ä—Ç–Ω—ã–π','—Å–≤–µ–∂–∏–π','–ø—Ä—è–Ω—ã–π','—è–≥–æ–¥–Ω—ã–π','—Ç—Ä–∞–≤—è–Ω–æ–π'].map(t=>`<option ${state.taste===t?'selected':''} value="${t}">${t}</option>`).join('')}
            </select>
            <input id="strength10" type="number" min="1" max="10" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å 1..10" value="${state.strength10??''}">
          </div>
          <div class="space"></div>
          <textarea id="notes" placeholder="–ó–∞–º–µ—Ç–∫–∏...">${escapeHtml(state.notes)}</textarea>
          <div class="space"></div>
          <div class="muted">${recThird ? ('–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º 3-–π: ' + escapeHtml(recThird)) : ''}</div>
          <div class="muted">${recStrength ? ('–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏: ' + escapeHtml(recStrength)) : ''}</div>
          <div class="space"></div>
          <button class="btn primary" id="save" ${isSaveDisabled()?'disabled':''}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      `;
    }

    function renderGuest(){
      const items = state.guestMixes.map(m=>`
        <div class="card">
          <div class="mix">
            <div>
              <div style="font-weight:700">${escapeHtml(m.title)}</div>
              <div class="meta">${fmtDate(m.createdAt)} ‚Ä¢ –ê–≤—Ç–æ—Ä: ${escapeHtml(m.author||'–ì–æ—Å—Ç—å')}</div>
            </div>
            <div class="row">
              <button class="like ${m.likedBy?.includes(state.user.id)?'liked':''}" data-role="like" data-id="${m.id}">‚ô•</button>
              <span>${m.likesCount||0}</span>
              ${canDelete(m) ? `<button class="btn danger" data-role="delete" data-id="${m.id}">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
            </div>
          </div>
          <div class="space"></div>
          <div class="muted">–°–æ—Å—Ç–∞–≤: ${Array.isArray(m.parts)?m.parts.map(p=>prettyPart(p)).join(', '):''}</div>
          ${m.taste?`<div class="chip">–¢–µ–≥: ${escapeHtml(m.taste)}</div>`:''}
          ${m.strength10?`<div class="chip">–ö—Ä–µ–ø–æ—Å—Ç—å: ${m.strength10}/10</div>`:''}
          ${m.notes?`<div style="margin-top:8px">${escapeHtml(m.notes)}</div>`:''}
        </div>
      `).join('');
      appEl.innerHTML = items || `<div class="card muted">–ü–æ–∫–∞ –Ω–µ—Ç –º–∏–∫—Å–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤ ¬´–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä¬ª.</div>`;
    }

    function renderSettings(){
      appEl.innerHTML = `
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:700">–¢–µ–º–∞</div>
              <div class="muted">–°–≤–µ—Ç–ª–∞—è / –¢—ë–º–Ω–∞—è</div>
            </div>
            <select id="theme">
              <option value="dark">–¢—ë–º–Ω–∞—è</option>
              <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
            </select>
          </div>
          <div class="space"></div>
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:700">–í—ã ‚Äî ${escapeHtml(state.user.name)} </div>
              <div class="muted">ID: ${escapeHtml(state.user.id)}</div>
            </div>
            <button class="btn" id="regen-id">–°–º–µ–Ω–∏—Ç—å ID</button>
          </div>
        </div>
      `;
      document.getElementById('theme').value = (localStorage.getItem('theme') || 'dark');
    }

    // ---- Logic ----
    function isMixValid(parts, title, notes, banned){
      const errors = [];
      const sum = parts.reduce((s,p)=>s+Number(p.percent||0),0);
      if (sum !== 100) errors.push('–°—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100');
      if (String(title).trim().length < 3) errors.push('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ');
      const found = new Set();
      const t = norm(title), n = norm(notes);
      (banned||[]).forEach(w=>{
        const ww = norm(w).trim();
        if (!ww) return;
        if (t.includes(ww) || n.includes(ww)) found.add(ww);
      });
      if (found.size) errors.push('–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: ' + Array.from(found).join(', '));
      return { ok: errors.length===0, errors, banned: Array.from(found) };
    }

    function optionWithSelected(optionsHtml, value){
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `<select>${optionsHtml}</select>`;
      const select = wrapper.firstChild;
      Array.from(select.options).forEach(opt=>{
        if (opt.value === String(value)) opt.selected = true;
      });
      return select.innerHTML;
    }

    function prettyPart(p){
      const f = state.flavors.find(x=>x.id===p.id);
      if (!f) return `${p.id} ${p.percent}%`;
      return `${f.brand} ${f.name} ${p.percent}%`;
    }

    function canDelete(m){
      if (state.user.id && m.authorId && state.user.id === m.authorId) return true;
      if (state.adminToken) return true; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –Ω–æ —Å–µ—Ä–≤–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ç–æ–∫–µ–Ω
      return false;
    }

    function recommendThirdFlavor(){
      const ids = state.parts.filter(p=>p.id).map(p=>p.id);
      if (ids.length < 2) return '';
      const [a,b] = ids.slice(0,2).map(id=>state.flavors.find(f=>f.id===id)).filter(Boolean);
      if (!a || !b) return '';
      const scoreMap = {};
      const tagsA = new Set(a.tags||[]);
      const tagsB = new Set(b.tags||[]);
      const target = new Set([...tagsA, ...tagsB]);
      state.flavors.forEach(f=>{
        if (ids.includes(f.id)) return;
        const tags = new Set(f.tags||[]);
        let score = 0;
        tags.forEach(t=>{ if (target.has(t)) score += 2; });
        // simple complement: fresh pairs with citrus/berry; dessert pairs with fruit
        if ((tags.has('—Å–≤–µ–∂–∏–π') && (target.has('—Ü–∏—Ç—Ä—É—Å')||target.has('—è–≥–æ–¥–Ω—ã–π'))) ||
            (tags.has('–¥–µ—Å–µ—Ä—Ç–Ω—ã–π') && target.has('—Ñ—Ä—É–∫—Ç–æ–≤—ã–π'))) score += 1.5;
        // slight penalty if tags empty
        if (!tags.size) score -= 0.5;
        scoreMap[f.id] = score;
      });
      const best = Object.entries(scoreMap).sort((x,y)=>y[1]-x[1])[0];
      if (!best) return '';
      const cand = state.flavors.find(f=>f.id===best[0]);
      return cand ? `${cand.brand} ‚Äî ${cand.name}` : '';
    }

    function recommendByStrengthTaste(){
      const s = Number(state.strength10||0);
      const t = state.taste||'';
      if (!s || !t) return '';
      // very simple matrix; "base strong" vs "soft"
      let strongBase = Math.min(80, Math.max(30, Math.round(s*8))); // 1..10 -> 8..80
      let softBase = 100 - strongBase;
      // flavor tag tweaks
      if (t==='–¥–µ—Å–µ—Ä—Ç–Ω—ã–π' || t==='—Å–≤–µ–∂–∏–π') { softBase += 10; strongBase -= 10; }
      if (t==='–ø—Ä—è–Ω—ã–π') { strongBase += 10; softBase -= 10; }
      strongBase = Math.min(90, Math.max(20, strongBase));
      softBase = 100 - strongBase;
      return `—Å–∏–ª—å–Ω—ã–π —Ç–∞–±–∞–∫: ${strongBase}%, –º—è–≥–∫–∏–π: ${softBase}%`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // ---- Events (delegation) ----
    document.body.addEventListener('click', async (e)=>{
      const t = e.target;

      if (t.closest('.tab')) {
        const tab = t.closest('.tab').dataset.tab;
        state.activeTab = tab;
        render();
      }

      if (t.id === 'add-part') {
        state.parts.push({ id: state.flavors[0]?.id || '', percent: 0 });
        render();
      }

      if (t.dataset.role === 'part-del') {
        const i = Number(t.dataset.index);
        state.parts.splice(i,1);
        render();
      }

      if (t.dataset.role === 'part-up') {
        const i = Number(t.dataset.index);
        if (i>0){ const tmp = state.parts[i-1]; state.parts[i-1]=state.parts[i]; state.parts[i]=tmp; }
        render();
      }

      if (t.id === 'save') {
        const v = isMixValid(state.parts, state.title, state.notes, state.bannedWords);
        if (!v.ok) {
          alert('–ù–µ–ª—å–∑—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:\n- ' + v.errors.join('\n- '));
          return;
        }
        const payload = {
          title: state.title,
          notes: state.notes,
          parts: state.parts.map(p=>({ id: p.id, percent: Number(p.percent||0) })),
          author: state.user.name,
          authorId: state.user.id,
          taste: state.taste,
          strength10: state.strength10?Number(state.strength10):null
        };
        try{
          const r = await api('/api/mixes', { method:'POST', body: JSON.stringify(payload) });
          if (r.status===400) {
            const j = await r.json();
            if (j && j.error==='banned_words') {
              alert('–ù–µ–ª—å–∑—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: ' + (j.banned||[]).join(', '));
              return;
            }
          }
          if (!r.ok) { alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ('+r.status+')'); return; }
          const saved = await r.json();
          state.guestMixes.unshift(saved);
          state.activeTab = 'guest';
          // reset builder
          state.parts = [];
          state.title = '';
          state.notes = '';
          state.taste = null;
          state.strength10 = null;
          render();
        }catch(err){
          alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        }
      }

      if (t.dataset.role === 'like') {
        const id = t.dataset.id;
        try{
          const r = await api(`/api/mixes/${id}/like`, { method:'POST', headers: { 'X-User-Id': state.user.id } });
          if (!r.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–∞–π–∫ ('+r.status+')'); return; }
          const j = await r.json();
          const m = state.guestMixes.find(x=>x.id===id);
          if (m) {
            if (!Array.isArray(m.likedBy)) m.likedBy=[];
            const i = m.likedBy.indexOf(state.user.id);
            if (j.liked && i<0) m.likedBy.push(state.user.id);
            if (!j.liked && i>=0) m.likedBy.splice(i,1);
            m.likesCount = j.likes;
          }
          render();
        }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–∞–π–∫ (—Å–µ—Ç—å)'); }
      }

      if (t.dataset.role === 'delete') {
        const id = t.dataset.id;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–∏–∫—Å?')) return;
        const hdrs = {};
        if (state.user.id) hdrs['X-User-Id'] = state.user.id;
        if (state.adminToken) hdrs['X-Admin-Token'] = state.adminToken;
        try{
          const r = await api(`/api/mixes/${id}`, { method:'DELETE', headers: hdrs });
          if (!r.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å ('+r.status+')'); return; }
          state.guestMixes = state.guestMixes.filter(m=>m.id!==id);
          render();
        }catch(e){ alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); }
      }

      // Admin modal
      if (t.id === 'fab-banned'){ openModal(); }
      if (t.id === 'bw-close'){ closeModal(); }
      if (t.id === 'bw-refresh'){ await loadBannedWords(true); }
      if (t.id === 'bw-save'){
        const words = document.getElementById('bw-text').value.split('\n').map(s=>s.trim()).filter(Boolean);
        const token = document.getElementById('bw-token').value;
        try{
          const r = await api('/api/banned-words', { method:'POST', body: JSON.stringify({ words }), headers: { 'X-Admin-Token': token } });
          if (r.status===403){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π Admin Token'); return; }
          if (!r.ok){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ('+r.status+')'); return; }
          const j = await r.json();
          state.bannedWords = j.words || [];
          state.adminToken = token;
          localStorage.setItem('admin_token', token);
          alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        }catch(e){ alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); }
      }

      if (t.id === 'regen-id'){
        if (!confirm('–°–º–µ–Ω–∏—Ç—å –≤–∞—à –∞–Ω–æ–Ω–∏–º–Ω—ã–π ID? –≠—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –≤–ª–∞–¥–µ–Ω–∏–µ –º–∏–∫—Å–∞–º–∏.')) return;
        state.user.id = uid();
        localStorage.setItem('user_id', state.user.id);
        render();
      }
    });

    document.body.addEventListener('input', (e)=>{
      const t = e.target;
      if (t.id === 'title') state.title = t.value;
      if (t.id === 'notes') state.notes = t.value;
      if (t.id === 'strength10') state.strength10 = t.value ? Number(t.value) : null;
      if (t.id === 'taste') state.taste = t.value || null;
      if (t.dataset.role === 'part-percent') {
        const i = Number(t.dataset.index);
        state.parts[i].percent = Number(t.value||0);
      }
      if (t.dataset.role === 'part-id') {
        const i = Number(t.dataset.index);
        state.parts[i].id = t.value;
      }
      if (t.id === 'theme') {
        const theme = t.value;
        localStorage.setItem('theme', theme === 'light' ? 'light' : 'dark');
        applyTheme();
      }
      // live re-render for recommendations
      render();
    });

    // ---- Modal helpers ----
    function openModal(){
      document.getElementById('bw-token').value = state.adminToken || '';
      document.getElementById('bw-text').value = (state.bannedWords||[]).join('\n');
      document.getElementById('modal').style.display = 'flex';
    }
    function closeModal(){ document.getElementById('modal').style.display = 'none'; }

    // ---- Data loading ----
    async function loadAll(){
      await loadBannedWords(false);
      await loadFlavors();
      await loadMixes();
      render();
    }
    async function loadBannedWords(showAlert){
      try{
        const r = await api('/api/banned-words');
        const j = await r.json();
        state.bannedWords = j.words || [];
        if (showAlert) alert('–û–±–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ');
      }catch(e){ if (showAlert) alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å'); }
    }
    async function loadFlavors(){
      try {
        const r = await api('/api/flavors');
        state.flavors = await r.json();
      } catch(e){ state.flavors = []; }
    }
    async function loadMixes(){
      try {
        const r = await api('/api/mixes');
        state.guestMixes = await r.json();
      } catch(e){ state.guestMixes = []; }
    }

    function applyTheme(){
      const theme = localStorage.getItem('theme') || 'dark';
      document.body.classList.toggle('light', theme==='light');
    }

    // ---- Init ----
    applyTheme();
    document.querySelectorAll('.tab').forEach(el=>{
      el.classList.toggle('active', el.dataset.tab === state.activeTab);
    });
    loadAll();

  </script>
</body>
</html>
